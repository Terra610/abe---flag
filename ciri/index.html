<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIRI ‚Äì Constitutional Integrity ROI Engine | A.B.E.</title>

  <!-- Optional site patch; safe if missing -->
  <link rel="stylesheet" href="/abe---flag/abe-patch/assets/abe-patch.css"/>

  <style>
    :root{
      --bg:#0b0d12; --panel:#13161b; --ink:#e0e0e0; --muted:#9aa3ad;
      --edge:rgba(255,255,255,.08); --edge2:rgba(255,255,255,.12);
      --accent:#5ddfff; --accent2:#ffa559;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.65;margin:0}

    header{
      background:linear-gradient(90deg,#11151c,#1b1e25);
      border-bottom:1px solid var(--edge);
      padding:2rem 1rem;
      text-align:center;
      position:relative
    }
    .home-btn{
      position:absolute;left:1rem;top:1.2rem;
      background:var(--accent);color:#0b0d12;
      padding:.45rem .9rem;border-radius:8px;font-weight:700;text-decoration:none;font-size:.9rem;
      transition:all .2s ease-in-out;border:1px solid transparent
    }
    .home-btn:hover{background:#82eaff;box-shadow:0 0 8px rgba(93,223,255,.7);transform:translateY(-2px)}
    h1{color:var(--accent2);font-size:1.8rem;margin:.1rem 0 .4rem;font-weight:800}
    header p{margin:.25rem 0 0;color:var(--muted)}
    .top-actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin:.9rem 0 0}
    .btn,.badge{display:inline-block;text-decoration:none;font-weight:700;border-radius:8px;transition:all .18s ease-in-out}
    .btn{background:var(--accent);color:#0b0d12;padding:.55rem 1rem;border:1px solid transparent}
    .btn:hover{background:#82eaff;transform:translateY(-2px);box-shadow:0 0 10px rgba(93,223,255,.6)}
    .badge{color:var(--accent);border:1px solid var(--accent);padding:.45rem .7rem;font-size:.9rem}
    .badge:hover{background:rgba(93,223,255,.08);transform:translateY(-2px)}

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05)
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{background:rgba(255,255,255,.07);padding:.25rem .4rem;border-radius:6px;color:#e3e3e3}

    /* ===== CIRI live calculator styles ===== */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .ciri-kpi{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .ciri-grid>div{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
    .ciri-err{color:#f99}
    .ciri-controls{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .ciri-inline input{width:110px;background:#0d0f12;border:1px solid #2a3344;border-radius:6px;color:#eaeef7;padding:4px 6px}
    .ciri-slider{display:flex;gap:10px;align-items:center}
    .ciri-slider input[type="range"]{width:220px}
    canvas{max-width:100%}
    .btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the <em>economic impact of constitutional compliance</em>
      for their own city or county.
    </p>

    <ol>
      <li>Open <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Run the calculator from your command line:
        <pre><code>python3 ciri/calculate.py</code></pre>
      </li>
      <li>View your economic impact report directly in the console.</li>
      <li>Your reinvestment file is written to <code>/cibs/auto_budget.csv</code> ‚Äî that‚Äôs your community‚Äôs <strong>Recovery Pool</strong> ready for allocation.</li>
    </ol>

    <p class="ciri-small">
      The script operates locally ‚Äî no server or internet required. Outputs are evidence-ready for filings, budgets, and audits.
    </p>
  </section>

  <!-- ===== LIVE BROWSER CALCULATOR (reads ./inputs.csv) ===== -->
  <section>
    <h2>‚ö° Live CIRI Calculator (no download needed)</h2>
    <div id="ciri-app" class="ciri-box">
      <div><strong>Client-side computation</strong> ‚Äî reads <code>./inputs.csv</code>, computes Recovery, CIRI, and CII in your browser.</div>

      <div class="ciri-kpis">
        <div class="ciri-kpi"><div class="lbl">Total Recovery (USD)</div><div id="kpi-total" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CIRI ‚Ä¢ Constitutional Integrity Risk Index</div><div id="kpi-ciri" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CII ‚Ä¢ Constitutional Integrity Index</div><div id="kpi-cii" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">ROI per Case Avoided</div><div id="kpi-roi" class="val">‚Äî</div></div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions & Scenario Explorer</div>
          <div class="ciri-controls ciri-small">
            <label>Avg jail days avoided per case:
              <input id="assump-days" class="ciri-inline" type="number" step="0.1" min="0" value="5">
            </label>
            <label>Risk scaling (K, USD):
              <input id="assump-k" class="ciri-inline" type="number" step="1000000" min="1" value="1000000000">
            </label>
            <div class="ciri-slider">
              <label>Cases avoided</label>
              <input id="slider-cases" type="range" min="0" max="5000" step="50">
              <span id="lbl-cases">‚Äî</span>
            </div>
            <div class="ciri-slider">
              <label>Transport weight</label>
              <input id="slider-trans" type="range" min="0" max="1000" step="10">
              <span id="lbl-trans">‚Äî</span>
            </div>
            <button id="btn-reset" class="btn-ghost">Reset to CSV</button>
            <button id="recalc" class="btn-ghost">Recalculate</button>
          </div>
          <div class="ciri-small" style="margin-top:8px">
            <strong>CIRI</strong> = ( 1 ‚àí e<sup>‚àíTotal/K</sup> ) &nbsp; ‚Ä¢ &nbsp; <strong>CII</strong> = 1 ‚àí CIRI
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Scenario chart"></canvas>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== /LIVE BROWSER CALCULATOR ===== -->

  <section>
    <h2>About CIRI</h2>
    <p>
      The CIRI engine translates lawful governance into measurable economic outcomes. Each prevented
      constitutional violation reduces measurable fiscal waste. Proper implementation strengthens GDP,
      restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="https://github.com/Terra610/abe---flag/blob/main/ciri/calc.md" target="_blank" rel="noopener">View calculation documentation</a></li>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <section>
    <h2>Integration with CIBS</h2>
    <p>
      After running the calculator, CIRI will automatically seed a draft allocation file
      into <a href="/abe---flag/cibs/auto_budget.csv">CIBS</a>. That file defines how the
      <strong>Recovery Pool</strong> should be reinvested into community programs like housing,
      youth development, and legal defense.
    </p>
  </section>

</main>

<!-- Optional patch scripts -->
<script src="/abe---flag/abe-patch/assets/abe-nav.js"></script>
<script src="/abe---flag/abe-patch/assets/abe-definitions.js"></script>

<!-- ===== CIRI calculator script ===== -->
<script>
(async function(){
  // 1) Load ./inputs.csv (try relative first, then absolute fallback just in case)
  const CANDIDATES = ['./inputs.csv','/abe---flag/ciri/inputs.csv'];
  let csvText=null, src=null;
  for (const u of CANDIDATES){
    try { const r = await fetch(u,{cache:'no-store'}); if(r.ok){ csvText=await r.text(); src=u; break; } } catch(_){}
  }
  const status = document.getElementById('ciri-status');
  if(!csvText){ status.innerHTML='<span class="ciri-err">Could not load inputs.csv</span>'; return; }
  status.textContent = `Loaded inputs from ${src}`;

  // 2) Parse a one-row CSV into object
  function parseCSV(txt){
    const lines = txt.trim().split(/\r?\n/);
    const head = lines.shift().split(',').map(s=>s.trim());
    const row  = (lines[0]||'').split(',').map(s=>s.trim());
    const obj={}; head.forEach((h,i)=>obj[h]=row[i]); return {head,row,obj};
  }
  const parsed = parseCSV(csvText);

  // show inputs table
  const t = document.getElementById('ciri-inputs');
  t.innerHTML = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>' +
    parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??''}</td></tr>`).join('') +
    '</tbody>';

  // 3) Normalize column names (handles abbreviations from your CSV)
  const normMap = {
    cases_avoided:['cases_avoided','cases','cases_a'],
    avg_cost:['avg_cost','avg cos','avg_cost_per_case'],
    jail_day_cost:['jail_day_cost','jail_day','jail_day_c','jail_cost_per_day'],
    fees_calc:['fees_calc','fees','fees_cal','fees_cai'],
    licenses:['licenses','license_rev','licensing'],
    employment_rate:['employment_rate','employment','empl_rate'],
    months_employed:['months_employed','months','months_emp'],
    expected_wage:['expected_wage','expected','avg_pay','expected_income'],
    pay_multiplier:['pay_multiplier','multiplier','pay_mult'],
    transport_weight:['transport_weight','transport','tran','weight']
  };
  function normalize(obj){
    const lower={};
    Object.keys(obj).forEach(k=>{
      lower[k.toLowerCase().replace(/[^a-z0-9_]+/g,'')] = obj[k];
    });
    const out={};
    for(const key in normMap){
      const options = normMap[key];
      let found = null;
      for(const opt of options){
        const norm = opt.toLowerCase().replace(/[^a-z0-9_]+/g,'');
        if(norm in lower){ found = lower[norm]; break; }
      }
      out[key] = Number(found ?? 0);
    }
    return out;
  }
  const CSV = normalize(parsed.obj);       // original values (for reset)
  let X = {...CSV};                        // mutable working copy

  // 4) Core calculator
  function compute(V, A){
    const {cases_avoided, avg_cost, fees_calc, jail_day_cost, licenses,
           employment_rate, months_employed,
           expected_wage, pay_multiplier, transport_weight} = V;

    const direct_case = cases_avoided * (avg_cost + fees_calc);
    const detention   = cases_avoided * jail_day_cost * A.jailDays;
    const licensing   = licenses * transport_weight;

    const per_worker  = expected_wage * (months_employed/12) * employment_rate * pay_multiplier;
    const employment  = per_worker * cases_avoided;

    const total = direct_case + detention + licensing + employment;

    const ciri = 1 - Math.exp(- total / Math.max(1,A.K));
    const cii  = 1 - ciri;

    const roiPerCase = cases_avoided > 0 ? total / cases_avoided : 0;

    return { total, ciri, cii, roiPerCase, parts:{direct_case, detention, licensing, employment} };
  }

  // 5) Wire UI
  const daysEl = document.getElementById('assump-days');
  const kEl    = document.getElementById('assump-k');
  const kpiT   = document.getElementById('kpi-total');
  const kpiRI  = document.getElementById('kpi-ciri');
  const kpiFI  = document.getElementById('kpi-cii');
  const kpiROI = document.getElementById('kpi-roi');
  const brk    = document.getElementById('ciri-breakdown');

  const sCases = document.getElementById('slider-cases');
  const sTrans = document.getElementById('slider-trans');
  const lCases = document.getElementById('lbl-cases');
  const lTrans = document.getElementById('lbl-trans');
  const btnReset = document.getElementById('btn-reset');

  // init sliders from CSV
  sCases.value = X.cases_avoided || 0;  lCases.textContent = Number(sCases.value).toLocaleString();
  sTrans.value = X.transport_weight || 0; lTrans.textContent = Number(sTrans.value).toLocaleString();

  function fmtUSD(n){ return n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}); }
  function pct(x){ return (x*100).toFixed(1)+'%'; }

  const ctx = document.getElementById('ciri-chart').getContext('2d');
  function drawChart(value){
    const W = ctx.canvas.width, H = ctx.canvas.height;
    ctx.clearRect(0,0,W,H);
    const {direct_case, detention, licensing, employment} = value.parts;
    const vals = [direct_case, detention, licensing + employment];
    const max  = Math.max(...vals, 1);
    const bw = Math.floor(W/6), gap=bw; const base = H-10;
    for(let i=0;i<3;i++){
      const h = Math.round((vals[i]/max)*(H-20));
      ctx.fillStyle = '#e0e0e0';
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
    }
  }

  function recalc(){
    const A = { jailDays:Number(daysEl.value||0), K:Number(kEl.value||1) };
    const R = compute(X, A);
    kpiT.textContent   = fmtUSD(R.total);
    kpiRI.textContent  = pct(R.ciri);
    kpiFI.textContent  = pct(R.cii);
    kpiROI.textContent = fmtUSD(R.roiPerCase);
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${fmtUSD(R.parts.direct_case)}</strong></li>
        <li>Detention savings (avg ${A.jailDays} days @ ${fmtUSD(X.jail_day_cost)}/day): <strong>${fmtUSD(R.parts.detention)}</strong></li>
        <li>Licensing/regulatory correction (${fmtUSD(X.licenses)} √ó ${X.transport_weight}): <strong>${fmtUSD(R.parts.licensing)}</strong></li>
        <li>Employment & income restoration: <strong>${fmtUSD(R.parts.employment)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${fmtUSD(A.K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;
    drawChart(R);
  }

  document.getElementById('recalc').addEventListener('click', recalc);

  // Scenario sliders
  sCases.addEventListener('input', () => { X.cases_avoided = Number(sCases.value); lCases.textContent = Number(sCases.value).toLocaleString(); recalc(); });
  sTrans.addEventListener('input', () => { X.transport_weight = Number(sTrans.value); lTrans.textContent = Number(sTrans.value).toLocaleString(); recalc(); });
  btnReset.addEventListener('click', () => {
    X = {...CSV};
    sCases.value = X.cases_avoided||0; lCases.textContent = Number(sCases.value).toLocaleString();
    sTrans.value = X.transport_weight||0; lTrans.textContent = Number(sTrans.value).toLocaleString();
    document.getElementById('assump-days').value = 5;
    document.getElementById('assump-k').value = 1000000000;
    recalc();
  });

  recalc();

  // --- CSV Download button (report) ---
  const btn = document.createElement('button');
  btn.textContent = 'Download Report (CSV)';
  btn.className = 'btn-ghost';
  btn.style.marginTop = '10px';
  document.getElementById('ciri-breakdown').insertAdjacentElement('afterend', btn);

  btn.addEventListener('click', () => {
    const A = { jailDays:Number(document.getElementById('assump-days').value||0),
                K:Number(document.getElementById('assump-k').value||1) };
    const R = compute(X, A);

    const now = new Date().toISOString();
    const lines = [
      ['Generated', now],
      ['Source CSV', src],
      [],
      ['Metric','Value'],
      ['Total Recovery (USD)', R.total],
      ['CIRI (Risk Index)', R.ciri],
      ['CII (Integrity Index)', R.cii],
      ['ROI per Case Avoided', R.roiPerCase],
      ['Direct Case Savings', R.parts.direct_case],
      ['Detention Savings', R.parts.detention],
      ['Licensing Correction', R.parts.licensing],
      ['Employment Restoration', R.parts.employment],
      ['Assumed Jail Days', A.jailDays],
      ['Risk Scaling K', A.K],
      [],
      ['Input Field','CSV Value'],
      ...Object.entries(parsed.obj).map(([k,v]) => [k, v])
    ];

    const csv = lines.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'CIRI_report.csv'; a.click();
    URL.revokeObjectURL(url);
  });
})();
</script>
<!-- ===== /CIRI calculator script ===== -->
</body>
</html>
