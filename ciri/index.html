<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIRI ‚Äì Constitutional Integrity ROI Engine | A.B.E.</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#13161b; --ink:#e0e0e0; --muted:#9aa3ad;
      --edge:rgba(255,255,255,.08); --edge2:rgba(255,255,255,.12);
      --accent:#5ddfff; --accent2:#ffa559;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg);color:var(--ink);
      font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      line-height:1.65;margin:0;
    }

    header{
      background:linear-gradient(90deg,#11151c,#1b1e25);
      border-bottom:1px solid var(--edge);
      padding:2rem 1rem;
      text-align:center;
      position:relative;
    }
    .home-btn{
      position:absolute;left:1rem;top:1.2rem;
      background:var(--accent);color:#0b0d12;
      padding:.45rem .9rem;border-radius:8px;font-weight:700;text-decoration:none;font-size:.9rem;
      transition:all .2s ease-in-out;border:1px solid transparent;
    }
    .home-btn:hover{
      background:#82eaff;box-shadow:0 0 8px rgba(93,223,255,.7);
      transform:translateY(-2px);
    }
    h1{
      color:var(--accent2);font-size:1.8rem;
      margin:.1rem 0 .4rem;font-weight:800;
    }
    header p{margin:.25rem 0 0;color:var(--muted)}
    .top-actions{
      display:flex;gap:.6rem;flex-wrap:wrap;
      justify-content:center;margin:.9rem 0 0;
    }
    .btn,.badge{
      display:inline-block;text-decoration:none;font-weight:700;
      border-radius:8px;transition:all .18s ease-in-out;
    }
    .btn{
      background:var(--accent);color:#0b0d12;
      padding:.55rem 1rem;border:1px solid transparent;
    }
    .btn:hover{
      background:#82eaff;transform:translateY(-2px);
      box-shadow:0 0 10px rgba(93,223,255,.6);
    }
    .badge{
      color:var(--accent);border:1px solid var(--accent);
      padding:.45rem .7rem;font-size:.9rem;
    }
    .badge:hover{
      background:rgba(93,223,255,.08);transform:translateY(-2px);
    }

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05);
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{
      background:rgba(255,255,255,.07);padding:.25rem .4rem;
      border-radius:6px;color:#e3e3e3;
    }

    /* CIRI live calculator styles */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin:12px 0;
    }
    .ciri-kpi{
      background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px;
    }
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{
      display:grid;grid-template-columns:1fr 1fr;gap:16px;
    }
    .ciri-grid>div{
      background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px;
    }
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{
      padding:6px;border-bottom:1px solid #232a36;text-align:left;
    }
    .ciri-err{color:#f99}
    canvas{max-width:100%}
    .btn-ghost{
      padding:6px 10px;border:1px solid #2a3344;border-radius:6px;
      background:#0d0f12;color:#eaeef7;cursor:pointer;font-size:.85rem;
      display:inline-flex;align-items:center;gap:4px;
    }
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}

    /* Data health banner (validator) */
    #data-health{
      border:1px solid #2a3344;border-radius:10px;
      padding:10px;background:#0e1218;
      margin:-.4rem 0 1rem;font-size:.9rem;
    }
    #data-health.ok{border-color:#245b3c;background:#0f1713}
    #data-health.warn{border-color:#66501f;background:#17140b}
    #data-health.err{border-color:#6b2a2a;background:#170f10}

    /* Upload + source UI */
    .ciri-upload-row{
      margin-bottom:10px;
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
    }
    .ciri-file-label{
      display:inline-block;
      padding:6px 12px;
      border-radius:6px;
      border:1px solid #2a3344;
      background:#0d0f12;
      font-size:.85rem;
      cursor:pointer;
    }
    .ciri-file-label:hover{
      border-color:var(--accent);
      color:var(--accent);
    }
    #ciri-source-indicator{
      font-size:.85rem;color:#9fb0c9;
    }

    .ciri-drop-zone{
      border:2px dashed #2a3344;
      border-radius:10px;
      padding:20px;
      text-align:center;
      cursor:pointer;
      transition:background-color .2s,border-color .2s;
      margin-bottom:10px;
    }
    .ciri-drop-zone.dragover{
      border-color:var(--accent);
      background-color:rgba(93,223,255,.04);
    }
    .ciri-drop-content{display:flex;flex-direction:column;align-items:center;gap:6px}
    .ciri-ghost-icon{font-size:40px;opacity:.6}
    .ciri-drop-text small{opacity:.8}

    footer{
      margin:32px 0 24px;text-align:center;
      color:#8fa1b6;font-size:.85rem;
    }
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>
  <!-- Data health banner (validate_ciri.js writes here) -->
  <section id="data-health" aria-live="polite">
    Checking <code>inputs.csv</code>‚Ä¶
  </section>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the
      <em>economic impact of constitutional compliance</em> for their own city or county ‚Äî using a single CSV.
    </p>
    <ol>
      <li>Download the example sheet: <a href="./inputs.csv">inputs.csv</a>.</li>
      <li>Replace the example numbers with your local data (keep the header row the same).</li>
      <li>
        Either:
        <ul>
          <li>Commit your updated <code>inputs.csv</code> (for a permanent public model), or</li>
          <li>Use the upload zone below to run it locally without touching the repo.</li>
        </ul>
      </li>
    </ol>
    <p class="ciri-small">
      <strong>Privacy note:</strong> Upload mode runs entirely in your browser.
      A.B.E. does not see, store, or transmit your file. Your reports download directly to your device.
    </p>
  </section>

  <!-- LIVE CIRI CALCULATOR -->
  <section>
    <h2>‚ö° Live CIRI Calculator</h2>

    <!-- Upload + source + actions -->
    <div class="ciri-upload-row">
      <label for="ciri-file-input" class="ciri-file-label">Choose CSV file</label>
      <input type="file" id="ciri-file-input" accept=".csv,text/csv" style="display:none"/>

      <span id="ciri-source-indicator">
        Source: Using built-in <code>./inputs.csv</code>
      </span>
    </div>

    <div id="ciri-drop-zone" class="ciri-drop-zone">
      <div class="ciri-drop-content">
        <div class="ciri-ghost-icon">üìÑ</div>
        <div class="ciri-drop-text">
          Drop your county‚Äôs data here<br/>
          <small>‚Ä¶and watch the recovery number explode.</small>
        </div>
      </div>
    </div>

    <div class="ciri-upload-row">
      <button id="ciri-download-report-btn" class="btn-ghost" disabled>
        ‚¨áÔ∏è Download Your Custom Report (CSV)
      </button>
      <button id="ciri-download-pdf-btn" class="btn-ghost" disabled>
        üìÑ Generate PDF Receipt
      </button>
      <a class="btn-ghost" href="/abe---flag/cibs/index.html">
        üìä Open CIBS (Budget)
      </a>
    </div>

    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi">
          <div class="lbl">Total Recovery (USD)</div>
          <div id="kpi-total" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CIRI ‚Ä¢ Risk Index</div>
          <div id="kpi-ciri" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CII ‚Ä¢ Integrity Index</div>
          <div id="kpi-cii" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">ROI per Case Avoided</div>
          <div id="kpi-roi" class="val">‚Äî</div>
        </div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">
            Loading inputs from <code>./inputs.csv</code>‚Ä¶
          </div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">
            Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br/>
            (Tuned for national / large-state scale. Adjust in code for smaller jurisdictions.)
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
        </div>
      </div>
    </div>
  </section>
  <!-- /LIVE CIRI CALCULATOR -->

  <section>
    <h2>About CIRI</h2>
    <p>
      CIRI translates lawful governance into measurable economic outcomes.
      Each prevented violation reduces measurable fiscal waste.
      Proper implementation strengthens GDP, restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <!-- A.B.E. Nav Dock + Live KPIs -->
  <section id="abe-navdock" class="ciri-box" aria-label="A.B.E. Navigator">
    <h3 style="margin:0 0 10px;color:#5ddfff">A.B.E. Navigator ¬∑ Live Links</h3>
    <div style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Doctrines</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.8">
          <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">A.B.E. ¬∑ CRRA ¬∑ Rebuild Together (viewer)</a></li>
          <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
          <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Calculators & KPIs</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.9">
          <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Archive & License</div>
        <div class="ciri-small" style="line-height:1.7">
          DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
          License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
          Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- jsPDF for PDF receipts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous"></script>

<!-- CIRI calculator script (built-in + upload + receipts) -->
<script>
(function(){
  const K = 1_000_000_000; // risk scaling

  const ciriState = {
    source: 'built-in',           // 'built-in' | 'uploaded'
    originalCsvText: null,
    headers: null,
    inputRow: null,
    outputs: null,
  };

  function money(n){
    try{
      return n.toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0});
    }catch(_){
      return '$'+Math.round(n||0).toLocaleString('en-US');
    }
  }
  function pct(x){ return (x*100).toFixed(1)+'%'; }

  const REPO_CANDIDATES = ['./inputs.csv','/abe---flag/ciri/inputs.csv'];

  function parseCsvSimple(text){
    const lines = text.trim().split(/\r?\n/).filter(Boolean);
    if(lines.length < 2){
      return { headers: [], row: [], obj: {} };
    }
    const headers = lines[0].split(',').map(s=>s.trim());
    const row = lines[1].split(',').map(s=>s.trim());
    const obj = {};
    headers.forEach((h,i)=>{ obj[h] = row[i]; });
    return { headers, row, obj };
  }

  function computeCiriMetrics(inputs){
    const cases_avoided          = Number(inputs.cases_avoided || 0);
    const avg_cost_per_case      = Number(inputs.avg_cost_per_case || 0);
    const jail_days_avoided      = Number(inputs.jail_days_avoided || 0);
    const cost_per_jail_day      = Number(inputs.cost_per_jail_day || 0);
    const fees_canceled_total    = Number(inputs.fees_canceled_total || 0);
    const policy_corrections     = Number(inputs.policy_corrections || 0);              // future
    const avg_enforcement_cost_savings = Number(inputs.avg_enforcement_cost_savings || 0); // future
    const households_restored    = Number(inputs.households_restored || 0);
    const avg_monthly_market_spend = Number(inputs.avg_monthly_market_spend || 0);
    const months_effective       = Number(inputs.months_effective || 0);
    const employment_probability = Number(inputs.employment_probability || 0);
    const avg_monthly_wage       = Number(inputs.avg_monthly_wage || 0);
    const expected_lawsuits      = Number(inputs.expected_lawsuits || 0);
    const avg_payout             = Number(inputs.avg_payout || 0);
    const litigation_multiplier  = Number(inputs.litigation_multiplier || inputs.multiplier || 0);
    const transition_costs_one_time = Number(inputs.transition_costs_one_time || 0);

    const direct_case   = cases_avoided * avg_cost_per_case;
    const detention     = jail_days_avoided * cost_per_jail_day;
    const fees          = fees_canceled_total;
    const employment    = cases_avoided * avg_monthly_wage * employment_probability * (months_effective/12);
    const lawsuits_avoided = expected_lawsuits * avg_payout * litigation_multiplier;
    const licensing_val = 0; // placeholder
    const enforcement   = policy_corrections * avg_enforcement_cost_savings;
    const market_access = households_restored * avg_monthly_market_spend * months_effective;

    let total = direct_case
      + detention
      + fees
      + employment
      + lawsuits_avoided
      + licensing_val
      + enforcement
      + market_access
      - transition_costs_one_time;

    total = Math.max(0,total);

    const ciri_index = 1 - Math.exp(- total / K);
    const cii_index  = 1 - ciri_index;
    const roi_per_case = total / Math.max(1, cases_avoided);

    return {
      direct_case,
      detention,
      fees,
      employment,
      lawsuits_avoided,
      licensing_val,
      enforcement,
      market_access,
      transition_costs_one_time,
      total_recovery: total,
      ciri_index,
      cii_index,
      roi_per_case,
    };
  }

  function updateSourceIndicator(){
    const el = document.getElementById('ciri-source-indicator');
    if(!el) return;
    if(ciriState.source === 'uploaded'){
      el.innerHTML = 'Source: Your uploaded file <strong>(private ‚Äî processed only in this browser)</strong>';
    }else{
      el.innerHTML = 'Source: Using built-in <code>./inputs.csv</code>';
    }
  }

  function renderTable(headers,row){
    const tbl = document.getElementById('ciri-inputs');
    if(!tbl) return;
    if(!headers.length){
      tbl.innerHTML = '<tbody><tr><td>No data found</td></tr></tbody>';
      return;
    }
    let html = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
    headers.forEach((h,i)=>{
      html += `<tr><td>${h}</td><td>${row[i] ?? ''}</td></tr>`;
    });
    html += '</tbody>';
    tbl.innerHTML = html;
  }

  function drawBars(canvas, values){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width || canvas.offsetWidth || 400;
    const H = canvas.height || 120;
    const max = Math.max(...values.map(v => v.v), 1);
    ctx.clearRect(0,0,W,H);
    const n = values.length;
    const bw = Math.floor(W/(n*2));
    const gap = bw;
    const base = H - 12;
    values.forEach((item,i)=>{
      const h = Math.round((item.v/max)*(H-24));
      ctx.fillStyle = '#e0e0e0';
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
      ctx.font = '11px system-ui';
      ctx.fillText(item.k, 10 + i*(bw+gap), H-2);
    });
  }

  function updateCiriUiFromState(srcLabel){
    const status = document.getElementById('ciri-status');
    if(!ciriState.outputs || !ciriState.headers){
      if(status) status.textContent = 'No data loaded.';
      return;
    }

    if(status) status.textContent = `Loaded from ${srcLabel}`;

    const o = ciriState.outputs;

    // KPIs
    const totalEl = document.getElementById('kpi-total');
    const ciriEl  = document.getElementById('kpi-ciri');
    const ciiEl   = document.getElementById('kpi-cii');
    const roiEl   = document.getElementById('kpi-roi');

    if(totalEl) totalEl.textContent = money(o.total_recovery);
    if(ciriEl)  ciriEl.textContent  = pct(o.ciri_index);
    if(ciiEl)   ciiEl.textContent   = pct(o.cii_index);
    if(roiEl)   roiEl.textContent   = money(o.roi_per_case);

    renderTable(ciriState.headers, ciriState.inputRowRaw || []);

    const brk = document.getElementById('ciri-breakdown');
    if(brk){
      brk.innerHTML = `
        <div><strong>Breakdown</strong></div>
        <ul>
          <li>Direct case savings: <strong>${money(o.direct_case)}</strong></li>
          <li>Detention savings: <strong>${money(o.detention)}</strong></li>
          <li>Fees canceled: <strong>${money(o.fees)}</strong></li>
          <li>Employment & income restoration: <strong>${money(o.employment)}</strong></li>
          <li>Lawsuits avoided: <strong>${money(o.lawsuits_avoided)}</strong></li>
          <li>Transition costs (one-time): <strong>‚àí${money(o.transition_costs_one_time)}</strong></li>
        </ul>
        <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
      `;
    }

    const bars = [
      {k:'Case', v:o.direct_case},
      {k:'Det.', v:o.detention},
      {k:'Fees', v:o.fees},
      {k:'Emp.', v:o.employment},
      {k:'Law.', v:o.lawsuits_avoided},
    ];
    drawBars(document.getElementById('ciri-chart'), bars);

    // Nav dock CIRI total
    const dockCiri = document.getElementById('dock-ciri-total');
    if(dockCiri) dockCiri.textContent = money(o.total_recovery);

    // Enable buttons
    const csvBtn = document.getElementById('ciri-download-report-btn');
    const pdfBtn = document.getElementById('ciri-download-pdf-btn');
    if(csvBtn) csvBtn.disabled = false;
    if(pdfBtn) pdfBtn.disabled = false;
  }

  function runCiriFromCsvText(csvText, sourceType, srcLabel){
    const parsed = parseCsvSimple(csvText);
    const outputs = computeCiriMetrics(parsed.obj);

    ciriState.source          = sourceType;
    ciriState.originalCsvText = csvText;
    ciriState.headers         = parsed.headers;
    ciriState.inputRow        = parsed.obj;
    ciriState.inputRowRaw     = parsed.row;
    ciriState.outputs         = outputs;

    updateSourceIndicator();
    updateCiriUiFromState(srcLabel);
  }

  async function loadBuiltInCsv(){
    const status = document.getElementById('ciri-status');
    if(status) status.textContent = 'Loading inputs.csv from repo‚Ä¶';
    for(const url of REPO_CANDIDATES){
      try{
        const res = await fetch(url,{cache:'no-store'});
        if(res.ok){
          const text = await res.text();
          runCiriFromCsvText(text,'built-in',url);
          return;
        }
      }catch(_){}
    }
    if(status) status.innerHTML = '<span class="ciri-err">Could not load inputs.csv</span>';
  }

  async function loadCibsTotal(){
    try{
      const res = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
      if(!res.ok) return;
      const text = await res.text();
      const lines = text.trim().split(/\r?\n/);
      if(lines.length < 2) return;
      const [h,...rows] = lines;
      const keys = h.split(',').map(s=>s.trim());
      const sum = rows.reduce((acc,line)=>{
        const vals = line.split(',');
        const obj = {};
        keys.forEach((k,i)=> obj[k] = i===0 ? vals[i] : Number(vals[i]));
        const v = Number(obj.value || obj.Value || vals[1] || 0);
        return acc + (isFinite(v)? v : 0);
      },0);
      const elDockCibs = document.getElementById('dock-cibs-total');
      if(elDockCibs) elDockCibs.textContent = money(sum);
    }catch(_){
      const elDockCibs = document.getElementById('dock-cibs-total');
      if(elDockCibs) elDockCibs.textContent = '‚Äî';
    }
  }

  function setupUploadUi(){
    const fileInput = document.getElementById('ciri-file-input');
    const dropZone  = document.getElementById('ciri-drop-zone');
    const fileLabel = document.querySelector('label[for="ciri-file-input"]');

    function handleCsvText(text, label){
      // If validator helpers exist, we can sanity check the uploaded text
      if(window.CIRIValidation && typeof window.CIRIValidation.validateText === 'function'){
        window.CIRIValidation.validateText(text).then(result=>{
          if(result.status === 'err'){
            alert(result.message);
            return;
          }
          if(result.status === 'warn'){
            console.warn(result.message);
          }
          runCiriFromCsvText(text,'uploaded',label);
        }).catch(err=>{
          console.error(err);
          runCiriFromCsvText(text,'uploaded',label);
        });
      }else{
        runCiriFromCsvText(text,'uploaded',label);
      }
    }

    function handleFile(file){
      if(!file) return;
      const status = document.getElementById('ciri-status');
      if(status) status.textContent = 'Reading uploaded CSV‚Ä¶';
      const reader = new FileReader();
      reader.onload = e=>{
        const text = e.target.result;
        handleCsvText(text, `uploaded CSV (${file.name})`);
      };
      reader.readAsText(file);
    }

    if(fileLabel && fileInput){
      fileLabel.addEventListener('click', ()=>fileInput.click());
    }
    if(fileInput){
      fileInput.addEventListener('change', e=>{
        const file = e.target.files[0];
        if(file) handleFile(file);
      });
    }
    if(dropZone){
      ['dragenter','dragover'].forEach(ev=>{
        dropZone.addEventListener(ev, (e)=>{
          e.preventDefault(); e.stopPropagation();
          dropZone.classList.add('dragover');
        });
      });
      ['dragleave','drop'].forEach(ev=>{
        dropZone.addEventListener(ev, (e)=>{
          e.preventDefault(); e.stopPropagation();
          dropZone.classList.remove('dragover');
        });
      });
      dropZone.addEventListener('drop', (e)=>{
        const dt = e.dataTransfer;
        if(dt && dt.files && dt.files.length){
          handleFile(dt.files[0]);
        }
      });
      dropZone.addEventListener('click', ()=>{
        if(fileInput) fileInput.click();
      });
    }

    updateSourceIndicator();
  }

  function buildCiriReceiptCsv(){
    if(!ciriState.inputRow || !ciriState.outputs){
      throw new Error('No CIRI run available.');
    }
    const timestamp = new Date().toISOString();
    const inputs = ciriState.inputRow;
    const o = ciriState.outputs;

    const originalHeaders = ciriState.headers || Object.keys(inputs);
    const computedHeaders = [
      'direct_case',
      'detention_savings',
      'fees_savings',
      'employment_gain',
      'lawsuits_avoided_value',
      'licensing_val',
      'enforcement_savings',
      'market_access',
      'transition_costs_one_time',
      'total_recovery',
      'ciri_index',
      'cii_index',
      'roi_per_case',
      'receipt_timestamp',
    ];

    const allHeaders = originalHeaders.concat(computedHeaders);

    const originalValues = originalHeaders.map(h => inputs[h] ?? '');
    const computedValues = [
      o.direct_case,
      o.detention,
      o.fees,
      o.employment,
      o.lawsuits_avoided,
      o.licensing_val,
      o.enforcement,
      o.market_access,
      o.transition_costs_one_time,
      o.total_recovery,
      o.ciri_index,
      o.cii_index,
      o.roi_per_case,
      timestamp,
    ].map(v => (typeof v === 'number' ? String(v) : (v ?? '')));

    const headerLine = allHeaders.join(',');
    const valueLine  = originalValues.concat(computedValues).join(',');

    const metaLine = '# A.B.E. Certified Recovery Receipt | Generated: ' + timestamp;

    return [metaLine, headerLine, valueLine].join('\n');
  }

  function downloadTextFile(filename, text, mimeType){
    const blob = new Blob([text],{type:mimeType || 'text/plain'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function downloadCiriPdfReceipt(){
    if(!ciriState.outputs){
      throw new Error('No CIRI run available.');
    }
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){
      alert('PDF generator not available.');
      return;
    }
    const doc = new jsPDF();
    const timestamp = new Date().toISOString();
    const o = ciriState.outputs;

    doc.setFontSize(14);
    doc.text('A.B.E. Certified Recovery Receipt', 10, 20);
    doc.setFontSize(10);
    doc.text('Generated: ' + timestamp, 10, 27);
    doc.text('This report is generated locally in your browser. A.B.E. does not receive or store your data.', 10, 33, {maxWidth: 190});

    let y = 45;
    doc.setFontSize(12);
    doc.text('Key Metrics', 10, y);
    y += 6;
    doc.setFontSize(10);

    const lines = [
      ['Total Recovery',            o.total_recovery,      'currency'],
      ['CIRI Index',                o.ciri_index,          'number'],
      ['CII Index',                 o.cii_index,           'number'],
      ['ROI per Case Avoided',      o.roi_per_case,        'currency'],
      ['Direct Case Savings',       o.direct_case,         'currency'],
      ['Detention Savings',         o.detention,           'currency'],
      ['Fees Canceled',             o.fees,                'currency'],
      ['Employment Gain',           o.employment,          'currency'],
      ['Lawsuits Avoided (Value)',  o.lawsuits_avoided,    'currency'],
      ['Transition Costs (One-time)',o.transition_costs_one_time,'currency'],
    ];

    const fmtCurrency = v => money(v);
    const fmtNumber   = v => Number(v).toLocaleString('en-US',{maximumFractionDigits:3});

    lines.forEach(([label,value,type])=>{
      let display = type === 'currency' ? fmtCurrency(value) : fmtNumber(value);
      doc.text(`${label}: ${display}`, 10, y);
      y += 5;
      if(y > 270){
        doc.addPage();
        y = 20;
      }
    });

    y += 6;
    if(y > 270){
      doc.addPage();
      y = 20;
    }
    doc.setFontSize(10);
    doc.text(
      'Interpretation: Higher CIRI index and total recovery indicate stronger constitutional alignment and reduced fiscal and human waste.',
      10,
      y,
      {maxWidth: 190}
    );

    doc.save('CIRI_Recovery_Receipt.pdf');
  }

  function setupDownloadButtons(){
    const csvBtn = document.getElementById('ciri-download-report-btn');
    const pdfBtn = document.getElementById('ciri-download-pdf-btn');

    if(csvBtn){
      csvBtn.addEventListener('click', ()=>{
        try{
          const csv = buildCiriReceiptCsv();
          downloadTextFile('CIRI_Recovery_Receipt.csv', csv, 'text/csv');
        }catch(err){
          console.error(err);
          alert('No CIRI run available yet. Load inputs or upload a CSV first.');
        }
      });
    }
    if(pdfBtn){
      pdfBtn.addEventListener('click', ()=>{
        downloadCiriPdfReceipt().catch(err=>{
          console.error(err);
          alert('There was a problem generating the PDF receipt.');
        });
      });
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    setupUploadUi();
    setupDownloadButtons();
    loadBuiltInCsv();
    loadCibsTotal();
  });
})();
</script>

<!-- validator (drives #data-health, exposes CIRIValidation helpers) -->
<script src="./validate_ciri.js"></script>

<footer>
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br/>
  Licensed under
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br/>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>

</body>
</html>    .badge:hover{background:rgba(93,223,255,.08);transform:translateY(-2px)}

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05);
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{background:rgba(255,255,255,.07);padding:.25rem .4rem;border-radius:6px;color:#e3e3e3}

    /* CIRI live calculator styles */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .ciri-kpi{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .ciri-grid>div{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
    .ciri-err{color:#f99}
    canvas{max-width:100%}
    .btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer;font-size:.85rem}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}

    /* Data health banner */
    #data-health{
      border:1px solid #2a3344;border-radius:10px;padding:10px;
      background:#0e1218;margin:-.4rem 0 1rem;font-size:.9rem;
    }
    #data-health.ok{border-color:#245b3c;background:#0f1713}
    #data-health.warn{border-color:#66501f;background:#17140b}
    #data-health.err{border-color:#6b2a2a;background:#170f10}

    .mode-toggle{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;font-size:.9rem}
    .mode-toggle label{display:flex;align-items:center;gap:4px;cursor:pointer}
    #upload-row{margin-top:8px}
  </style>
</head>
<body>
<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>
  <!-- Data health banner (validator writes here) -->
  <section id="data-health" aria-live="polite">
    Checking <code>inputs.csv</code>‚Ä¶
  </section>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the <em>economic impact of constitutional compliance</em>
      for their own city or county ‚Äî using a single CSV.
    </p>
    <ol>
      <li>Download the template: <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Optional CLI run (writes CIBS budget):<br><code>python3 ciri/calculate.py</code></li>
      <li>Either keep your CSV in the repo (for public runs) or upload it privately below.</li>
    </ol>
    <p class="ciri-small">
      Browser math and CLI math are aligned. No server required. Upload mode never saves or uploads your file ‚Äî all computation is local in your browser.
    </p>
  </section>

  <!-- LIVE CIRI CALCULATOR -->
  <section>
    <h2>‚ö° Live CIRI Calculator</h2>
    <div class="ciri-box" id="ciri-app">
      <div class="mode-toggle">
        <label>
          <input type="radio" name="mode" value="repo" checked>
          Use example from repo (<code>./inputs.csv</code>)
        </label>
        <label>
          <input type="radio" name="mode" value="upload">
          Upload my own CSV (local only)
        </label>
      </div>
      <div id="upload-row" style="display:none">
        <input type="file" id="file-input" accept=".csv" class="btn-ghost">
        <span class="ciri-small">CSV must have the standard CIRI headers (cases_avoided, avg_cost_per_case, ‚Ä¶).</span>
      </div>

      <div class="ciri-kpis">
        <div class="ciri-kpi">
          <div class="lbl">Total Recovery (USD)</div>
          <div id="kpi-total" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CIRI ‚Ä¢ Risk Index</div>
          <div id="kpi-ciri" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CII ‚Ä¢ Integrity Index</div>
          <div id="kpi-cii" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">ROI per Case Avoided</div>
          <div id="kpi-roi" class="val">‚Äî</div>
        </div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">
            Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>
            (Tuned for national / large-state scale. Adjust in code for smaller jurisdictions.)
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- /LIVE CALCULATOR -->

  <section>
    <h2>About CIRI</h2>
    <p>
      CIRI translates lawful governance into measurable economic outcomes. Each prevented violation reduces
      measurable fiscal waste. Proper implementation strengthens GDP, restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <!-- A.B.E. Nav Dock + Live KPIs -->
  <section id="abe-navdock" class="ciri-box" aria-label="A.B.E. Navigator">
    <h3 style="margin:0 0 10px;color:#5ddfff">A.B.E. Navigator ¬∑ Live Links</h3>
    <div style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Doctrines</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.8">
          <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">A.B.E. ¬∑ CRRA ¬∑ Rebuild Together (viewer)</a></li>
          <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
          <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Calculators & KPIs</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.9">
          <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Archive & License</div>
        <div class="ciri-small" style="line-height:1.7">
          DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
          License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
          Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- CIRI calculator script -->
<script>
(function(){
  const K = 1_000_000_000;

  function money(n){
    try{
      return n.toLocaleString(undefined,{
        style:"currency",currency:"USD",maximumFractionDigits:0
      });
    }catch(_){
      return "$"+Math.round(n).toLocaleString();
    }
  }
  function pct(x){ return (x*100).toFixed(1)+"%"; }

  const REPO_CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];

  function parseCSV(text){
    const lines = text.trim().split(/\\r?\\n/).filter(Boolean);
    if(!lines.length) return {head:[], row:[], obj:{}};
    const head = lines[0].split(",").map(s=>s.trim());
    // Use the FIRST data row for now
    const row  = (lines[1] || "").split(",").map(s=>s.trim());
    const obj = {};
    head.forEach((h,i)=>{ obj[h] = row[i]; });
    return {head,row,obj};
  }

  function num(x){
    const n = Number(String(x||"").replace(/[^0-9.\\-]/g,""));
    return isFinite(n)? n : 0;
  }

  function compute(d){
    // Expecting the standard CIRI fields
    const cases_avoided          = num(d.cases_avoided);
    const avg_cost_per_case      = num(d.avg_cost_per_case);
    const jail_days_avoided      = num(d.jail_days_avoided);
    const cost_per_jail_day      = num(d.cost_per_jail_day);
    const fees_canceled_total    = num(d.fees_canceled_total);
    const policy_corrections     = num(d.policy_corrections);
    const avg_enforcement_cost_savings = num(d.avg_enforcement_cost_savings);
    const households_restored    = num(d.households_restored);
    const avg_monthly_market_spend = num(d.avg_monthly_market_spend);
    const months_effective       = num(d.months_effective);
    const employment_probability = num(d.employment_probability);
    const avg_monthly_wage       = num(d.avg_monthly_wage);
    const expected_lawsuits      = num(d.expected_lawsuits);
    const avg_payout             = num(d.avg_payout);
    const litigation_multiplier  = num(d.litigation_multiplier || d.multiplier);
    const transition_costs       = num(d.transition_costs_one_time);

    const direct_case   = cases_avoided * avg_cost_per_case;
    const detention     = jail_days_avoided * cost_per_jail_day;
    const fees          = fees_canceled_total;
    const enforcement   = policy_corrections * avg_enforcement_cost_savings;
    const market_access = households_restored * avg_monthly_market_spend * months_effective;
    const employment    = cases_avoided * employment_probability * avg_monthly_wage * (months_effective/12);
    const litigation    = expected_lawsuits * avg_payout * litigation_multiplier;

    let total = direct_case + detention + fees + enforcement + market_access + employment + litigation - transition_costs;
    total = Math.max(0, total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi_per_case = cases_avoided>0 ? total / cases_avoided : 0;

    return {
      total, ciri, cii, roi_per_case,
      parts:{direct_case,detention,fees,enforcement,market_access,employment,litigation,transition_costs}
    };
  }

  function drawBars(canvas, values){
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const max = Math.max(...values.map(v=>v.v), 1);
    ctx.clearRect(0,0,W,H);
    const n = values.length, bw = Math.floor(W/(n*2)), gap = bw;
    const base = H - 12;
    values.forEach((item,i)=>{
      const h = Math.round((item.v/max)*(H-24));
      ctx.fillStyle = "#e0e0e0";
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
      ctx.font = "11px system-ui";
      ctx.fillText(item.k, 10 + i*(bw+gap), H-2);
    });
  }

  function renderTable(head,row){
    const tbl = document.getElementById("ciri-inputs");
    if(!head.length){
      tbl.innerHTML = "<tbody><tr><td>No data</td></tr></tbody>";
      return;
    }
    let html = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>';
    head.forEach((h,i)=>{
      html += `<tr><td>${h}</td><td>${row[i] ?? ""}</td></tr>`;
    });
    html += "</tbody>";
    tbl.innerHTML = html;
  }

  async function loadRepoCSV(){
    for(const url of REPO_CANDIDATES){
      try{
        const res = await fetch(url,{cache:"no-store"});
        if(res.ok){
          const text = await res.text();
          return {text, src:url};
        }
      }catch(_){}
    }
    return {text:null, src:null};
  }

  async function loadCibsTotal(){
    try{
      const res = await fetch("/abe---flag/cibs/auto_budget.csv",{cache:"no-store"});
      if(!res.ok) return null;
      const text = await res.text();
      const lines = text.trim().split(/\\r?\\n/);
      if(lines.length<2) return 0;
      const rows = lines.slice(1);
      let sum = 0;
      rows.forEach(line=>{
        const cells = line.split(",");
        const v = Number(cells[1]);
        if(isFinite(v)) sum += v;
      });
      return sum;
    }catch(_){
      return null;
    }
  }

  function applyResults(parsed, result, srcLabel){
    const status = document.getElementById("ciri-status");
    if(!parsed.head.length){
      status.innerHTML = '<span class="ciri-err">No data found in CSV</span>';
      return;
    }
    status.textContent = "Loaded from " + srcLabel;

    renderTable(parsed.head, parsed.row);

    document.getElementById("kpi-total").textContent = money(result.total);
    document.getElementById("kpi-ciri").textContent  = pct(result.ciri);
    document.getElementById("kpi-cii").textContent   = pct(result.cii);
    document.getElementById("kpi-roi").textContent   = money(result.roi_per_case);

    const brk = document.getElementById("ciri-breakdown");
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(result.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(result.parts.detention)}</strong></li>
        <li>Fees canceled: <strong>${money(result.parts.fees)}</strong></li>
        <li>Enforcement savings: <strong>${money(result.parts.enforcement)}</strong></li>
        <li>Market access (household spend): <strong>${money(result.parts.market_access)}</strong></li>
        <li>Employment & income restoration: <strong>${money(result.parts.employment)}</strong></li>
        <li>Lawsuits avoided: <strong>${money(result.parts.litigation)}</strong></li>
        <li>Transition costs (one-time): <strong>‚àí${money(result.parts.transition_costs)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;

    const bars = [
      {k:"Case", v:result.parts.direct_case},
      {k:"Det.", v:result.parts.detention},
      {k:"Fees", v:result.parts.fees},
      {k:"Enf.",  v:result.parts.enforcement},
      {k:"Mkt.", v:result.parts.market_access},
      {k:"Emp.", v:result.parts.employment},
      {k:"Law.", v:result.parts.litigation}
    ];
    drawBars(document.getElementById("ciri-chart"), bars);

    const dockCiri = document.getElementById("dock-ciri-total");
    if(dockCiri) dockCiri.textContent = money(result.total);

    // Download report wiring
    const btn = document.getElementById("btn-download");
    btn.onclick = ()=>{
      const now = new Date().toISOString();
      const lines = [
        ["Generated", now],
        ["Source", srcLabel],
        [],
        ["Metric","Value"],
        ["Total Recovery (USD)", result.total],
        ["CIRI (Risk Index)", result.ciri],
        ["CII (Integrity Index)", result.cii],
        ["ROI per Case Avoided", result.roi_per_case],
        ["Direct Case Savings", result.parts.direct_case],
        ["Detention Savings", result.parts.detention],
        ["Fees Canceled", result.parts.fees],
        ["Enforcement Savings", result.parts.enforcement],
        ["Market Access", result.parts.market_access],
        ["Employment Restoration", result.parts.employment],
        ["Lawsuits Avoided", result.parts.litigation],
        ["Transition Costs", result.parts.transition_costs],
        [],
        ["Input Field","CSV Value"],
        ...Object.entries(parsed.obj).map(([k,v])=>[k,v])
      ];
      const csv = lines.map(r=>r.join(",")).join("\\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url  = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "CIRI_report.csv";
      a.click();
      URL.revokeObjectURL(url);
    };
  }

  async function init(){
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const uploadRow  = document.getElementById("upload-row");
    const fileInput  = document.getElementById("file-input");
    const dockCibsEl = document.getElementById("dock-cibs-total");

    // Load CIBS total once (from repo)
    const cibsTotal = await loadCibsTotal();
    if(dockCibsEl) dockCibsEl.textContent = cibsTotal==null ? "‚Äî" : money(cibsTotal);

    async function runRepo(){
      const status = document.getElementById("ciri-status");
      status.textContent = "Loading from repo‚Ä¶";
      const {text, src} = await loadRepoCSV();
      if(!text){
        status.innerHTML = '<span class="ciri-err">Could not load inputs.csv from repo</span>';
        return;
      }
      const parsed = parseCSV(text);
      const result = compute(parsed.obj);
      applyResults(parsed, result, src || "repo inputs.csv");
    }

    async function runUpload(file){
      const status = document.getElementById("ciri-status");
      if(!file){
        status.innerHTML = '<span class="ciri-err">No file selected</span>';
        return;
      }
      status.textContent = "Reading uploaded CSV‚Ä¶";
      const text = await file.text();
      const parsed = parseCSV(text);
      const result = compute(parsed.obj);
      applyResults(parsed, result, "uploaded CSV ("+file.name+")");
    }

    // Default: repo mode
    await runRepo();

    modeRadios.forEach(r=>{
      r.addEventListener("change", async e=>{
        if(e.target.value === "upload"){
          uploadRow.style.display = "block";
          document.getElementById("ciri-status").textContent = "Upload a CSV to recalculate.";
        }else{
          uploadRow.style.display = "none";
          fileInput.value = "";
          await runRepo();
        }
      });
    });

    fileInput.addEventListener("change", async e=>{
      const file = e.target.files[0];
      if(file) await runUpload(file);
    });
  }

  init();
})();
</script>

<!-- optional validator (if present) -->
<script src="./validate_ciri.js"></script>

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under 
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>
</body>
</html>    }
    h1{
      color:var(--accent2);font-size:1.8rem;
      margin:.1rem 0 .4rem;font-weight:800;
    }
    header p{margin:.25rem 0 0;color:var(--muted)}
    .top-actions{
      display:flex;gap:.6rem;flex-wrap:wrap;
      justify-content:center;margin:.9rem 0 0;
    }
    .btn,.badge{
      display:inline-block;text-decoration:none;font-weight:700;
      border-radius:8px;transition:all .18s ease-in-out;
    }
    .btn{
      background:var(--accent);color:#0b0d12;
      padding:.55rem 1rem;border:1px solid transparent;
    }
    .btn:hover{
      background:#82eaff;transform:translateY(-2px);
      box-shadow:0 0 10px rgba(93,223,255,.6);
    }
    .badge{
      color:var(--accent);border:1px solid var(--accent);
      padding:.45rem .7rem;font-size:.9rem;
    }
    .badge:hover{
      background:rgba(93,223,255,.08);transform:translateY(-2px);
    }

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);
      border:1px solid var(--edge);
      border-radius:12px;
      padding:1.2rem 1.4rem;
      margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05);
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{
      background:rgba(255,255,255,.07);
      padding:.25rem .4rem;border-radius:6px;color:#e3e3e3;
    }

    /* CIRI live calculator styles */
    .ciri-box{
      background:#111;border:1px solid #222;
      border-radius:10px;padding:16px;margin:20px 0;
    }
    .ciri-kpis{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;margin:12px 0;
    }
    .ciri-kpi{
      background:#151922;border:1px solid #232a36;
      border-radius:10px;padding:12px;
    }
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{
      display:grid;grid-template-columns:1fr 1fr;gap:16px;
    }
    .ciri-grid>div{
      background:#151922;border:1px solid #232a36;
      border-radius:10px;padding:12px;
    }
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{
      padding:6px;border-bottom:1px solid #232a36;text-align:left;
    }
    .ciri-err{color:#f99}
    canvas{max-width:100%}
    .btn-ghost{
      padding:6px 10px;border:1px solid #2a3344;border-radius:6px;
      background:#0d0f12;color:#eaeef7;cursor:pointer;
    }
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}

    /* Data health banner from validator */
    #data-health{
      border:1px solid #2a3344;border-radius:10px;
      padding:10px;background:#0e1218;
      margin:-.4rem 0 1rem;font-size:.9rem;
    }
    #data-health.ok{border-color:#245b3c;background:#0f1713}
    #data-health.warn{border-color:#66501f;background:#17140b}
    #data-health.err{border-color:#6b2a2a;background:#170f10}

    footer{
      margin:32px 0 24px;text-align:center;
      color:#8fa1b6;font-size:.85rem;
    }
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>
  <!-- Data health banner (driven by validate_ciri.js) -->
  <section id="data-health" aria-live="polite">
    Checking inputs.csv‚Ä¶
  </section>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the
      <em>economic impact of constitutional compliance</em>
      for their own city or county ‚Äî using a single CSV.
    </p>
    <ol>
      <li>Open <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Optional CLI run (writes CIBS budget):<br><code>python3 ciri/calculate.py</code></li>
      <li>View results below and/or in CIBS after running the CLI.</li>
    </ol>
    <p class="ciri-small">
      Browser math and CLI math are aligned. No server required.
    </p>
  </section>

  <!-- Live calculator -->
  <section>
    <h2>‚ö° Live CIRI Calculator (reads <code>./inputs.csv</code>)</h2>
    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi">
          <div class="lbl">Total Recovery (USD)</div>
          <div id="kpi-total" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CIRI ‚Ä¢ Risk Index</div>
          <div id="kpi-ciri" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CII ‚Ä¢ Integrity Index</div>
          <div id="kpi-cii" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">ROI per Case Avoided</div>
          <div id="kpi-roi" class="val">‚Äî</div>
        </div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">
            Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>
            (Matches CLI; adjust in code if your jurisdiction scale is different.)
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <button id="btn-export-runs" class="btn-ghost">Export My CIRI Runs (JSON)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- About -->
  <section>
    <h2>About CIRI</h2>
    <p>
      CIRI translates lawful governance into measurable economic outcomes. Each prevented violation reduces
      measurable fiscal waste. Proper implementation strengthens GDP, restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <!-- A.B.E. Nav Dock + KPIs -->
  <section id="abe-navdock" class="ciri-box" aria-label="A.B.E. Navigator">
    <h3 style="margin:0 0 10px;color:#5ddfff">A.B.E. Navigator ¬∑ Live Links</h3>
    <div style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Doctrines</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.8">
          <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">A.B.E. ¬∑ CRRA ¬∑ Rebuild Together (viewer)</a></li>
          <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
          <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Calculators & KPIs</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.9">
          <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Archive & License</div>
        <div class="ciri-small" style="line-height:1.7">
          DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
          License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
          Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- CIRI calculator script -->
<script>
(function(){
  const K = 1_000_000_000;

  function money(n){
    try{
      return n.toLocaleString(undefined,{
        style:"currency",currency:"USD",maximumFractionDigits:0
      });
    }catch(_){
      return "$"+Math.round(n).toLocaleString();
    }
  }
  function pct(x){ return (x*100).toFixed(1)+"%"; }

  const CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];
  let csvText = null, src = null;

  function parseCSV(txt){
    const lines = txt.trim().split(/\r?\n/).filter(Boolean);
    const head  = (lines.shift()||"").split(",").map(s=>s.trim());
    const row   = (lines.shift()||"").split(",").map(s=>s.trim());
    const obj   = {};
    head.forEach((h,i)=> obj[h]=row[i]);
    return {head,row,obj};
  }

  function num(x){
    const n = Number(String(x||"").replace(/[^0-9.\-]/g,""));
    return isFinite(n)? n : 0;
  }

  function compute(d){
    const cases_avoided          = num(d.cases_avoided);
    const avg_cost_per_case      = num(d.avg_cost_per_case);
    const jail_days_avoided      = num(d.jail_days_avoided);
    const cost_per_jail_day      = num(d.cost_per_jail_day);
    const fees_canceled_total    = num(d.fees_canceled_total);
    const licenses_restored      = num(d.licenses_restored); // not yet priced
    const avg_monthly_wage       = num(d.avg_monthly_wage);
    const employment_probability = num(d.employment_probability);
    const months_effective       = num(d.months_effective);
    const expected_lawsuits      = num(d.expected_lawsuits);
    const avg_payout             = num(d.avg_payout);
    const multiplier             = num(d.multiplier);
    const transition_costs       = num(d.transition_costs_one_time);

    const direct_case   = cases_avoided * avg_cost_per_case;
    const detention     = jail_days_avoided * cost_per_jail_day;
    const fees          = fees_canceled_total;
    const employment    = cases_avoided * avg_monthly_wage * employment_probability * (months_effective/12);
    const lawsuits_avo  = expected_lawsuits * avg_payout * multiplier;

    // If you later price licenses_restored, plug it here
    const licensing_val = 0;

    let total = direct_case + detention + fees + employment + lawsuits_avo + licensing_val - transition_costs;
    total = Math.max(0,total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi_per_case = cases_avoided>0 ? total/cases_avoided : 0;

    return {
      total, ciri, cii, roi_per_case,
      parts:{direct_case, detention, fees, employment, lawsuits_avo, licensing_val, transition_costs}
    };
  }

  function drawBars(canvas, values){
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const max = Math.max(...values.map(v=>v.v), 1);
    ctx.clearRect(0,0,W,H);
    const n = values.length, bw = Math.floor(W/(n*2)), gap = bw;
    const base = H - 12;
    values.forEach((item, i)=>{
      const h = Math.round((item.v/max)*(H-24));
      ctx.fillStyle = "#e0e0e0";
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
      ctx.font = "11px system-ui";
      ctx.fillText(item.k, 10 + i*(bw+gap), H-2);
    });
  }

  // ---- Local run history logger (browser-only) ----
  function logRun(parsed, R, opts = {}){
    try{
      const existing = JSON.parse(localStorage.getItem('ciri_runs') || '[]');
      existing.push({
        at: new Date().toISOString(),
        source: opts.source || 'inputs.csv',
        inputs: parsed.obj,
        results: {
          total: R.total,
          ciri: R.ciri,
          cii: R.cii,
          roi_per_case: R.roi_per_case
        },
        audit: opts.audit || null
      });
      localStorage.setItem('ciri_runs', JSON.stringify(existing.slice(-100)));
    }catch(e){
      console.warn('Could not log CIRI run:', e);
    }
  }

  async function boot(){
    // Load CIRI inputs
    for(const u of CANDIDATES){
      try{
        const r = await fetch(u,{cache:"no-store"});
        if(r.ok){ csvText = await r.text(); src = u; break; }
      }catch(_){}
    }
    const status = document.getElementById("ciri-status");
    if(!csvText){
      status.innerHTML = '<span class="ciri-err">Could not load inputs.csv</span>';
      return;
    }
    status.textContent = `Loaded inputs from ${src}`;

    const parsed = parseCSV(csvText);

    // Render inputs table
    const t = document.getElementById("ciri-inputs");
    t.innerHTML = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>'
      + parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??""}</td></tr>`).join("")
      + '</tbody>';

    // Compute results
    const R = compute(parsed.obj);

    // KPIs
    document.getElementById("kpi-total").textContent = money(R.total);
    document.getElementById("kpi-ciri").textContent  = pct(R.ciri);
    document.getElementById("kpi-cii").textContent   = pct(R.cii);
    document.getElementById("kpi-roi").textContent   = money(R.roi_per_case);

    // Breakdown
    const brk = document.getElementById("ciri-breakdown");
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(R.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(R.parts.detention)}</strong></li>
        <li>Fees canceled: <strong>${money(R.parts.fees)}</strong></li>
        <li>Employment & income restoration: <strong>${money(R.parts.employment)}</strong></li>
        <li>Lawsuits avoided (expected √ó payout √ó multiplier): <strong>${money(R.parts.lawsuits_avo)}</strong></li>
        <li>Transition costs (one-time): <strong>‚àí${money(R.parts.transition_costs)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;

    // Chart
    const bars = [
      {k:"Case", v:R.parts.direct_case},
      {k:"Det.", v:R.parts.detention},
      {k:"Fees", v:R.parts.fees},
      {k:"Emp.", v:R.parts.employment},
      {k:"Law.", v:R.parts.lawsuits_avo},
    ];
    drawBars(document.getElementById("ciri-chart"), bars);

    // Nav Dock: CIRI total from this run
    const elDockCiri = document.getElementById('dock-ciri-total');
    if(elDockCiri) elDockCiri.textContent = money(R.total);

    // Nav Dock: CIBS total from /cibs/auto_budget.csv
    try{
      const res = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
      const text = await res.text();
      const [h,...rows] = text.trim().split(/\r?\n/);
      const keys = h.split(',').map(s=>s.trim());
      const sum = rows.reduce((acc,line)=>{
        const vals = line.split(',');
        const obj = {};
        keys.forEach((k,i)=> obj[k] = i===0 ? vals[i] : Number(vals[i]));
        const v = Number(obj.value || obj.Value || 0);
        return acc + (isFinite(v)? v : 0);
      },0);
      const elDockCibs = document.getElementById('dock-cibs-total');
      if(elDockCibs) elDockCibs.textContent = money(sum);
    }catch(_){
      const elDockCibs = document.getElementById('dock-cibs-total');
      if(elDockCibs) elDockCibs.textContent = '‚Äî';
    }

    // Pull audit summary from validator (if it set one)
    const auditSummary = window.CIRI_AUDIT_SUMMARY || null;
    logRun(parsed, R, { source: src, audit: auditSummary });

    // Download single-run report
    document.getElementById("btn-download").addEventListener("click", ()=>{
      const now = new Date().toISOString();
      const lines = [
        ["Generated", now],
        ["Source CSV", src],
        [],
        ["Metric","Value"],
        ["Total Recovery (USD)", R.total],
        ["CIRI (Risk Index)", R.ciri],
        ["CII (Integrity Index)", R.cii],
        ["ROI per Case Avoided", R.roi_per_case],
        ["Direct Case Savings", R.parts.direct_case],
        ["Detention Savings", R.parts.detention],
        ["Fees Canceled", R.parts.fees],
        ["Employment Restoration", R.parts.employment],
        ["Lawsuits Avoided", R.parts.lawsuits_avo],
        ["Transition Costs", R.parts.transition_costs],
        [],
        ["Input Field","CSV Value"],
        ...Object.entries(parsed.obj).map(([k,v])=>[k,v])
      ];
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement("a");
      a.href = url; a.download = "CIRI_report.csv"; a.click();
      URL.revokeObjectURL(url);
    });

    // Export all local runs history
    const btnExport = document.getElementById('btn-export-runs');
    if(btnExport){
      btnExport.addEventListener('click', ()=>{
        try{
          const runs = localStorage.getItem('ciri_runs') || '[]';
          const blob = new Blob([runs],{type:'application/json'});
          const url  = URL.createObjectURL(blob);
          const a    = document.createElement("a");
          a.href = url; a.download = "CIRI_runs_history.json"; a.click();
          URL.revokeObjectURL(url);
        }catch(e){
          alert('Could not export run history. Try again or clear your browser storage.');
        }
      });
    }
  }

  boot();
})();
</script>

<!-- validator (if present, will drive #data-health and can set window.CIRI_AUDIT_SUMMARY) -->
<script src="./validate_ciri.js"></script>

<footer>
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>

</body>
</html>    .badge{color:var(--accent);border:1px solid var(--accent);padding:.45rem .7rem;font-size:.9rem}
    .badge:hover{background:rgba(93,223,255,.08);transform:translateY(-2px)}

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05)
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{background:rgba(255,255,255,.07);padding:.25rem .4rem;border-radius:6px;color:#e3e3e3}

    /* CIRI live calculator styles */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .ciri-kpi{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .ciri-grid>div{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
    .ciri-err{color:#f99}
    canvas{max-width:100%}
    .btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}

    /* data health banner (validator writes here) */
    #data-health{border:1px solid #2a3344;border-radius:10px;padding:10px;background:#0e1218;margin:-.4rem 0 1rem;font-size:.9rem}
    #data-health.ok{border-color:#245b3c;background:#0f1713}
    #data-health.warn{border-color:#66501f;background:#17140b}
    #data-health.err{border-color:#6b2a2a;background:#170f10}

    /* source toggle */
    .source-toggle{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:.6rem}
    .pill{border-radius:999px;border:1px solid #2a3344;padding:.25rem .7rem;font-size:.8rem;color:#9fb0c9}
    .pill strong{color:#eaeef7}
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>
  <!-- Data health banner (validate_ciri.js writes here) -->
  <section id="data-health" aria-live="polite">
    Checking <code>inputs.csv</code>‚Ä¶
  </section>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the
      <em>economic impact of constitutional compliance</em> for their own city or county ‚Äî
      using a single CSV.
    </p>
    <ol>
      <li>Download the example sheet: <a href="./inputs.csv">inputs.csv</a>.</li>
      <li>Replace the example numbers with your local data (keep the header row the same).</li>
      <li>
        Either:
        <ul>
          <li>Commit your updated <code>inputs.csv</code> (for a permanent public model), or</li>
          <li>Use the ‚ÄúUpload CSV‚Äù option below to test it locally without touching the repo.</li>
        </ul>
      </li>
    </ol>
    <p class="ciri-small">
      Browser math and CLI math are aligned. No server required.
    </p>
  </section>

  <!-- Live calculator with built-in + upload modes -->
  <section>
    <h2>‚ö° Live CIRI Calculator</h2>

    <div class="source-toggle">
      <span class="pill">
        Source:
        <label>
          <input type="radio" name="srcMode" value="builtIn" checked>
          use <code>inputs.csv</code>
        </label>
        ¬∑
        <label>
          <input type="radio" name="srcMode" value="upload">
          upload CSV
        </label>
      </span>
      <input type="file" id="file-input" accept=".csv" style="display:none">
      <span id="src-label" class="ciri-small">Using built-in <code>./inputs.csv</code></span>
    </div>

    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi">
          <div class="lbl">Total Recovery (USD)</div>
          <div id="kpi-total" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CIRI ‚Ä¢ Risk Index</div>
          <div id="kpi-ciri" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CII ‚Ä¢ Integrity Index</div>
          <div id="kpi-cii" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">ROI per Case Avoided</div>
          <div id="kpi-roi" class="val">‚Äî</div>
        </div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">
            Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>
            (Matches CLI; adjust in code if your jurisdiction scale is different.)
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>About CIRI</h2>
    <p>
      CIRI translates lawful governance into measurable economic outcomes.
      Each prevented violation reduces measurable fiscal waste.
      Proper implementation strengthens GDP, restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <!-- A.B.E. Nav Dock + Live KPIs -->
  <section id="abe-navdock" class="ciri-box" aria-label="A.B.E. Navigator">
    <h3 style="margin:0 0 10px;color:#5ddfff">A.B.E. Navigator ¬∑ Live Links</h3>
    <div style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Doctrines</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.8">
          <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">A.B.E. ¬∑ CRRA ¬∑ Rebuild Together (viewer)</a></li>
          <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
          <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Calculators & KPIs</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.9">
          <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Archive & License</div>
        <div class="ciri-small" style="line-height:1.7">
          DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
          License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
          Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- ===== CIRI calculator script (built-in + upload) ===== -->
<script>
(function(){
  const K = 1_000_000_000; // risk scaling (matches CLI)
  function money(n){
    try{ return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
    catch(_){ return "$"+Math.round(n||0).toLocaleString(); }
  }
  function pct(x){ return (x*100).toFixed(1)+"%"; }

  const SERVER_CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];
  let lastSourceLabel = "built-in inputs.csv";
  let parsedCache = null;
  let resultCache = null;

  function parseCSV(txt){
    const lines = txt.trim().split(/\r?\n/).filter(Boolean);
    const head  = (lines.shift()||"").split(",").map(s=>s.trim());
    const row   = (lines.shift()||"").split(",").map(s=>s.trim());
    const obj   = {};
    head.forEach((h,i)=> obj[h]=row[i]);
    return {head,row,obj};
  }
  function num(x){
    const n = Number(String(x||"").replace(/[^0-9.\-]/g,""));
    return isFinite(n)?n:0;
  }

  function compute(d){
    const cases_avoided          = num(d.cases_avoided);
    const avg_cost_per_case      = num(d.avg_cost_per_case);
    const jail_days_avoided      = num(d.jail_days_avoided);
    const cost_per_jail_day      = num(d.cost_per_jail_day);
    const fees_canceled_total    = num(d.fees_canceled_total);
    const licenses_restored      = num(d.licenses_restored);
    const avg_monthly_wage       = num(d.avg_monthly_wage);
    const employment_probability = num(d.employment_probability);
    const months_effective       = num(d.months_effective);
    const expected_lawsuits      = num(d.expected_lawsuits);
    const avg_payout             = num(d.avg_payout);
    const multiplier             = num(d.multiplier);
    const transition_costs       = num(d.transition_costs_one_time);

    const direct_case   = cases_avoided * avg_cost_per_case;
    const detention     = jail_days_avoided * cost_per_jail_day;
    const fees          = fees_canceled_total;
    const employment    = cases_avoided * avg_monthly_wage * employment_probability * (months_effective/12);
    const lawsuits_avo  = expected_lawsuits * avg_payout * multiplier;
    const licensing_val = 0;

    let total = direct_case + detention + fees + employment + lawsuits_avo + licensing_val - transition_costs;
    total = Math.max(0,total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi_per_case = cases_avoided>0 ? total/cases_avoided : 0;

    return {
      total, ciri, cii, roi_per_case,
      parts:{direct_case, detention, fees, employment, lawsuits_avo, licensing_val, transition_costs}
    };
  }

  function render(parsed, R){
    parsedCache = parsed;
    resultCache = R;
    const status = document.getElementById("ciri-status");
    const t = document.getElementById("ciri-inputs");

    t.innerHTML = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>'
      + parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??""}</td></tr>`).join("")
      + '</tbody>';
    status.textContent = `Loaded inputs from ${lastSourceLabel}`;

    document.getElementById("kpi-total").textContent = money(R.total);
    document.getElementById("kpi-ciri").textContent  = pct(R.ciri);
    document.getElementById("kpi-cii").textContent   = pct(R.cii);
    document.getElementById("kpi-roi").textContent   = money(R.roi_per_case);

    const brk = document.getElementById("ciri-breakdown");
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(R.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(R.parts.detention)}</strong></li>
        <li>Fees canceled: <strong>${money(R.parts.fees)}</strong></li>
        <li>Employment & income restoration: <strong>${money(R.parts.employment)}</strong></li>
        <li>Lawsuits avoided (expected √ó payout √ó multiplier): <strong>${money(R.parts.lawsuits_avo)}</strong></li>
        <li>Transition costs (one-time): <strong>‚àí${money(R.parts.transition_costs)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;

    const canvas = document.getElementById("ciri-chart");
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const vals = [
      {k:"Case", v:R.parts.direct_case},
      {k:"Det.", v:R.parts.detention},
      {k:"Fees", v:R.parts.fees},
      {k:"Emp.", v:R.parts.employment},
      {k:"Law.", v:R.parts.lawsuits_avo},
    ];
    const max = Math.max(...vals.map(v=>v.v), 1);
    ctx.clearRect(0,0,W,H);
    const n = vals.length, bw = Math.floor(W/(n*2)), gap = bw, base = H-12;
    vals.forEach((item,i)=>{
      const h = Math.round((item.v/max)*(H-24));
      ctx.fillStyle = "#e0e0e0";
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
      ctx.font = "11px system-ui";
      ctx.fillText(item.k, 10 + i*(bw+gap), H-2);
    });

    // Nav dock CIRI total from this run
    const elDockCiri = document.getElementById('dock-ciri-total');
    if(elDockCiri) elDockCiri.textContent = money(R.total);

    // Nav dock CIBS total from /cibs/auto_budget.csv
    (async () => {
      try{
        const res = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
        const text = await res.text();
        const [h,...rows] = text.trim().split(/\r?\n/);
        const keys = h.split(',').map(s=>s.trim());
        const sum = rows.reduce((acc,line)=>{
          const vals = line.split(',');
          const obj = {};
          keys.forEach((k,i)=>obj[k]= i===0 ? vals[i] : Number(vals[i]));
          const v = Number(obj.value || obj.Value || 0);
          return acc + (isFinite(v)?v:0);
        },0);
        const elDockCibs = document.getElementById('dock-cibs-total');
        if(elDockCibs) elDockCibs.textContent = money(sum);
      }catch(_){
        const elDockCibs = document.getElementById('dock-cibs-total');
        if(elDockCibs) elDockCibs.textContent = '‚Äî';
      }
    })();
  }

  async function loadBuiltIn(){
    const status = document.getElementById("ciri-status");
    status.textContent = "Loading inputs.csv‚Ä¶";
    let csvText = null, src = null;
    for(const u of SERVER_CANDIDATES){
      try{
        const r = await fetch(u,{cache:'no-store'});
        if(r.ok){ csvText = await r.text(); src = u; break; }
      }catch(_){}
    }
    if(!csvText){
      status.innerHTML = '<span class="ciri-err">Could not load inputs.csv</span>';
      return;
    }
    lastSourceLabel = src || "inputs.csv";
    document.getElementById("src-label").textContent = `Using built-in ${lastSourceLabel}`;
    const parsed = parseCSV(csvText);
    const R = compute(parsed.obj);
    render(parsed,R);
  }

  function handleUpload(file){
    const status = document.getElementById("ciri-status");
    if(!file){ return; }
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const text = e.target.result;
        const parsed = parseCSV(text);
        lastSourceLabel = `uploaded file (${file.name})`;
        document.getElementById("src-label").textContent = `Using uploaded CSV: ${file.name}`;
        const R = compute(parsed.obj);
        render(parsed,R);
      }catch(err){
        console.error(err);
        status.innerHTML = '<span class="ciri-err">Could not parse uploaded CSV (check header row and values).</span>';
      }
    };
    reader.readAsText(file);
  }

  function initDownload(){
    const btn = document.getElementById("btn-download");
    if(!btn) return;
    btn.addEventListener("click", ()=>{
      if(!parsedCache || !resultCache) return;
      const now = new Date().toISOString();
      const lines = [
        ["Generated", now],
        ["Source", lastSourceLabel],
        [],
        ["Metric","Value"],
        ["Total Recovery (USD)", resultCache.total],
        ["CIRI (Risk Index)", resultCache.ciri],
        ["CII (Integrity Index)", resultCache.cii],
        ["ROI per Case Avoided", resultCache.roi_per_case],
        ["Direct Case Savings", resultCache.parts.direct_case],
        ["Detention Savings", resultCache.parts.detention],
        ["Fees Canceled", resultCache.parts.fees],
        ["Employment Restoration", resultCache.parts.employment],
        ["Lawsuits Avoided", resultCache.parts.lawsuits_avo],
        ["Transition Costs", resultCache.parts.transition_costs],
        [],
        ["Input Field","CSV Value"],
        ...Object.entries(parsedCache.obj).map(([k,v])=>[k,v])
      ];
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "CIRI_report.csv"; a.click();
      URL.revokeObjectURL(url);
    });
  }

  function initSourceToggle(){
    const radios = document.querySelectorAll('input[name="srcMode"]');
    const fileInput = document.getElementById("file-input");
    radios.forEach(r=>{
      r.addEventListener("change", e=>{
        if(e.target.value === "upload"){
          fileInput.style.display = "inline-block";
          fileInput.focus();
        }else{
          fileInput.style.display = "none";
          loadBuiltIn();
        }
      });
    });
    fileInput.addEventListener("change", e=>{
      const file = e.target.files[0];
      if(file) handleUpload(file);
    });
  }

  // boot
  loadBuiltIn();
  initSourceToggle();
  initDownload();
})();
</script>
<!-- ===== /CIRI calculator script ===== -->

<!-- validator (kept as-is) -->
<script src="./validate_ciri.js"></script>

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under 
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>

</body>
</html>.ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
.ciri-err{color:#f99}
canvas{max-width:100%}
.btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
@media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}
/* validator banner */
#data-health{border:1px solid #2a3344;border-radius:10px;padding:10px;background:#0e1218;margin:-.4rem 0 1rem}
#data-health.ok{border-color:#245b3c;background:#0f1713}
#data-health.warn{border-color:#66501f;background:#17140b}
#data-health.err{border-color:#6b2a2a;background:#170f10}
</style>
</head>
<body>
<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>
  <!-- Data health banner (validator writes here) -->
  <section id="data-health" aria-live="polite">Checking inputs.csv‚Ä¶</section>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>The <strong>CIRI</strong> engine lets anyone measure the <em>economic impact of constitutional compliance</em> for their own city or county ‚Äî using a single CSV.</p>
    <ol>
      <li>Open <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Optional CLI run (writes CIBS budget):<br><code>python3 ciri/calculate.py</code></li>
      <li>View results below and/or in CIBS after running the CLI.</li>
    </ol>
    <p class="ciri-small">Browser math and CLI math are aligned. No server required.</p>
  </section>

  <section>
    <h2>‚ö° Live CIRI Calculator (reads <code>./inputs.csv</code>)</h2>
    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi"><div class="lbl">Total Recovery (USD)</div><div id="kpi-total" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CIRI ‚Ä¢ Risk Index</div><div id="kpi-ciri" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CII ‚Ä¢ Integrity Index</div><div id="kpi-cii" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">ROI per Case Avoided</div><div id="kpi-roi" class="val">‚Äî</div></div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>(Matches CLI; adjust in code if your jurisdiction scale is different.)</div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>About CIRI</h2>
    <p>CIRI translates lawful governance into measurable economic outcomes. Each prevented violation reduces measurable fiscal waste. Proper implementation strengthens GDP, restores public trust, and lowers state dependency.</p>
    <ul><li><a href="./inputs.csv">Download example input sheet</a></li></ul>
  </section>
</main>

<script>
(function(){
  const K = 1_000_000_000;
  const money = n => { try{ return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }catch(_){ return "$"+Math.round(n).toLocaleString(); } };
  const pct   = x => (x*100).toFixed(1)+"%";

  const CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];
  let csvText=null, src=null;

  function parseCSV(txt){ const lines=txt.trim().split(/\r?\n/).filter(Boolean); const head=(lines.shift()||"").split(",").map(s=>s.trim()); const row=(lines.shift()||"").split(",").map(s=>s.trim()); const obj={}; head.forEach((h,i)=>obj[h]=row[i]); return {head,row,obj}; }
  const num = x => { const n = Number(String(x||"").replace(/[^0-9.\-]/g,"")); return isFinite(n)?n:0; };

  function compute(d){
    const c=num(d.cases_avoided), C=num(d.avg_cost_per_case), D=num(d.jail_days_avoided), J=num(d.cost_per_jail_day),
          F=num(d.fees_canceled_total), H=num(d.licenses_restored)||0, // legacy field ok
          pe=num(d.employment_probability), W=num(d.avg_monthly_wage), m=num(d.months_effective),
          L=num(d.expected_lawsuits), A=num(d.avg_payout), M=num(d.multiplier)||1,
          T=num(d.transition_costs_one_time);

    const direct_case = c*C + F;
    const detention   = D*J;
    const employment  = c*pe*W*(m/12);
    const lawsuits_avo= L*A*M;
    const licensing   = 0;

    let total = direct_case + detention + employment + lawsuits_avo + licensing - T;
    total = Math.max(0,total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi  = c>0 ? total/c : 0;

    return { total, ciri, cii, roi, parts:{direct_case,detention,employment,lawsuits_avo,licensing,transition:T} };
  }

  function drawBars(canvas, values){
    const ctx=canvas.getContext("2d"), W=canvas.width, H=canvas.height, max=Math.max(...values.map(v=>v.v),1);
    ctx.clearRect(0,0,W,H); const n=values.length, bw=Math.floor(W/(n*2)), gap=bw, base=H-12;
    values.forEach((t,i)=>{ const h=Math.round((t.v/max)*(H-24)); ctx.fillStyle="#e0e0e0"; ctx.fillRect(10+i*(bw+gap), base-h, bw, h); ctx.font="11px system-ui"; ctx.fillText(t.k,10+i*(bw+gap), H-2); });
  }

  async function boot(){
    for(const u of CANDIDATES){ try{ const r=await fetch(u,{cache:"no-store"}); if(r.ok){ csvText=await r.text(); src=u; break; } }catch{} }
    const status = document.getElementById("ciri-status");
    if(!csvText){ status.innerHTML='<span class="ciri-err">Could not load inputs.csv</span>'; return; }
    status.textContent = `Loaded inputs from ${src}`;

    const parsed=parseCSV(csvText);
    const t=document.getElementById("ciri-inputs");
    t.innerHTML='<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>'+parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??""}</td></tr>`).join("")+'</tbody>';

    const R=compute(parsed.obj);
    document.getElementById("kpi-total").textContent=money(R.total);
    document.getElementById("kpi-ciri").textContent =pct(R.ciri);
    document.getElementById("kpi-cii").textContent  =pct(R.cii);
    document.getElementById("kpi-roi").textContent  =money(R.roi);

    const brk=document.getElementById("ciri-breakdown");
    brk.innerHTML=`<div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(R.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(R.parts.detention)}</strong></li>
        <li>Employment & income restoration: <strong>${money(R.parts.employment)}</strong></li>
        <li>Lawsuits avoided: <strong>${money(R.parts.lawsuits_avo)}</strong></li>
        <li>Transition costs: <strong>‚àí${money(R.parts.transition)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>`;

    drawBars(document.getElementById("ciri-chart"),[
      {k:"Case",v:R.parts.direct_case},
      {k:"Det.",v:R.parts.detention},
      {k:"Emp.",v:R.parts.employment},
      {k:"Law.",v:R.parts.lawsuits_avo}
    ]);

    document.getElementById("btn-download").addEventListener("click",()=>{
      const now=new Date().toISOString();
      const lines=[["Generated",now],["Source CSV",src],[],["Metric","Value"],["Total Recovery (USD)",R.total],["CIRI",R.ciri],["CII",R.cii],["ROI per Case",R.roi],["Direct Case",R.parts.direct_case],["Detention",R.parts.detention],["Employment",R.parts.employment],["Lawsuits Avoided",R.parts.lawsuits_avo],["Transition Costs",-R.parts.transition],[],["Input Field","CSV Value"],...Object.entries(parsed.obj).map(([k,v])=>[k,v])];
      const csv=lines.map(r=>r.join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="CIRI_report.csv"; a.click(); URL.revokeObjectURL(url);
    });
  }
  boot();
})();
</script>

<!-- validator (new) -->
<script src="./validate_ciri.js"></script>

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">CC BY-NC 4.0</a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>
</body>
</html>    .badge:hover{background:rgba(93,223,255,.08);transform:translateY(-2px)}

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05)
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{background:rgba(255,255,255,.07);padding:.25rem .4rem;border-radius:6px;color:#e3e3e3}

    /* ===== CIRI live calculator styles ===== */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .ciri-kpi{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .ciri-grid>div{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
    .ciri-err{color:#f99}
    canvas{max-width:100%}
    .btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the <em>economic impact of constitutional compliance</em>
      for their own city or county ‚Äî using a single CSV.
    </p>

    <ol>
      <li>Open <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Optional CLI run (writes CIBS budget):<br>
        <code>python3 ciri/calculate.py</code>
      </li>
      <li>View results below and/or in CIBS after running the CLI.</li>
    </ol>

    <p class="ciri-small">
      Browser math and CLI math are aligned. No server required.
    </p>
  </section>

  <!-- ===== LIVE BROWSER CALCULATOR (reads ./inputs.csv) ===== -->
  <section>
    <h2>‚ö° Live CIRI Calculator (reads <code>./inputs.csv</code>)</h2>
    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi"><div class="lbl">Total Recovery (USD)</div><div id="kpi-total" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CIRI ‚Ä¢ Risk Index</div><div id="kpi-ciri" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CII ‚Ä¢ Integrity Index</div><div id="kpi-cii" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">ROI per Case Avoided</div><div id="kpi-roi" class="val">‚Äî</div></div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">
            Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>
            (Matches CLI; adjust in code if your jurisdiction scale is different.)
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== /LIVE BROWSER CALCULATOR ===== -->

  <section>
    <h2>About CIRI</h2>
    <p>
      CIRI translates lawful governance into measurable economic outcomes. Each prevented violation reduces
      measurable fiscal waste. Proper implementation strengthens GDP, restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ A.B.E. Nav Dock + Live KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section id="abe-navdock" class="ciri-box" aria-label="A.B.E. Navigator">
    <h3 style="margin:0 0 10px;color:#5ddfff">A.B.E. Navigator ¬∑ Live Links</h3>
    <div style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Doctrines</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.8">
          <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">A.B.E. ¬∑ CRRA ¬∑ Rebuild Together (viewer)</a></li>
          <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
          <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Calculators & KPIs</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.9">
          <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Archive & License</div>
        <div class="ciri-small" style="line-height:1.7">
          DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
          License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
          Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
        </div>
      </div>
    </div>
  </section>
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ End Nav Dock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

</main>

<!-- ===== CIRI calculator script (aligned to your CSV headers) ===== -->
<script>
(function(){
  const K = 1_000_000_000; // risk scaling (matches CLI)
  function money(n){ try{ return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }catch(_){ return "$"+Math.round(n).toLocaleString(); } }
  function pct(x){ return (x*100).toFixed(1)+"%"; }

  // 1) Load ./inputs.csv (try relative then absolute)
  const CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];
  let csvText=null, src=null;

  function parseCSV(txt){
    const lines = txt.trim().split(/\r?\n/).filter(Boolean);
    const head  = (lines.shift()||"").split(",").map(s=>s.trim());
    const row   = (lines.shift()||"").split(",").map(s=>s.trim());
    const obj   = {};
    head.forEach((h,i)=> obj[h]=row[i]);
    return {head,row,obj};
  }

  function num(x){ const n = Number(String(x||"").replace(/[^0-9.\-]/g,"")); return isFinite(n)?n:0; }

  function compute(d){
    const cases_avoided          = num(d.cases_avoided);
    const avg_cost_per_case      = num(d.avg_cost_per_case);
    const jail_days_avoided      = num(d.jail_days_avoided);
    const cost_per_jail_day      = num(d.cost_per_jail_day);
    const fees_canceled_total    = num(d.fees_canceled_total);
    const licenses_restored      = num(d.licenses_restored);
    const avg_monthly_wage       = num(d.avg_monthly_wage);
    const employment_probability = num(d.employment_probability);
    const months_effective       = num(d.months_effective);
    const expected_lawsuits      = num(d.expected_lawsuits);
    const avg_payout             = num(d.avg_payout);
    const multiplier             = num(d.multiplier);
    const transition_costs       = num(d.transition_costs_one_time);

    const direct_case   = cases_avoided * avg_cost_per_case;
    const detention     = jail_days_avoided * cost_per_jail_day;
    const fees          = fees_canceled_total;
    const employment    = cases_avoided * avg_monthly_wage * employment_probability * (months_effective/12);
    const lawsuits_avo  = expected_lawsuits * avg_payout * multiplier;

    const licensing_val = 0;

    let total = direct_case + detention + fees + employment + lawsuits_avo + licensing_val - transition_costs;
    total = Math.max(0,total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi_per_case = cases_avoided>0 ? total/cases_avoided : 0;

    return { total, ciri, cii, roi_per_case, parts:{direct_case, detention, fees, employment, lawsuits_avo, licensing_val, transition_costs} };
  }

  function drawBars(canvas, values){
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const vals = values;
    const max = Math.max(...vals.map(v=>v.v), 1);
    ctx.clearRect(0,0,W,H);
    const n = vals.length, bw = Math.floor(W/(n*2)), gap = bw;
    const base = H - 12;
    vals.forEach((item, i)=>{
      const h = Math.round((item.v/max)*(H-24));
      ctx.fillStyle = "#e0e0e0";
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
      ctx.font = "11px system-ui";
      ctx.fillText(item.k, 10 + i*(bw+gap), H-2);
    });
  }

  async function boot(){
    // Load CIRI inputs
    for(const u of CANDIDATES){
      try{
        const r = await fetch(u,{cache:"no-store"});
        if(r.ok){ csvText = await r.text(); src=u; break; }
      }catch(_){}
    }
    const status = document.getElementById("ciri-status");
    if(!csvText){ status.innerHTML = '<span class="ciri-err">Could not load inputs.csv</span>'; return; }
    status.textContent = `Loaded inputs from ${src}`;

    const parsed = parseCSV(csvText);

    // Render inputs table
    const t = document.getElementById("ciri-inputs");
    t.innerHTML = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>'
      + parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??""}</td></tr>`).join("")
      + '</tbody>';

    // Compute results
    const R = compute(parsed.obj);

    // KPIs
    document.getElementById("kpi-total").textContent = money(R.total);
    document.getElementById("kpi-ciri").textContent  = pct(R.ciri);
    document.getElementById("kpi-cii").textContent   = pct(R.cii);
    document.getElementById("kpi-roi").textContent   = money(R.roi_per_case);

    // Breakdown
    const brk = document.getElementById("ciri-breakdown");
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(R.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(R.parts.detention)}</strong></li>
        <li>Fees canceled: <strong>${money(R.parts.fees)}</strong></li>
        <li>Employment & income restoration: <strong>${money(R.parts.employment)}</strong></li>
        <li>Lawsuits avoided (expected √ó payout √ó multiplier): <strong>${money(R.parts.lawsuits_avo)}</strong></li>
        <li>Transition costs (one-time): <strong>‚àí${money(R.parts.transition_costs)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;

    // Chart
    const bars = [
      {k:"Case", v:R.parts.direct_case},
      {k:"Det.", v:R.parts.detention},
      {k:"Fees", v:R.parts.fees},
      {k:"Emp.", v:R.parts.employment},
      {k:"Law.", v:R.parts.lawsuits_avo},
    ];
    drawBars(document.getElementById("ciri-chart"), bars);

    // ‚îÄ‚îÄ Nav Dock KPIs: CIRI total from this page
    const elDockCiri = document.getElementById('dock-ciri-total');
    if(elDockCiri) elDockCiri.textContent = money(R.total);

    // ‚îÄ‚îÄ Nav Dock KPIs: CIBS total from /cibs/auto_budget.csv
    try{
      const res = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
      const text = await res.text();
      const [h,...rows] = text.trim().split(/\r?\n/);
      const keys = h.split(',').map(s=>s.trim());
      const sum = rows.reduce((acc, line)=>{
        const vals = line.split(',');
        const obj = {};
        keys.forEach((k,i)=>obj[k]= i===0 ? vals[i] : Number(vals[i]));
        const v = Number(obj.value || obj.Value || 0);
        return acc + (isFinite(v)? v : 0);
      },0);
      const elDockCibs = document.getElementById('dock-cibs-total');
      if(elDockCibs) elDockCibs.textContent = money(sum);
    }catch(_){
      const elDockCibs = document.getElementById('dock-cibs-total');
      if(elDockCibs) elDockCibs.textContent = '‚Äî';
    }

    // Download report
    document.getElementById("btn-download").addEventListener("click", ()=>{
      const now = new Date().toISOString();
      const lines = [
        ["Generated", now],
        ["Source CSV", src],
        [],
        ["Metric","Value"],
        ["Total Recovery (USD)", R.total],
        ["CIRI (Risk Index)", R.ciri],
        ["CII (Integrity Index)", R.cii],
        ["ROI per Case Avoided", R.roi_per_case],
        ["Direct Case Savings", R.parts.direct_case],
        ["Detention Savings", R.parts.detention],
        ["Fees Canceled", R.parts.fees],
        ["Employment Restoration", R.parts.employment],
        ["Lawsuits Avoided", R.parts.lawsuits_avo],
        ["Transition Costs", R.parts.transition_costs],
        [],
        ["Input Field","CSV Value"],
        ...Object.entries(parsed.obj).map(([k,v])=>[k,v])
      ];
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "CIRI_report.csv"; a.click();
      URL.revokeObjectURL(url);
    });
  }

  boot();
})();
</script>
<!-- ===== /CIRI calculator script ===== -->

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under 
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>

</body>
</html>
