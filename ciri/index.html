<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIRI ‚Äì Constitutional Integrity ROI Engine | A.B.E.</title>

  <!-- Optional site patch; safe if missing -->
  <link rel="stylesheet" href="/abe---flag/abe-patch/assets/abe-patch.css"/>

  <style>
    :root{
      --bg:#0b0d12; --panel:#13161b; --ink:#e0e0e0; --muted:#9aa3ad;
      --edge:rgba(255,255,255,.08); --edge2:rgba(255,255,255,.12);
      --accent:#5ddfff; --accent2:#ffa559;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.65;margin:0}

    header{
      background:linear-gradient(90deg,#11151c,#1b1e25);
      border-bottom:1px solid var(--edge);
      padding:2rem 1rem;
      text-align:center;
      position:relative
    }
    .home-btn{
      position:absolute;left:1rem;top:1.2rem;
      background:var(--accent);color:#0b0d12;
      padding:.45rem .9rem;border-radius:8px;font-weight:700;text-decoration:none;font-size:.9rem;
      transition:all .2s ease-in-out;border:1px solid transparent
    }
    .home-btn:hover{background:#82eaff;box-shadow:0 0 8px rgba(93,223,255,.7);transform:translateY(-2px)}
    h1{color:var(--accent2);font-size:1.8rem;margin:.1rem 0 .4rem;font-weight:800}
    header p{margin:.25rem 0 0;color:var(--muted)}
    .top-actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin:.9rem 0 0}
    .btn,.badge{display:inline-block;text-decoration:none;font-weight:700;border-radius:8px;transition:all .18s ease-in-out}
    .btn{background:var(--accent);color:#0b0d12;padding:.55rem 1rem;border:1px solid transparent}
    .btn:hover{background:#82eaff;transform:translateY(-2px);box-shadow:0 0 10px rgba(93,223,255,.6)}
    .badge{color:var(--accent);border:1px solid var(--accent);padding:.45rem .7rem;font-size:.9rem}
    .badge:hover{background:rgba(93,223,255,.08);transform:translateY(-2px)}

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05)
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{background:rgba(255,255,255,.07);padding:.25rem .4rem;border-radius:6px;color:#e3e3e3}

    /* ===== CIRI live calculator styles ===== */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .ciri-kpi{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .ciri-grid>div{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
    .ciri-err{color:#f99}
    .ciri-controls{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .ciri-inline input{width:110px;background:#0d0f12;border:1px solid #2a3344;border-radius:6px;color:#eaeef7;padding:4px 6px}
    .ciri-slider{display:flex;gap:10px;align-items:center}
    .ciri-slider input[type="range"]{width:220px}
    canvas{max-width:100%}
    .btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the <em>economic impact of constitutional compliance</em>
      for their own city or county.
    </p>

    <ol>
      <li>Open <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Run the calculator from your command line:
        <pre><code>python3 ciri/calculate.py</code></pre>
      </li>
      <li>View your economic impact report directly in the console.</li>
      <li>Your reinvestment file is written to <code>/cibs/auto_budget.csv</code> ‚Äî that‚Äôs your community‚Äôs <strong>Recovery Pool</strong> ready for allocation.</li>
    </ol>

    <p class="ciri-small">
      The script operates locally ‚Äî no server or internet required. Outputs are evidence-ready for filings, budgets, and audits.
    </p>
  </section>

  <!-- ===== LIVE BROWSER CALCULATOR (reads ./inputs.csv) ===== -->
  <section>
    <h2>‚ö° Live CIRI Calculator (no download needed)</h2>
    <div id="ciri-app" class="ciri-box">
      <div><strong>Client-side computation</strong> ‚Äî reads <code>./inputs.csv</code>, computes Recovery, CIRI, and CII in your browser.</div>

      <div class="ciri-kpis">
        <div class="ciri-kpi"><div class="lbl">Total Recovery (USD)</div><div id="kpi-total" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CIRI ‚Ä¢ Constitutional Integrity Risk Index</div><div id="kpi-ciri" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CII ‚Ä¢ Constitutional Integrity Index</div><div id="kpi-cii" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">ROI per Case Avoided</div><div id="kpi-roi" class="val">‚Äî</div></div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions & Scenario Explorer</div>
          <div class="ciri-controls ciri-small">
            <label>Avg jail days avoided per case:
              <input id="assump-days" class="ciri-inline" type="number" step="0.1" min="0" value="5">
            </label>
            <label>Risk scaling (K, USD):
              <input id="assump-k" class="ciri-inline" type="number" step="1000000" min="1" value="1000000000">
            </label>
            <div class="ciri-slider">
              <label>Cases avoided</label>
              <input id="slider-cases" type="range" min="0" max="5000" step="50">
              <span id="lbl-cases">‚Äî</span>
            </div>
            <div class="ciri-slider">
              <label>Transport weight</label>
              <input id="slider-trans" type="range" min="0" max="1000" step="10">
              <span id="lbl-trans">‚Äî</span>
            </div>
            <button id="btn-reset" class="btn-ghost">Reset to CSV</button>
            <button id="recalc" class="btn-ghost">Recalculate</button>
          </div>
          <div class="ciri-small" style="margin-top:8px">
            <strong>CIRI</strong> = ( 1 ‚àí e<sup>‚àíTotal/K</sup> ) &nbsp; ‚Ä¢ &nbsp; <strong>CII</strong> = 1 ‚àí CIRI
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Scenario chart"></canvas>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== /LIVE BROWSER CALCULATOR ===== -->

  <section>
    <h2>About CIRI</h2>
    <p>
      The CIRI engine translates lawful governance into measurable economic outcomes. Each prevented
      constitutional violation reduces measurable fiscal waste. Proper implementation strengthens GDP,
      restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="https://github.com/Terra610/abe---flag/blob/main/ciri/calc.md" target="_blank" rel="noopener">View calculation documentation</a></li>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <section>
    <h2>Integration with CIBS</h2>
    <p>
      After running the calculator, CIRI will automatically seed a draft allocation file
      into <a href="/abe---flag/cibs/auto_budget.csv">CIBS</a>. That file defines how the
      <strong>Recovery Pool</strong> should be reinvested into community programs like housing,
      youth development, and legal defense.
    </p>
  </section>

</main>

<!-- Optional patch scripts -->
<script src="/abe---flag/abe-patch/assets/abe-nav.js"></script>
<script src="/abe---flag/abe-patch/assets/abe-definitions.js"></script>

<!-- ===== CIRI calculator script ===== -->
<script>
(async function(){
  // Try relative first, then absolute fallback
  const CANDIDATES = ['./inputs.csv','/abe---flag/ciri/inputs.csv'];
  let csvText=null, src=null;
  for (const u of CANDIDATES){
    try { const r = await fetch(u,{cache:'no-store'}); if(r.ok){ csvText=await r.text(); src=u; break; } } catch(_){}
  }
  const status = document.getElementById('ciri-status');
  if(!csvText){ status.innerHTML='<span class="ciri-err">Could not load inputs.csv</span>'; return; }
  status.textContent = `Loaded inputs from ${src}`;

  // Parse one-row CSV
  function parseCSV(txt){
    const lines = txt.trim().split(/\r?\n/);
    const head = lines.shift().split(',').map(s=>s.trim());
    const row  = (lines[0]||'').split(',').map(s=>s.trim());
    const obj={}; head.forEach((h,i)=>obj[h]=row[i]);
    return {head,row,obj};
  }
  const parsed = parseCSV(csvText);

  // Show the raw inputs as a table (transparency)
  const t = document.getElementById('ciri-inputs');
  t.innerHTML = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>' +
    parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??''}</td></tr>`).join('') +
    '</tbody>';

  // Normalize into expected numeric keys (your exact headers)
  const mapExact = [
    'cases_avoided',
    'avg_cost_per_case',
    'jail_days_avoided',
    'cost_per_jail_day',
    'fees_canceled_total',
    'licenses_restored',
    'avg_monthly_wage',
    'employment_probability',
    'months_effective',
    'expected_lawsuits',
    'avg_payout',
    'multiplier',
    'transition_costs_one_time'
  ];
  function toNum(x){ const v = Number(String(x||'').replace(/[^0-9.\-]/g,'')); return isFinite(v)?v:0; }
  const CSV = {};
  mapExact.forEach(k=> CSV[k] = toNum(parsed.obj[k]));
  let X = {...CSV}; // working copy

  // Core calculator (aligned to your schema)
  function compute(V, A){
    const {
      cases_avoided,
      avg_cost_per_case,
      jail_days_avoided,
      cost_per_jail_day,
      fees_canceled_total,
      avg_monthly_wage,
      employment_probability,
      months_effective,
      expected_lawsuits,
      avg_payout,
      multiplier,
      transition_costs_one_time
    } = V;

    // Components
    const direct_case = (cases_avoided * avg_cost_per_case) + fees_canceled_total;
    const detention   = jail_days_avoided * cost_per_jail_day;
    const employment  = cases_avoided * avg_monthly_wage * (months_effective/12) * employment_probability * Math.max(1, multiplier);
    const lawsuits    = expected_lawsuits * avg_payout;
    const transitions = transition_costs_one_time;

    const total = direct_case + detention + employment + lawsuits - transitions;

    const ciri = 1 - Math.exp(- total / Math.max(1,A.K)); // risk scaling
    const cii  = 1 - ciri;
    const roiPerCase = cases_avoided > 0 ? total / cases_avoided : 0;

    return { total, ciri, cii, roiPerCase, parts:{direct_case, detention, employment, lawsuits, transitions} };
  }

  // Wire UI
  const daysEl = document.getElementById('assump-days');
  const kEl    = document.getElementById('assump-k');
  const kpiT   = document.getElementById('kpi-total');
  const kpiRI  = document.getElementById('kpi-ciri');
  const kpiFI  = document.getElementById('kpi-cii');
  const kpiROI = document.getElementById('kpi-roi');
  const brk    = document.getElementById('ciri-breakdown');

  const sCases = document.getElementById('slider-cases');
  const sTrans = document.getElementById('slider-trans'); // repurposed ‚Üí lawsuits
  const lCases = document.getElementById('lbl-cases');
  const lTrans = document.getElementById('lbl-trans');
  const btnReset = document.getElementById('btn-reset');

  // Repurpose the second slider label so you don't have to edit HTML
  const sliderLabels = document.querySelectorAll('.ciri-slider label');
  if (sliderLabels[0]) sliderLabels[0].textContent = 'Cases avoided';
  if (sliderLabels[1]) sliderLabels[1].textContent = 'Expected lawsuits';

  // Initialize sliders from CSV
  sCases.min = 0;
  sCases.max = Math.max(100, Math.ceil((X.cases_avoided||0)*2));
  sCases.step = 10;
  sCases.value = X.cases_avoided||0;
  lCases.textContent = Number(sCases.value).toLocaleString();

  sTrans.min = 0;
  sTrans.max = Math.max(50, Math.ceil((X.expected_lawsuits||0)*2));
  sTrans.step = 1;
  sTrans.value = X.expected_lawsuits||0;
  lTrans.textContent = Number(sTrans.value).toLocaleString();

  // Formatters
  function fmtUSD(n){ return Number(n||0).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}); }
  function pct(x){ return (x*100).toFixed(1)+'%'; }

  // Tiny bar chart of components
  const ctx = document.getElementById('ciri-chart').getContext('2d');
  function drawChart(value){
    const W = ctx.canvas.width, H = ctx.canvas.height;
    ctx.clearRect(0,0,W,H);
    const {direct_case, detention, employment, lawsuits} = value.parts;
    const vals = [direct_case, detention, employment, lawsuits];
    const max  = Math.max(...vals, 1);
    const bw = Math.floor(W/10), gap=bw*0.7; const base = H-10;
    const labels = ['Direct','Detention','Employment','Lawsuits'];
    for(let i=0;i<vals.length;i++){
      const h = Math.round((vals[i]/max)*(H-26));
      ctx.fillStyle = '#e0e0e0';
      const x = 10 + i*(bw+gap);
      ctx.fillRect(x, base-h, bw, h);
      ctx.fillText(labels[i], x, H-2);
    }
  }

  function recalc(){
    const A = { jailDays: Number(daysEl.value||0), K: Number(kEl.value||1) };

    // Sync assumption "Avg jail days avoided per case" to total jail days if user tweaks it:
    // Convert per-case days -> total days keeping cases_avoided constant
    if (X.cases_avoided > 0) {
      const perCaseDays = A.jailDays;
      X.jail_days_avoided = perCaseDays * X.cases_avoided;
    }

    const R = compute(X, A);
    kpiT.textContent   = fmtUSD(R.total);
    kpiRI.textContent  = pct(R.ciri);
    kpiFI.textContent  = pct(R.cii);
    kpiROI.textContent = fmtUSD(R.roiPerCase);
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case + fees: <strong>${fmtUSD(R.parts.direct_case)}</strong></li>
        <li>Detention (total ${fmtUSD(X.jail_days_avoided)} days @ ${fmtUSD(X.cost_per_jail_day)}/day): <strong>${fmtUSD(R.parts.detention)}</strong></li>
        <li>Employment restoration: <strong>${fmtUSD(R.parts.employment)}</strong></li>
        <li>Litigation avoided: <strong>${fmtUSD(R.parts.lawsuits)}</strong></li>
        <li>Transition costs (one-time): <strong>‚àí ${fmtUSD(X.transition_costs_one_time)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${fmtUSD(A.K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;
    drawChart(R);
  }

  document.getElementById('recalc').addEventListener('click', recalc);

  // Scenario sliders
  sCases.addEventListener('input', () => {
    X.cases_avoided = Number(sCases.value);
    lCases.textContent = Number(sCases.value).toLocaleString();
    recalc();
  });
  sTrans.addEventListener('input', () => {
    X.expected_lawsuits = Number(sTrans.value);
    lTrans.textContent = Number(sTrans.value).toLocaleString();
    recalc();
  });

  // Reset to CSV
  btnReset.addEventListener('click', () => {
    Object.assign(X, CSV);
    sCases.value = X.cases_avoided||0; lCases.textContent = Number(sCases.value).toLocaleString();
    sTrans.value = X.expected_lawsuits||0; lTrans.textContent = Number(sTrans.value).toLocaleString();
    document.getElementById('assump-days').value = 5;
    document.getElementById('assump-k').value = 1000000000;
    recalc();
  });

  // Initial calc
  recalc();

  // --- Download Report (CSV) ---
  const btn = document.createElement('button');
  btn.textContent = 'Download Report (CSV)';
  btn.className = 'btn-ghost';
  btn.style.marginTop = '10px';
  document.getElementById('ciri-breakdown').insertAdjacentElement('afterend', btn);

  btn.addEventListener('click', () => {
    const A = { jailDays:Number(document.getElementById('assump-days').value||0),
                K:Number(document.getElementById('assump-k').value||1) };
    // Recompute latest
    const R = compute(X, A);

    const now = new Date().toISOString();
    const lines = [
      ['Generated', now],
      ['Source CSV', src],
      [],
      ['Metric','Value'],
      ['Total Recovery (USD)', R.total],
      ['CIRI (Risk Index)', R.ciri],
      ['CII (Integrity Index)', R.cii],
      ['ROI per Case Avoided', R.roiPerCase],
      ['Direct Case + Fees', R.parts.direct_case],
      ['Detention Savings', R.parts.detention],
      ['Employment Restoration', R.parts.employment],
      ['Litigation Avoided', R.parts.lawsuits],
      ['Transition Costs (‚àí)', X.transition_costs_one_time],
      ['Assumed Jail Days per Case', A.jailDays],
      ['Risk Scaling K', A.K],
      [],
      ['Input Field','CSV Value'],
      ...Object.entries(parsed.obj).map(([k,v]) => [k, v])
    ];

    const csv = lines.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'CIRI_report.csv'; a.click();
    URL.revokeObjectURL(url);
  });
})();
</script>
<!-- ===== /CIRI calculator script ===== -->

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under 
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>

</body>
</html>
