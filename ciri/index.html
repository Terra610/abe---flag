<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CIRI ‚Äî Integrity ROI Engine | A.B.E.</title>
<base href="/abe---flag/">

<style>
:root{
  --bg:#0b0d12;--panel:#141820;--panel2:#0f131a;
  --ink:#e6e6e6;--muted:#9fb3c8;
  --line:rgba(255,255,255,.08);
  --brand:#5ddfff;--accent:#ffa559;--ok:#4bd28f;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
a{color:#80bfff;text-decoration:none}
a:hover{text-decoration:underline}

header{
  padding:20px;
  background:linear-gradient(90deg,#11151c,#0b0d12);
  border-bottom:1px solid var(--line)
}
header .wrap{
  max-width:1000px;margin:0 auto;
  display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
}
.nav{display:flex;flex-wrap:wrap;gap:8px}
.badge{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;border-radius:999px;
  border:1px solid var(--line);font-size:.85rem;color:var(--muted)
}
.badge strong{color:var(--ink)}

main{max-width:1000px;margin:24px auto 40px;padding:0 20px}
.card{
  background:var(--panel);border:1px solid var(--line);
  border-radius:12px;padding:18px 18px 20px;margin-bottom:20px;
  box-shadow:0 0 24px rgba(0,0,0,.35)
}
h1{margin:0 0 4px;font-size:1.55rem}
h2{margin:0 0 10px;color:var(--brand);font-size:1.1rem}
p{margin:.3rem 0 .8rem}
.small{font-size:.85rem;color:var(--muted)}

.grid{
  display:grid;gap:12px;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr))
}

.kpi{
  background:var(--panel2);
  border:1px solid var(--line);
  border-radius:10px;padding:12px
}
.kpi .lbl{font-size:.8rem;color:var(--muted)}
.kpi .val{margin-top:2px;font-weight:700;font-size:1.2rem}

button{
  background:var(--brand);color:#05070a;
  border-radius:7px;border:1px solid transparent;
  padding:.45rem .95rem;font-size:.9rem;font-weight:600;
  cursor:pointer;transition:.15s ease;
}
button:hover{
  background:#82eaff;
  transform:translateY(-1px);
  box-shadow:0 3px 10px rgba(93,223,255,.3)
}
.btn-ghost{
  background:#0d1017;color:var(--accent);
  border-color:var(--accent);
}
.btn-ghost:hover{
  background:rgba(255,165,89,.08);
  box-shadow:0 3px 10px rgba(255,165,89,.3)
}

input[type=file]{
  margin-top:8px;font-size:.85rem;color:var(--muted)
}
.drop-zone{
  margin-top:10px;border:2px dashed var(--brand);
  border-radius:10px;padding:16px;text-align:center;
  font-size:.85rem;color:var(--muted)
}
.drop-zone.dragover{
  border-color:var(--accent);
  background:rgba(255,165,89,.08)
}

table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.82rem}
th,td{padding:7px 8px;border-bottom:1px solid var(--line);text-align:left}
th{background:var(--panel2);color:var(--muted)}
tr:hover td{background:rgba(93,223,255,.04)}

.banner{
  border-radius:10px;padding:10px 12px;margin-top:10px;
  border:1px solid var(--accent);
  background:rgba(255,165,89,.09);
  font-size:.86rem;color:var(--accent)
}
.banner.ok{border-color:var(--ok);background:rgba(75,210,143,.08);color:var(--ok)}

footer{margin:32px 0 20px;text-align:center;font-size:.82rem;color:var(--muted)}
code{font-size:.85em;background:#0f131a;padding:1px 4px;border-radius:4px}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div>
      <a href="/abe---flag/" class="badge">‚Üê Home</a>
      <h1>CIRI ‚Äî Integrity ROI Engine</h1>
      <div class="small">Turns divergence + local inputs into modeled recovery dollars.</div>
    </div>
    <div class="nav">
      <a class="badge" href="cff/index.html"><strong>CFF</strong> Funding Forensics</a>
      <a class="badge" href="cibs/index.html">CIBS</a>
      <a class="badge" href="macro/index.html">Macro</a>
      <a class="badge" href="integration/index.html">Integration</a>
    </div>
  </div>
</header>

<main>

  <!-- Load / Upload -->
  <section class="card">
    <h2>üì• Load Inputs</h2>
    <p class="small">
      You can run CIRI on the repo‚Äôs baseline inputs, or on your own CSV. Everything runs locally in your browser.
    </p>
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:8px">
      <button id="btn-load-repo">Use repo baseline (<code>ciri/inputs.csv</code>)</button>
      <span class="small">or upload your own:</span>
      <input id="file-input" type="file" accept=".csv">
    </div>
    <div id="drop-zone" class="drop-zone">
      Drag & drop a CIRI CSV here (must match the template header).
    </div>
    <div id="source-label" class="small" style="margin-top:8px;color:var(--muted)">Source: not loaded yet.</div>
  </section>

  <!-- KPIs -->
  <section class="card">
    <h2>üìä Recovery Outputs</h2>
    <div class="grid">
      <div class="kpi">
        <div class="lbl">Base Recovery (CIRI only)</div>
        <div class="val" id="k-base-total">‚Äî</div>
        <div class="small">Direct CIRI engine result.</div>
      </div>
      <div class="kpi">
        <div class="lbl">OFF_MISSION from CFF</div>
        <div class="val" id="k-cff-off">‚Äî</div>
        <div class="small">Read from local <code>ABE_CFF_OFF_MISSION_TOTAL</code>.</div>
      </div>
      <div class="kpi">
        <div class="lbl">Total Recovery (CIRI + CFF)</div>
        <div class="val" id="k-total-plus-cff">‚Äî</div>
        <div class="small">What A.B.E. treats as the full recovery pool.</div>
      </div>
      <div class="kpi">
        <div class="lbl">CIRI Index</div>
        <div class="val" id="k-index">‚Äî</div>
        <div class="small"><code>1 - e^{-R_T/K}</code> with K = 2B.</div>
      </div>
      <div class="kpi">
        <div class="lbl">ROI per Case</div>
        <div class="val" id="k-roi">‚Äî</div>
        <div class="small"><code>R_T / max(1, cases_avoided)</code>.</div>
      </div>
    </div>

    <div id="cff-banner" class="banner">
      No CFF OFF_MISSION transfer detected yet. Run the CFF engine and click ‚ÄúSend to CIRI (local only)‚Äù to link funding misuse into this recovery model.
    </div>
  </section>

  <!-- Inputs echo -->
  <section class="card">
    <h2>üßÆ Inputs Snapshot</h2>
    <p class="small">
      This echoes the row from your CIRI CSV so a judge, AG, or watchdog can see exactly what the engine used.
    </p>
    <table id="inputs-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Download -->
  <section class="card">
    <h2>üì• Download Scenario Receipt</h2>
    <p class="small">
      Download a local JSON ‚Äúreceipt‚Äù of this run (inputs + outputs). Nothing is stored on the server ‚Äî this is just for your records or court exhibits.
    </p>
    <button id="btn-receipt" class="btn-ghost">Download CIRI Scenario JSON</button>
  </section>

</main>

<footer>
  A.B.E. CIRI Engine ¬∑ CC BY-NC 4.0 ¬∑ Integrity only ‚Äî never for sale.
</footer>

<script>
// ---------- helpers ----------
const money = n=>{
  const v = Number(n);
  if(!isFinite(v)) return '‚Äî';
  try{
    return new Intl.NumberFormat(undefined,{
      style:'currency',currency:'USD',maximumFractionDigits:0
    }).format(v);
  }catch{
    return '$'+Math.round(v).toLocaleString();
  }
};

function csvToRows(text){
  const rows=[];let i=0,field='',row=[],inQ=false;
  for(;i<text.length;i++){
    const c=text[i];
    if(inQ){
      if(c==='"' && text[i+1]==='"'){ field+='"'; i++; }
      else if(c==='"'){ inQ=false; }
      else field+=c;
    }else{
      if(c==='"'){ inQ=true; }
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n' || c==='\r'){
        if(field!=='' || row.length){ row.push(field); rows.push(row); field=''; row=[]; }
      }else field+=c;
    }
  }
  if(field!==''||row.length){ row.push(field); rows.push(row); }
  return rows;
}

// ---------- CFF localStorage read ----------
function readCff(){
  let off = 0;
  let ctx = null;
  try{
    const raw = localStorage.getItem('ABE_CFF_OFF_MISSION_TOTAL');
    if(raw) off = Number(raw) || 0;
    const meta = localStorage.getItem('ABE_CFF_CONTEXT');
    if(meta) ctx = JSON.parse(meta);
  }catch(_){}
  return {off,ctx};
}

// ---------- core CIRI math ----------
function computeCiri(o){
  const c=o.cases_avoided, C=o.avg_cost_per_case, D=o.jail_days_avoided, J=o.cost_per_jail_day,
        F=o.fees_canceled_total, P=o.policy_corrections, E=o.avg_enforcement_cost_savings,
        H=o.households_restored, M=o.avg_monthly_market_spend, m=o.months_effective,
        pe=o.employment_probability, W=o.avg_monthly_wage, L=o.expected_lawsuits,
        A=o.avg_payout, lam=o.litigation_multiplier, T=o.transition_costs_one_time;

  const direct   = c*C + F;
  const detention= D*J;
  const enforce  = P*E;
  const market   = H*M*m;
  const employ   = (H*pe)*W*m;
  const litig    = L*A*lam;

  const totalBase = direct + detention + enforce + market + employ + litig - T;
  const K = 2_000_000_000;
  const index = 1 - Math.exp(- totalBase / K);
  const roi   = totalBase / Math.max(1,c||1);

  return {totalBase,index,roi};
}

// ---------- UI wires ----------
const sourceLabel = document.getElementById('source-label');
const inputsHead  = document.querySelector('#inputs-table thead');
const inputsBody  = document.querySelector('#inputs-table tbody');

let lastScenario = null; // for receipt

function applyScenarioFromCsv(text, sourceTag){
  const rows = csvToRows(text.trim());
  if(rows.length < 2){
    alert('CSV appears empty. Need at least a header and one data row.');
    return;
  }
  const headers = rows[0].map(h=>h.trim());
  const dataRow = rows[1]; // single-row model

  const o = Object.fromEntries(headers.map((h,i)=>[h, Number(dataRow[i]) ]));
  const {totalBase,index,roi} = computeCiri(o);

  // read CFF
  const {off,ctx} = readCff();
  const totalPlusCff = totalBase + (off||0);

  // KPIs
  document.getElementById('k-base-total').textContent      = money(totalBase);
  document.getElementById('k-cff-off').textContent         = off ? money(off) : '‚Äî';
  document.getElementById('k-total-plus-cff').textContent  = money(totalPlusCff);
  document.getElementById('k-index').textContent           = index.toFixed(2);
  document.getElementById('k-roi').textContent             = money(roi);

  // banner
  const banner = document.getElementById('cff-banner');
  if(off && off>0){
    banner.classList.add('ok');
    banner.innerHTML =
      `CFF OFF_MISSION transfer detected: <strong>${money(off)}</strong> added to this recovery pool.<br>`+
      `<span class="small">Context: ${ctx && ctx.source ? ctx.source+' ¬∑ ' : ''}${ctx && ctx.time ? ctx.time : 'local run'}</span>`;
  }else{
    banner.classList.remove('ok');
    banner.textContent =
      'No CFF OFF_MISSION transfer detected. Run CFF and click ‚ÄúSend to CIRI (local only)‚Äù if you want funding misuse included.';
  }

  // echo inputs
  inputsHead.innerHTML = '<tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr>';
  inputsBody.innerHTML = '<tr>'+dataRow.map(v=>`<td>${v}</td>`).join('')+'</tr>';

  sourceLabel.textContent = 'Source: '+sourceTag;

  lastScenario = {
    source: sourceTag,
    inputs: Object.fromEntries(headers.map((h,i)=>[h,dataRow[i]])),
    outputs:{
      total_base: totalBase,
      cff_off_mission: off||0,
      total_with_cff: totalPlusCff,
      ciri_index: index,
      roi_per_case: roi
    },
    cff_context: ctx || null,
    generated_at: new Date().toISOString()
  };
}

function loadRepo(){
  fetch('ciri/inputs.csv',{cache:'no-store'})
    .then(r=>{
      if(!r.ok) throw new Error('fetch failed');
      return r.text();
    })
    .then(t=>applyScenarioFromCsv(t,'Repo baseline (ciri/inputs.csv)'))
    .catch(()=>alert('Could not load ciri/inputs.csv from repo.'));
}

// ---------- events ----------

// repo button
document.getElementById('btn-load-repo').addEventListener('click',loadRepo);

// file input
document.getElementById('file-input').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  f.text().then(t=>applyScenarioFromCsv(t,`User upload: ${f.name}`));
});

// drag & drop
const dz=document.getElementById('drop-zone');
dz.addEventListener('dragover',e=>{
  e.preventDefault(); dz.classList.add('dragover');
});
dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
dz.addEventListener('drop',e=>{
  e.preventDefault(); dz.classList.remove('dragover');
  const f=e.dataTransfer.files[0]; if(!f) return;
  f.text().then(t=>applyScenarioFromCsv(t,`User drop: ${f.name}`));
});

// receipt download
document.getElementById('btn-receipt').addEventListener('click',()=>{
  if(!lastScenario){
    alert('Run the engine at least once before downloading a receipt.');
    return;
  }
  const blob = new Blob([JSON.stringify(lastScenario,null,2)],{type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = 'ABE_CIRI_SCENARIO_V2.json';
  a.click();
  URL.revokeObjectURL(url);
});

// auto-load repo on first visit for friendliness
loadRepo();
</script>

</body>
</html>
