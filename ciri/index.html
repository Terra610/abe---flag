<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIRI ‚Äì Constitutional Integrity ROI Engine | A.B.E.</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#13161b; --ink:#e0e0e0; --muted:#9aa3ad;
      --edge:rgba(255,255,255,.08); --edge2:rgba(255,255,255,.12);
      --accent:#5ddfff; --accent2:#ffa559;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.65;margin:0}

    header{
      background:linear-gradient(90deg,#11151c,#1b1e25);
      border-bottom:1px solid var(--edge);
      padding:2rem 1rem;
      text-align:center;
      position:relative;
    }
    .home-btn{
      position:absolute;left:1rem;top:1.2rem;
      background:var(--accent);color:#0b0d12;
      padding:.45rem .9rem;border-radius:8px;font-weight:700;
      text-decoration:none;font-size:.9rem;
      transition:all .2s ease-in-out;border:1px solid transparent;
    }
    .home-btn:hover{background:#82eaff;box-shadow:0 0 8px rgba(93,223,255,.7);transform:translateY(-2px)}
    h1{color:var(--accent2);font-size:1.8rem;margin:.1rem 0 .4rem;font-weight:800}
    header p{margin:.25rem 0 0;color:var(--muted)}
    .top-actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin:.9rem 0 0}
    .btn,.badge{display:inline-block;text-decoration:none;font-weight:700;border-radius:8px;transition:all .18s ease-in-out}
    .btn{background:var(--accent);color:#0b0d12;padding:.55rem 1rem;border:1px solid transparent}
    .btn:hover{background:#82eaff;transform:translateY(-2px);box-shadow:0 0 10px rgba(93,223,255,.6)}
    .badge{color:var(--accent);border:1px solid var(--accent);padding:.45rem .7rem;font-size:.9rem}
    .badge:hover{background:rgba(93,223,255,.08);transform:translateY(-2px)}

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05)
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{background:rgba(255,255,255,.07);padding:.25rem .4rem;border-radius:6px;color:#e3e3e3}

    /* CIRI live calculator styles */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .ciri-kpi{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .ciri-grid>div{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
    .ciri-err{color:#f99}
    canvas{max-width:100%}
    .btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}

    /* data health banner (validator writes here) */
    #data-health{border:1px solid #2a3344;border-radius:10px;padding:10px;background:#0e1218;margin:-.4rem 0 1rem;font-size:.9rem}
    #data-health.ok{border-color:#245b3c;background:#0f1713}
    #data-health.warn{border-color:#66501f;background:#17140b}
    #data-health.err{border-color:#6b2a2a;background:#170f10}

    /* source toggle */
    .source-toggle{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-bottom:.6rem}
    .pill{border-radius:999px;border:1px solid #2a3344;padding:.25rem .7rem;font-size:.8rem;color:#9fb0c9}
    .pill strong{color:#eaeef7}
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>
  <!-- Data health banner (validate_ciri.js writes here) -->
  <section id="data-health" aria-live="polite">
    Checking <code>inputs.csv</code>‚Ä¶
  </section>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the
      <em>economic impact of constitutional compliance</em> for their own city or county ‚Äî
      using a single CSV.
    </p>
    <ol>
      <li>Download the example sheet: <a href="./inputs.csv">inputs.csv</a>.</li>
      <li>Replace the example numbers with your local data (keep the header row the same).</li>
      <li>
        Either:
        <ul>
          <li>Commit your updated <code>inputs.csv</code> (for a permanent public model), or</li>
          <li>Use the ‚ÄúUpload CSV‚Äù option below to test it locally without touching the repo.</li>
        </ul>
      </li>
    </ol>
    <p class="ciri-small">
      Browser math and CLI math are aligned. No server required.
    </p>
  </section>

  <!-- Live calculator with built-in + upload modes -->
  <section>
    <h2>‚ö° Live CIRI Calculator</h2>

    <div class="source-toggle">
      <span class="pill">
        Source:
        <label>
          <input type="radio" name="srcMode" value="builtIn" checked>
          use <code>inputs.csv</code>
        </label>
        ¬∑
        <label>
          <input type="radio" name="srcMode" value="upload">
          upload CSV
        </label>
      </span>
      <input type="file" id="file-input" accept=".csv" style="display:none">
      <span id="src-label" class="ciri-small">Using built-in <code>./inputs.csv</code></span>
    </div>

    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi">
          <div class="lbl">Total Recovery (USD)</div>
          <div id="kpi-total" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CIRI ‚Ä¢ Risk Index</div>
          <div id="kpi-ciri" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">CII ‚Ä¢ Integrity Index</div>
          <div id="kpi-cii" class="val">‚Äî</div>
        </div>
        <div class="ciri-kpi">
          <div class="lbl">ROI per Case Avoided</div>
          <div id="kpi-roi" class="val">‚Äî</div>
        </div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">
            Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>
            (Matches CLI; adjust in code if your jurisdiction scale is different.)
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>About CIRI</h2>
    <p>
      CIRI translates lawful governance into measurable economic outcomes.
      Each prevented violation reduces measurable fiscal waste.
      Proper implementation strengthens GDP, restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <!-- A.B.E. Nav Dock + Live KPIs -->
  <section id="abe-navdock" class="ciri-box" aria-label="A.B.E. Navigator">
    <h3 style="margin:0 0 10px;color:#5ddfff">A.B.E. Navigator ¬∑ Live Links</h3>
    <div style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Doctrines</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.8">
          <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">A.B.E. ¬∑ CRRA ¬∑ Rebuild Together (viewer)</a></li>
          <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
          <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Calculators & KPIs</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.9">
          <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Archive & License</div>
        <div class="ciri-small" style="line-height:1.7">
          DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
          License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
          Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- ===== CIRI calculator script (built-in + upload) ===== -->
<script>
(function(){
  const K = 1_000_000_000; // risk scaling (matches CLI)
  function money(n){
    try{ return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
    catch(_){ return "$"+Math.round(n||0).toLocaleString(); }
  }
  function pct(x){ return (x*100).toFixed(1)+"%"; }

  const SERVER_CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];
  let lastSourceLabel = "built-in inputs.csv";
  let parsedCache = null;
  let resultCache = null;

  function parseCSV(txt){
    const lines = txt.trim().split(/\r?\n/).filter(Boolean);
    const head  = (lines.shift()||"").split(",").map(s=>s.trim());
    const row   = (lines.shift()||"").split(",").map(s=>s.trim());
    const obj   = {};
    head.forEach((h,i)=> obj[h]=row[i]);
    return {head,row,obj};
  }
  function num(x){
    const n = Number(String(x||"").replace(/[^0-9.\-]/g,""));
    return isFinite(n)?n:0;
  }

  function compute(d){
    const cases_avoided          = num(d.cases_avoided);
    const avg_cost_per_case      = num(d.avg_cost_per_case);
    const jail_days_avoided      = num(d.jail_days_avoided);
    const cost_per_jail_day      = num(d.cost_per_jail_day);
    const fees_canceled_total    = num(d.fees_canceled_total);
    const licenses_restored      = num(d.licenses_restored);
    const avg_monthly_wage       = num(d.avg_monthly_wage);
    const employment_probability = num(d.employment_probability);
    const months_effective       = num(d.months_effective);
    const expected_lawsuits      = num(d.expected_lawsuits);
    const avg_payout             = num(d.avg_payout);
    const multiplier             = num(d.multiplier);
    const transition_costs       = num(d.transition_costs_one_time);

    const direct_case   = cases_avoided * avg_cost_per_case;
    const detention     = jail_days_avoided * cost_per_jail_day;
    const fees          = fees_canceled_total;
    const employment    = cases_avoided * avg_monthly_wage * employment_probability * (months_effective/12);
    const lawsuits_avo  = expected_lawsuits * avg_payout * multiplier;
    const licensing_val = 0;

    let total = direct_case + detention + fees + employment + lawsuits_avo + licensing_val - transition_costs;
    total = Math.max(0,total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi_per_case = cases_avoided>0 ? total/cases_avoided : 0;

    return {
      total, ciri, cii, roi_per_case,
      parts:{direct_case, detention, fees, employment, lawsuits_avo, licensing_val, transition_costs}
    };
  }

  function render(parsed, R){
    parsedCache = parsed;
    resultCache = R;
    const status = document.getElementById("ciri-status");
    const t = document.getElementById("ciri-inputs");

    t.innerHTML = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>'
      + parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??""}</td></tr>`).join("")
      + '</tbody>';
    status.textContent = `Loaded inputs from ${lastSourceLabel}`;

    document.getElementById("kpi-total").textContent = money(R.total);
    document.getElementById("kpi-ciri").textContent  = pct(R.ciri);
    document.getElementById("kpi-cii").textContent   = pct(R.cii);
    document.getElementById("kpi-roi").textContent   = money(R.roi_per_case);

    const brk = document.getElementById("ciri-breakdown");
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(R.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(R.parts.detention)}</strong></li>
        <li>Fees canceled: <strong>${money(R.parts.fees)}</strong></li>
        <li>Employment & income restoration: <strong>${money(R.parts.employment)}</strong></li>
        <li>Lawsuits avoided (expected √ó payout √ó multiplier): <strong>${money(R.parts.lawsuits_avo)}</strong></li>
        <li>Transition costs (one-time): <strong>‚àí${money(R.parts.transition_costs)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;

    const canvas = document.getElementById("ciri-chart");
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const vals = [
      {k:"Case", v:R.parts.direct_case},
      {k:"Det.", v:R.parts.detention},
      {k:"Fees", v:R.parts.fees},
      {k:"Emp.", v:R.parts.employment},
      {k:"Law.", v:R.parts.lawsuits_avo},
    ];
    const max = Math.max(...vals.map(v=>v.v), 1);
    ctx.clearRect(0,0,W,H);
    const n = vals.length, bw = Math.floor(W/(n*2)), gap = bw, base = H-12;
    vals.forEach((item,i)=>{
      const h = Math.round((item.v/max)*(H-24));
      ctx.fillStyle = "#e0e0e0";
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
      ctx.font = "11px system-ui";
      ctx.fillText(item.k, 10 + i*(bw+gap), H-2);
    });

    // Nav dock CIRI total from this run
    const elDockCiri = document.getElementById('dock-ciri-total');
    if(elDockCiri) elDockCiri.textContent = money(R.total);

    // Nav dock CIBS total from /cibs/auto_budget.csv
    (async () => {
      try{
        const res = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
        const text = await res.text();
        const [h,...rows] = text.trim().split(/\r?\n/);
        const keys = h.split(',').map(s=>s.trim());
        const sum = rows.reduce((acc,line)=>{
          const vals = line.split(',');
          const obj = {};
          keys.forEach((k,i)=>obj[k]= i===0 ? vals[i] : Number(vals[i]));
          const v = Number(obj.value || obj.Value || 0);
          return acc + (isFinite(v)?v:0);
        },0);
        const elDockCibs = document.getElementById('dock-cibs-total');
        if(elDockCibs) elDockCibs.textContent = money(sum);
      }catch(_){
        const elDockCibs = document.getElementById('dock-cibs-total');
        if(elDockCibs) elDockCibs.textContent = '‚Äî';
      }
    })();
  }

  async function loadBuiltIn(){
    const status = document.getElementById("ciri-status");
    status.textContent = "Loading inputs.csv‚Ä¶";
    let csvText = null, src = null;
    for(const u of SERVER_CANDIDATES){
      try{
        const r = await fetch(u,{cache:'no-store'});
        if(r.ok){ csvText = await r.text(); src = u; break; }
      }catch(_){}
    }
    if(!csvText){
      status.innerHTML = '<span class="ciri-err">Could not load inputs.csv</span>';
      return;
    }
    lastSourceLabel = src || "inputs.csv";
    document.getElementById("src-label").textContent = `Using built-in ${lastSourceLabel}`;
    const parsed = parseCSV(csvText);
    const R = compute(parsed.obj);
    render(parsed,R);
  }

  function handleUpload(file){
    const status = document.getElementById("ciri-status");
    if(!file){ return; }
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const text = e.target.result;
        const parsed = parseCSV(text);
        lastSourceLabel = `uploaded file (${file.name})`;
        document.getElementById("src-label").textContent = `Using uploaded CSV: ${file.name}`;
        const R = compute(parsed.obj);
        render(parsed,R);
      }catch(err){
        console.error(err);
        status.innerHTML = '<span class="ciri-err">Could not parse uploaded CSV (check header row and values).</span>';
      }
    };
    reader.readAsText(file);
  }

  function initDownload(){
    const btn = document.getElementById("btn-download");
    if(!btn) return;
    btn.addEventListener("click", ()=>{
      if(!parsedCache || !resultCache) return;
      const now = new Date().toISOString();
      const lines = [
        ["Generated", now],
        ["Source", lastSourceLabel],
        [],
        ["Metric","Value"],
        ["Total Recovery (USD)", resultCache.total],
        ["CIRI (Risk Index)", resultCache.ciri],
        ["CII (Integrity Index)", resultCache.cii],
        ["ROI per Case Avoided", resultCache.roi_per_case],
        ["Direct Case Savings", resultCache.parts.direct_case],
        ["Detention Savings", resultCache.parts.detention],
        ["Fees Canceled", resultCache.parts.fees],
        ["Employment Restoration", resultCache.parts.employment],
        ["Lawsuits Avoided", resultCache.parts.lawsuits_avo],
        ["Transition Costs", resultCache.parts.transition_costs],
        [],
        ["Input Field","CSV Value"],
        ...Object.entries(parsedCache.obj).map(([k,v])=>[k,v])
      ];
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "CIRI_report.csv"; a.click();
      URL.revokeObjectURL(url);
    });
  }

  function initSourceToggle(){
    const radios = document.querySelectorAll('input[name="srcMode"]');
    const fileInput = document.getElementById("file-input");
    radios.forEach(r=>{
      r.addEventListener("change", e=>{
        if(e.target.value === "upload"){
          fileInput.style.display = "inline-block";
          fileInput.focus();
        }else{
          fileInput.style.display = "none";
          loadBuiltIn();
        }
      });
    });
    fileInput.addEventListener("change", e=>{
      const file = e.target.files[0];
      if(file) handleUpload(file);
    });
  }

  // boot
  loadBuiltIn();
  initSourceToggle();
  initDownload();
})();
</script>
<!-- ===== /CIRI calculator script ===== -->

<!-- validator (kept as-is) -->
<script src="./validate_ciri.js"></script>

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under 
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>

</body>
</html>.ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
.ciri-err{color:#f99}
canvas{max-width:100%}
.btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
@media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}
/* validator banner */
#data-health{border:1px solid #2a3344;border-radius:10px;padding:10px;background:#0e1218;margin:-.4rem 0 1rem}
#data-health.ok{border-color:#245b3c;background:#0f1713}
#data-health.warn{border-color:#66501f;background:#17140b}
#data-health.err{border-color:#6b2a2a;background:#170f10}
</style>
</head>
<body>
<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>
  <!-- Data health banner (validator writes here) -->
  <section id="data-health" aria-live="polite">Checking inputs.csv‚Ä¶</section>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>The <strong>CIRI</strong> engine lets anyone measure the <em>economic impact of constitutional compliance</em> for their own city or county ‚Äî using a single CSV.</p>
    <ol>
      <li>Open <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Optional CLI run (writes CIBS budget):<br><code>python3 ciri/calculate.py</code></li>
      <li>View results below and/or in CIBS after running the CLI.</li>
    </ol>
    <p class="ciri-small">Browser math and CLI math are aligned. No server required.</p>
  </section>

  <section>
    <h2>‚ö° Live CIRI Calculator (reads <code>./inputs.csv</code>)</h2>
    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi"><div class="lbl">Total Recovery (USD)</div><div id="kpi-total" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CIRI ‚Ä¢ Risk Index</div><div id="kpi-ciri" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CII ‚Ä¢ Integrity Index</div><div id="kpi-cii" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">ROI per Case Avoided</div><div id="kpi-roi" class="val">‚Äî</div></div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>(Matches CLI; adjust in code if your jurisdiction scale is different.)</div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>About CIRI</h2>
    <p>CIRI translates lawful governance into measurable economic outcomes. Each prevented violation reduces measurable fiscal waste. Proper implementation strengthens GDP, restores public trust, and lowers state dependency.</p>
    <ul><li><a href="./inputs.csv">Download example input sheet</a></li></ul>
  </section>
</main>

<script>
(function(){
  const K = 1_000_000_000;
  const money = n => { try{ return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }catch(_){ return "$"+Math.round(n).toLocaleString(); } };
  const pct   = x => (x*100).toFixed(1)+"%";

  const CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];
  let csvText=null, src=null;

  function parseCSV(txt){ const lines=txt.trim().split(/\r?\n/).filter(Boolean); const head=(lines.shift()||"").split(",").map(s=>s.trim()); const row=(lines.shift()||"").split(",").map(s=>s.trim()); const obj={}; head.forEach((h,i)=>obj[h]=row[i]); return {head,row,obj}; }
  const num = x => { const n = Number(String(x||"").replace(/[^0-9.\-]/g,"")); return isFinite(n)?n:0; };

  function compute(d){
    const c=num(d.cases_avoided), C=num(d.avg_cost_per_case), D=num(d.jail_days_avoided), J=num(d.cost_per_jail_day),
          F=num(d.fees_canceled_total), H=num(d.licenses_restored)||0, // legacy field ok
          pe=num(d.employment_probability), W=num(d.avg_monthly_wage), m=num(d.months_effective),
          L=num(d.expected_lawsuits), A=num(d.avg_payout), M=num(d.multiplier)||1,
          T=num(d.transition_costs_one_time);

    const direct_case = c*C + F;
    const detention   = D*J;
    const employment  = c*pe*W*(m/12);
    const lawsuits_avo= L*A*M;
    const licensing   = 0;

    let total = direct_case + detention + employment + lawsuits_avo + licensing - T;
    total = Math.max(0,total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi  = c>0 ? total/c : 0;

    return { total, ciri, cii, roi, parts:{direct_case,detention,employment,lawsuits_avo,licensing,transition:T} };
  }

  function drawBars(canvas, values){
    const ctx=canvas.getContext("2d"), W=canvas.width, H=canvas.height, max=Math.max(...values.map(v=>v.v),1);
    ctx.clearRect(0,0,W,H); const n=values.length, bw=Math.floor(W/(n*2)), gap=bw, base=H-12;
    values.forEach((t,i)=>{ const h=Math.round((t.v/max)*(H-24)); ctx.fillStyle="#e0e0e0"; ctx.fillRect(10+i*(bw+gap), base-h, bw, h); ctx.font="11px system-ui"; ctx.fillText(t.k,10+i*(bw+gap), H-2); });
  }

  async function boot(){
    for(const u of CANDIDATES){ try{ const r=await fetch(u,{cache:"no-store"}); if(r.ok){ csvText=await r.text(); src=u; break; } }catch{} }
    const status = document.getElementById("ciri-status");
    if(!csvText){ status.innerHTML='<span class="ciri-err">Could not load inputs.csv</span>'; return; }
    status.textContent = `Loaded inputs from ${src}`;

    const parsed=parseCSV(csvText);
    const t=document.getElementById("ciri-inputs");
    t.innerHTML='<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>'+parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??""}</td></tr>`).join("")+'</tbody>';

    const R=compute(parsed.obj);
    document.getElementById("kpi-total").textContent=money(R.total);
    document.getElementById("kpi-ciri").textContent =pct(R.ciri);
    document.getElementById("kpi-cii").textContent  =pct(R.cii);
    document.getElementById("kpi-roi").textContent  =money(R.roi);

    const brk=document.getElementById("ciri-breakdown");
    brk.innerHTML=`<div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(R.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(R.parts.detention)}</strong></li>
        <li>Employment & income restoration: <strong>${money(R.parts.employment)}</strong></li>
        <li>Lawsuits avoided: <strong>${money(R.parts.lawsuits_avo)}</strong></li>
        <li>Transition costs: <strong>‚àí${money(R.parts.transition)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>`;

    drawBars(document.getElementById("ciri-chart"),[
      {k:"Case",v:R.parts.direct_case},
      {k:"Det.",v:R.parts.detention},
      {k:"Emp.",v:R.parts.employment},
      {k:"Law.",v:R.parts.lawsuits_avo}
    ]);

    document.getElementById("btn-download").addEventListener("click",()=>{
      const now=new Date().toISOString();
      const lines=[["Generated",now],["Source CSV",src],[],["Metric","Value"],["Total Recovery (USD)",R.total],["CIRI",R.ciri],["CII",R.cii],["ROI per Case",R.roi],["Direct Case",R.parts.direct_case],["Detention",R.parts.detention],["Employment",R.parts.employment],["Lawsuits Avoided",R.parts.lawsuits_avo],["Transition Costs",-R.parts.transition],[],["Input Field","CSV Value"],...Object.entries(parsed.obj).map(([k,v])=>[k,v])];
      const csv=lines.map(r=>r.join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="CIRI_report.csv"; a.click(); URL.revokeObjectURL(url);
    });
  }
  boot();
})();
</script>

<!-- validator (new) -->
<script src="./validate_ciri.js"></script>

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">CC BY-NC 4.0</a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>
</body>
</html>    .badge:hover{background:rgba(93,223,255,.08);transform:translateY(-2px)}

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05)
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{background:rgba(255,255,255,.07);padding:.25rem .4rem;border-radius:6px;color:#e3e3e3}

    /* ===== CIRI live calculator styles ===== */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .ciri-kpi{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .ciri-grid>div{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
    .ciri-err{color:#f99}
    canvas{max-width:100%}
    .btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the <em>economic impact of constitutional compliance</em>
      for their own city or county ‚Äî using a single CSV.
    </p>

    <ol>
      <li>Open <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Optional CLI run (writes CIBS budget):<br>
        <code>python3 ciri/calculate.py</code>
      </li>
      <li>View results below and/or in CIBS after running the CLI.</li>
    </ol>

    <p class="ciri-small">
      Browser math and CLI math are aligned. No server required.
    </p>
  </section>

  <!-- ===== LIVE BROWSER CALCULATOR (reads ./inputs.csv) ===== -->
  <section>
    <h2>‚ö° Live CIRI Calculator (reads <code>./inputs.csv</code>)</h2>
    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi"><div class="lbl">Total Recovery (USD)</div><div id="kpi-total" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CIRI ‚Ä¢ Risk Index</div><div id="kpi-ciri" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CII ‚Ä¢ Integrity Index</div><div id="kpi-cii" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">ROI per Case Avoided</div><div id="kpi-roi" class="val">‚Äî</div></div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">
            Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>
            (Matches CLI; adjust in code if your jurisdiction scale is different.)
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== /LIVE BROWSER CALCULATOR ===== -->

  <section>
    <h2>About CIRI</h2>
    <p>
      CIRI translates lawful governance into measurable economic outcomes. Each prevented violation reduces
      measurable fiscal waste. Proper implementation strengthens GDP, restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ A.B.E. Nav Dock + Live KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section id="abe-navdock" class="ciri-box" aria-label="A.B.E. Navigator">
    <h3 style="margin:0 0 10px;color:#5ddfff">A.B.E. Navigator ¬∑ Live Links</h3>
    <div style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Doctrines</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.8">
          <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">A.B.E. ¬∑ CRRA ¬∑ Rebuild Together (viewer)</a></li>
          <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
          <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Calculators & KPIs</div>
        <ul class="ciri-small" style="list-style:none;padding:0;margin:0;line-height:1.9">
          <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" style="opacity:.85">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
        </ul>
      </div>

      <div style="background:#151922;border:1px solid #232a36;border-radius:10px;padding:14px">
        <div style="font-weight:600;margin-bottom:8px">Archive & License</div>
        <div class="ciri-small" style="line-height:1.7">
          DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
          License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
          Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
        </div>
      </div>
    </div>
  </section>
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ End Nav Dock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

</main>

<!-- ===== CIRI calculator script (aligned to your CSV headers) ===== -->
<script>
(function(){
  const K = 1_000_000_000; // risk scaling (matches CLI)
  function money(n){ try{ return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }catch(_){ return "$"+Math.round(n).toLocaleString(); } }
  function pct(x){ return (x*100).toFixed(1)+"%"; }

  // 1) Load ./inputs.csv (try relative then absolute)
  const CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];
  let csvText=null, src=null;

  function parseCSV(txt){
    const lines = txt.trim().split(/\r?\n/).filter(Boolean);
    const head  = (lines.shift()||"").split(",").map(s=>s.trim());
    const row   = (lines.shift()||"").split(",").map(s=>s.trim());
    const obj   = {};
    head.forEach((h,i)=> obj[h]=row[i]);
    return {head,row,obj};
  }

  function num(x){ const n = Number(String(x||"").replace(/[^0-9.\-]/g,"")); return isFinite(n)?n:0; }

  function compute(d){
    const cases_avoided          = num(d.cases_avoided);
    const avg_cost_per_case      = num(d.avg_cost_per_case);
    const jail_days_avoided      = num(d.jail_days_avoided);
    const cost_per_jail_day      = num(d.cost_per_jail_day);
    const fees_canceled_total    = num(d.fees_canceled_total);
    const licenses_restored      = num(d.licenses_restored);
    const avg_monthly_wage       = num(d.avg_monthly_wage);
    const employment_probability = num(d.employment_probability);
    const months_effective       = num(d.months_effective);
    const expected_lawsuits      = num(d.expected_lawsuits);
    const avg_payout             = num(d.avg_payout);
    const multiplier             = num(d.multiplier);
    const transition_costs       = num(d.transition_costs_one_time);

    const direct_case   = cases_avoided * avg_cost_per_case;
    const detention     = jail_days_avoided * cost_per_jail_day;
    const fees          = fees_canceled_total;
    const employment    = cases_avoided * avg_monthly_wage * employment_probability * (months_effective/12);
    const lawsuits_avo  = expected_lawsuits * avg_payout * multiplier;

    const licensing_val = 0;

    let total = direct_case + detention + fees + employment + lawsuits_avo + licensing_val - transition_costs;
    total = Math.max(0,total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi_per_case = cases_avoided>0 ? total/cases_avoided : 0;

    return { total, ciri, cii, roi_per_case, parts:{direct_case, detention, fees, employment, lawsuits_avo, licensing_val, transition_costs} };
  }

  function drawBars(canvas, values){
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const vals = values;
    const max = Math.max(...vals.map(v=>v.v), 1);
    ctx.clearRect(0,0,W,H);
    const n = vals.length, bw = Math.floor(W/(n*2)), gap = bw;
    const base = H - 12;
    vals.forEach((item, i)=>{
      const h = Math.round((item.v/max)*(H-24));
      ctx.fillStyle = "#e0e0e0";
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
      ctx.font = "11px system-ui";
      ctx.fillText(item.k, 10 + i*(bw+gap), H-2);
    });
  }

  async function boot(){
    // Load CIRI inputs
    for(const u of CANDIDATES){
      try{
        const r = await fetch(u,{cache:"no-store"});
        if(r.ok){ csvText = await r.text(); src=u; break; }
      }catch(_){}
    }
    const status = document.getElementById("ciri-status");
    if(!csvText){ status.innerHTML = '<span class="ciri-err">Could not load inputs.csv</span>'; return; }
    status.textContent = `Loaded inputs from ${src}`;

    const parsed = parseCSV(csvText);

    // Render inputs table
    const t = document.getElementById("ciri-inputs");
    t.innerHTML = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>'
      + parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??""}</td></tr>`).join("")
      + '</tbody>';

    // Compute results
    const R = compute(parsed.obj);

    // KPIs
    document.getElementById("kpi-total").textContent = money(R.total);
    document.getElementById("kpi-ciri").textContent  = pct(R.ciri);
    document.getElementById("kpi-cii").textContent   = pct(R.cii);
    document.getElementById("kpi-roi").textContent   = money(R.roi_per_case);

    // Breakdown
    const brk = document.getElementById("ciri-breakdown");
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(R.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(R.parts.detention)}</strong></li>
        <li>Fees canceled: <strong>${money(R.parts.fees)}</strong></li>
        <li>Employment & income restoration: <strong>${money(R.parts.employment)}</strong></li>
        <li>Lawsuits avoided (expected √ó payout √ó multiplier): <strong>${money(R.parts.lawsuits_avo)}</strong></li>
        <li>Transition costs (one-time): <strong>‚àí${money(R.parts.transition_costs)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;

    // Chart
    const bars = [
      {k:"Case", v:R.parts.direct_case},
      {k:"Det.", v:R.parts.detention},
      {k:"Fees", v:R.parts.fees},
      {k:"Emp.", v:R.parts.employment},
      {k:"Law.", v:R.parts.lawsuits_avo},
    ];
    drawBars(document.getElementById("ciri-chart"), bars);

    // ‚îÄ‚îÄ Nav Dock KPIs: CIRI total from this page
    const elDockCiri = document.getElementById('dock-ciri-total');
    if(elDockCiri) elDockCiri.textContent = money(R.total);

    // ‚îÄ‚îÄ Nav Dock KPIs: CIBS total from /cibs/auto_budget.csv
    try{
      const res = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
      const text = await res.text();
      const [h,...rows] = text.trim().split(/\r?\n/);
      const keys = h.split(',').map(s=>s.trim());
      const sum = rows.reduce((acc, line)=>{
        const vals = line.split(',');
        const obj = {};
        keys.forEach((k,i)=>obj[k]= i===0 ? vals[i] : Number(vals[i]));
        const v = Number(obj.value || obj.Value || 0);
        return acc + (isFinite(v)? v : 0);
      },0);
      const elDockCibs = document.getElementById('dock-cibs-total');
      if(elDockCibs) elDockCibs.textContent = money(sum);
    }catch(_){
      const elDockCibs = document.getElementById('dock-cibs-total');
      if(elDockCibs) elDockCibs.textContent = '‚Äî';
    }

    // Download report
    document.getElementById("btn-download").addEventListener("click", ()=>{
      const now = new Date().toISOString();
      const lines = [
        ["Generated", now],
        ["Source CSV", src],
        [],
        ["Metric","Value"],
        ["Total Recovery (USD)", R.total],
        ["CIRI (Risk Index)", R.ciri],
        ["CII (Integrity Index)", R.cii],
        ["ROI per Case Avoided", R.roi_per_case],
        ["Direct Case Savings", R.parts.direct_case],
        ["Detention Savings", R.parts.detention],
        ["Fees Canceled", R.parts.fees],
        ["Employment Restoration", R.parts.employment],
        ["Lawsuits Avoided", R.parts.lawsuits_avo],
        ["Transition Costs", R.parts.transition_costs],
        [],
        ["Input Field","CSV Value"],
        ...Object.entries(parsed.obj).map(([k,v])=>[k,v])
      ];
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "CIRI_report.csv"; a.click();
      URL.revokeObjectURL(url);
    });
  }

  boot();
})();
</script>
<!-- ===== /CIRI calculator script ===== -->

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under 
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>

</body>
</html>
