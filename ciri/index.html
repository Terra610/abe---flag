<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIRI ‚Äì Constitutional Integrity ROI Engine | A.B.E.</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#13161b; --ink:#e0e0e0; --muted:#9aa3ad;
      --edge:rgba(255,255,255,.08); --edge2:rgba(255,255,255,.12);
      --accent:#5ddfff; --accent2:#ffa559;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.65;margin:0}

    header{
      background:linear-gradient(90deg,#11151c,#1b1e25);
      border-bottom:1px solid var(--edge);
      padding:2rem 1rem;
      text-align:center;
      position:relative
    }
    .home-btn{
      position:absolute;left:1rem;top:1.2rem;
      background:var(--accent);color:#0b0d12;
      padding:.45rem .9rem;border-radius:8px;font-weight:700;text-decoration:none;font-size:.9rem;
      transition:all .2s ease-in-out;border:1px solid transparent
    }
    .home-btn:hover{background:#82eaff;box-shadow:0 0 8px rgba(93,223,255,.7);transform:translateY(-2px)}
    h1{color:var(--accent2);font-size:1.8rem;margin:.1rem 0 .4rem;font-weight:800}
    header p{margin:.25rem 0 0;color:var(--muted)}
    .top-actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin:.9rem 0 0}
    .btn,.badge{display:inline-block;text-decoration:none;font-weight:700;border-radius:8px;transition:all .18s ease-in-out}
    .btn{background:var(--accent);color:#0b0d12;padding:.55rem 1rem;border:1px solid transparent}
    .btn:hover{background:#82eaff;transform:translateY(-2px);box-shadow:0 0 10px rgba(93,223,255,.6)}
    .badge{color:var(--accent);border:1px solid var(--accent);padding:.45rem .7rem;font-size:.9rem}
    .badge:hover{background:rgba(93,223,255,.08);transform:translateY(-2px)}

    main{max-width:1000px;margin:2rem auto 3.5rem;padding:0 1rem}
    section{
      background:rgba(255,255,255,.03);border:1px solid var(--edge);
      border-radius:12px;padding:1.2rem 1.4rem;margin-bottom:1.4rem;
      box-shadow:0 0 12px rgba(93,223,255,.05)
    }
    section:hover{box-shadow:0 0 16px rgba(93,223,255,.12)}
    h2{color:var(--accent2);font-size:1.2rem;margin:.2rem 0 .7rem}
    a{color:#80bfff} a:hover{text-decoration:underline}
    pre,code{background:rgba(255,255,255,.07);padding:.25rem .4rem;border-radius:6px;color:#e3e3e3}

    /* ===== CIRI live calculator styles ===== */
    .ciri-box{background:#111;border:1px solid #222;border-radius:10px;padding:16px;margin:20px 0}
    .ciri-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .ciri-kpi{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-kpi .lbl{color:#9fb0c9;font-size:12px}
    .ciri-kpi .val{font:800 22px/1 system-ui;margin-top:4px}
    .ciri-small{font-size:12px;color:#9fb0c9}
    .ciri-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .ciri-grid>div{background:#151922;border:1px solid #232a36;border-radius:10px;padding:12px}
    .ciri-table{width:100%;border-collapse:collapse}
    .ciri-table th,.ciri-table td{padding:6px;border-bottom:1px solid #232a36;text-align:left}
    .ciri-err{color:#f99}
    canvas{max-width:100%}
    .btn-ghost{padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent)}
    @media (max-width:800px){.ciri-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<header>
  <a href="/abe---flag/index.html" class="home-btn">‚Üê Return to Home</a>
  <h1>CIRI (Constitutional Integrity ROI Engine)</h1>
  <p>The A.B.E. model for quantifying the financial impact of constitutional compliance.</p>
  <div class="top-actions">
    <a class="btn" href="/abe---flag/doctrine/index.html">üìú Doctrine Library</a>
    <a class="badge" href="/abe---flag/cibs/index.html">üìä CIBS</a>
    <a class="badge" href="/abe---flag/system/index.html">üó∫ System Map</a>
    <a class="badge" href="/abe---flag/integration/index.html">üîó Integration</a>
  </div>
</header>

<main>

  <section>
    <h2>üßÆ Run the CIRI Calculator</h2>
    <p>
      The <strong>CIRI</strong> engine lets anyone measure the <em>economic impact of constitutional compliance</em>
      for their own city or county ‚Äî using a single CSV.
    </p>

    <ol>
      <li>Open <a href="./inputs.csv">inputs.csv</a> and replace the example numbers with your local data.</li>
      <li>Optional CLI run (writes CIBS budget):<br>
        <code>python3 ciri/calculate.py</code>
      </li>
      <li>View results below and/or in CIBS after running the CLI.</li>
    </ol>

    <p class="ciri-small">
      Browser math and CLI math are aligned. No server required.
    </p>
  </section>

  <!-- ===== LIVE BROWSER CALCULATOR (reads ./inputs.csv) ===== -->
  <section>
    <h2>‚ö° Live CIRI Calculator (reads <code>./inputs.csv</code>)</h2>
    <div id="ciri-app" class="ciri-box">
      <div class="ciri-kpis">
        <div class="ciri-kpi"><div class="lbl">Total Recovery (USD)</div><div id="kpi-total" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CIRI ‚Ä¢ Risk Index</div><div id="kpi-ciri" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">CII ‚Ä¢ Integrity Index</div><div id="kpi-cii" class="val">‚Äî</div></div>
        <div class="ciri-kpi"><div class="lbl">ROI per Case Avoided</div><div id="kpi-roi" class="val">‚Äî</div></div>
      </div>

      <div class="ciri-grid">
        <div>
          <div style="font-weight:700;margin-bottom:8px">Inputs</div>
          <table id="ciri-inputs" class="ciri-table" aria-label="CIRI inputs table"></table>
          <div id="ciri-status" class="ciri-small" style="margin-top:8px">Loading inputs‚Ä¶</div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:8px">Assumptions</div>
          <div class="ciri-small">
            Risk scaling K = <code id="lbl-k">$1,000,000,000</code><br>
            (Matches CLI; adjust in code if your jurisdiction scale is different.)
          </div>
          <div id="ciri-breakdown" class="ciri-small" style="margin-top:10px"></div>
          <canvas id="ciri-chart" height="120" aria-label="Breakdown chart"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="btn-download" class="btn-ghost">Download Report (CSV)</button>
            <a class="btn-ghost" href="/abe---flag/cibs/index.html">Open CIBS (Budget)</a>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- ===== /LIVE BROWSER CALCULATOR ===== -->

  <section>
    <h2>About CIRI</h2>
    <p>
      CIRI translates lawful governance into measurable economic outcomes. Each prevented violation reduces
      measurable fiscal waste. Proper implementation strengthens GDP, restores public trust, and lowers state dependency.
    </p>
    <ul>
      <li><a href="./inputs.csv">Download example input sheet</a></li>
    </ul>
  </section>

</main>

<!-- ===== CIRI calculator script (aligned to your CSV headers) ===== -->
<script>
(function(){
  const K = 1_000_000_000; // risk scaling (matches CLI)
  function money(n){ try{ return n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }catch(_){ return "$"+Math.round(n).toLocaleString(); } }
  function pct(x){ return (x*100).toFixed(1)+"%"; }

  // 1) Load ./inputs.csv (try relative then absolute)
  const CANDIDATES = ["./inputs.csv","/abe---flag/ciri/inputs.csv"];
  let csvText=null, src=null;

  function parseCSV(txt){
    const lines = txt.trim().split(/\r?\n/).filter(Boolean);
    const head  = (lines.shift()||"").split(",").map(s=>s.trim());
    const row   = (lines.shift()||"").split(",").map(s=>s.trim());
    const obj   = {};
    head.forEach((h,i)=> obj[h]=row[i]);
    return {head,row,obj};
  }

  function num(x){ const n = Number(String(x||"").replace(/[^0-9.\-]/g,"")); return isFinite(n)?n:0; }

  function compute(d){
    // CSV columns (exactly your file):
    // cases_avoided,avg_cost_per_case,jail_days_avoided,cost_per_jail_day,fees_canceled_total,
    // licenses_restored,avg_monthly_wage,employment_probability,months_effective,
    // expected_lawsuits,avg_payout,multiplier,transition_costs_one_time
    const cases_avoided          = num(d.cases_avoided);
    const avg_cost_per_case      = num(d.avg_cost_per_case);
    const jail_days_avoided      = num(d.jail_days_avoided);
    const cost_per_jail_day      = num(d.cost_per_jail_day);
    const fees_canceled_total    = num(d.fees_canceled_total);
    const licenses_restored      = num(d.licenses_restored);
    const avg_monthly_wage       = num(d.avg_monthly_wage);
    const employment_probability = num(d.employment_probability);
    const months_effective       = num(d.months_effective);
    const expected_lawsuits      = num(d.expected_lawsuits);
    const avg_payout             = num(d.avg_payout);
    const multiplier             = num(d.multiplier);
    const transition_costs       = num(d.transition_costs_one_time);

    const direct_case   = cases_avoided * avg_cost_per_case;
    const detention     = jail_days_avoided * cost_per_jail_day;
    const fees          = fees_canceled_total;
    const employment    = cases_avoided * avg_monthly_wage * employment_probability * (months_effective/12);
    const lawsuits_avo  = expected_lawsuits * avg_payout * multiplier;

    // If you later price mobility, plug licenses_restored * price here:
    const licensing_val = 0;

    let total = direct_case + detention + fees + employment + lawsuits_avo + licensing_val - transition_costs;
    total = Math.max(0,total);

    const ciri = 1 - Math.exp(- total / Math.max(1,K));
    const cii  = 1 - ciri;
    const roi_per_case = cases_avoided>0 ? total/cases_avoided : 0;

    return { total, ciri, cii, roi_per_case, parts:{direct_case, detention, fees, employment, lawsuits_avo, licensing_val, transition_costs} };
  }

  function drawBars(canvas, values){
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;
    const vals = values;
    const max = Math.max(...vals.map(v=>v.v), 1);
    ctx.clearRect(0,0,W,H);
    const n = vals.length, bw = Math.floor(W/(n*2)), gap = bw;
    const base = H - 12;
    vals.forEach((item, i)=>{
      const h = Math.round((item.v/max)*(H-24));
      ctx.fillStyle = "#e0e0e0";
      ctx.fillRect(10 + i*(bw+gap), base-h, bw, h);
      ctx.font = "11px system-ui";
      ctx.fillText(item.k, 10 + i*(bw+gap), H-2);
    });
  }

  async function boot(){
    for(const u of CANDIDATES){
      try{
        const r = await fetch(u,{cache:"no-store"});
        if(r.ok){ csvText = await r.text(); src=u; break; }
      }catch(_){}
    }
    const status = document.getElementById("ciri-status");
    if(!csvText){ status.innerHTML = '<span class="ciri-err">Could not load inputs.csv</span>'; return; }
    status.textContent = `Loaded inputs from ${src}`;

    const parsed = parseCSV(csvText);

    // Render inputs table
    const t = document.getElementById("ciri-inputs");
    t.innerHTML = '<thead><tr><th>Field</th><th>Value</th></tr></thead><tbody>'
      + parsed.head.map((h,i)=>`<tr><td>${h}</td><td>${parsed.row[i]??""}</td></tr>`).join("")
      + '</tbody>';

    // Compute results
    const R = compute(parsed.obj);

    // KPIs
    document.getElementById("kpi-total").textContent = money(R.total);
    document.getElementById("kpi-ciri").textContent  = pct(R.ciri);
    document.getElementById("kpi-cii").textContent   = pct(R.cii);
    document.getElementById("kpi-roi").textContent   = money(R.roi_per_case);

    // Breakdown
    const brk = document.getElementById("ciri-breakdown");
    brk.innerHTML = `
      <div><strong>Breakdown</strong></div>
      <ul>
        <li>Direct case savings: <strong>${money(R.parts.direct_case)}</strong></li>
        <li>Detention savings: <strong>${money(R.parts.detention)}</strong></li>
        <li>Fees canceled: <strong>${money(R.parts.fees)}</strong></li>
        <li>Employment & income restoration: <strong>${money(R.parts.employment)}</strong></li>
        <li>Lawsuits avoided (expected √ó payout √ó multiplier): <strong>${money(R.parts.lawsuits_avo)}</strong></li>
        <li>Transition costs (one-time): <strong>‚àí${money(R.parts.transition_costs)}</strong></li>
      </ul>
      <div class="ciri-small">Risk scaling K = ${money(K)} ‚Ä¢ CIRI = 1 ‚àí exp(‚àíTotal/K)</div>
    `;

    // Chart
    const bars = [
      {k:"Case", v:R.parts.direct_case},
      {k:"Det.", v:R.parts.detention},
      {k:"Fees", v:R.parts.fees},
      {k:"Emp.", v:R.parts.employment},
      {k:"Law.", v:R.parts.lawsuits_avo},
    ];
    drawBars(document.getElementById("ciri-chart"), bars);

    // Download report
    document.getElementById("btn-download").addEventListener("click", ()=>{
      const now = new Date().toISOString();
      const lines = [
        ["Generated", now],
        ["Source CSV", src],
        [],
        ["Metric","Value"],
        ["Total Recovery (USD)", R.total],
        ["CIRI (Risk Index)", R.ciri],
        ["CII (Integrity Index)", R.cii],
        ["ROI per Case Avoided", R.roi_per_case],
        ["Direct Case Savings", R.parts.direct_case],
        ["Detention Savings", R.parts.detention],
        ["Fees Canceled", R.parts.fees],
        ["Employment Restoration", R.parts.employment],
        ["Lawsuits Avoided", R.parts.lawsuits_avo],
        ["Transition Costs", R.parts.transition_costs],
        [],
        ["Input Field","CSV Value"],
        ...Object.entries(parsed.obj).map(([k,v])=>[k,v])
      ];
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "CIRI_report.csv"; a.click();
      URL.revokeObjectURL(url);
    });
  }

  boot();
})();
</script>
<!-- ===== /CIRI calculator script ===== -->

<footer style="margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem">
  ¬© 2025 Terra Dawn Shouse ‚Äî American Butterfly Effect (A.B.E.)<br>
  Licensed under 
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    Creative Commons Attribution‚ÄìNonCommercial 4.0 International (CC BY-NC 4.0)
  </a><br>
  <em>Integrity only ‚Äî never for sale.</em>
</footer>

</body>
</html>
