<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CII ‚Äî Community Investment Interface</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#141820; --panel2:#0f131a;
      --ink:#e6e6e6; --muted:#9fb3c8; --line:rgba(255,255,255,.08);
      --brand:#5ddfff; --accent:#fff750; --ok:#4bd28f; --warn:#ffa559;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;z-index:2;background:linear-gradient(90deg,#11151c,#1b1e25);border-bottom:1px solid var(--line);padding:.85rem 1rem}
    header .wrap{max-width:1040px;margin:0 auto;display:flex;align-items:center;gap:1rem}
    a{color:#80bfff;text-decoration:none}
    a:hover{text-decoration:underline}
    .badge{margin-left:auto;font-size:.8rem;color:#9fb3c8}
    .back{font-size:.9rem}
    main{max-width:1040px;margin:1.25rem auto 4rem;padding:0 1rem}
    h1{color:var(--brand);margin:.2rem 0 .4rem;font-size:1.6rem}
    p.lead{color:#c8d2df;margin:.25rem 0 1rem}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin:16px 0 22px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .card h3{margin:0 0 .35rem;font-size:.98rem;color:#dfe9f6}
    .kv{display:flex;gap:8px;align-items:baseline}
    .kv .label{color:var(--muted);font-size:.85rem}
    .kv .value{font-weight:600}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    section{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:16px;margin-top:18px}
    section h2{margin:0 0 .6rem;color:#dfe9f6;font-size:1.05rem}
    .actions{display:flex;flex-wrap:wrap;gap:.6rem;margin:.35rem 0 .25rem}
    .btn{display:inline-block;background:#1b2230;border:1px solid var(--line);padding:.5rem .7rem;border-radius:9px;font-size:.9rem}
    .btn:hover{background:#20283a}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    thead th{background:#18202b;color:#cfe6ff;font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--line)}
    tbody td{padding:10px;border-bottom:1px solid var(--line)}
    tbody tr:last-child td{border-bottom:none}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .hint{color:#9fb3c8;font-size:.9rem;margin-top:.5rem}
    footer{margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem}
    @media (max-width:760px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="back" href="../index.html">‚Üê Return to Home</a>
      <div class="badge">ABE Patch Active</div>
    </div>
  </header>

  <main>
    <h1>üèóÔ∏è CII ‚Äî Community Investment Interface</h1>
    <p class="lead">
      CII is the ‚Äúlast-mile‚Äù interface that turns verified recovery value into
      <strong>live, trackable projects</strong>: housing, clinics, food systems, broadband,
      transit, and workforce pipelines. It consumes <em>CIRI</em> results, aligns with
      <em>CIBS</em> budgets, and publishes an auditable portfolio.
    </p>

    <!-- Status cards -->
    <div class="cards" id="status">
      <div class="card">
        <h3>Model</h3>
        <div class="kv">
          <span class="label"><a href="model.json">/cii/model.json</a></span>
          <span class="value" id="model-status">Checking‚Ä¶</span>
        </div>
      </div>
      <div class="card">
        <h3>Portfolio</h3>
        <div class="kv">
          <span class="label"><a href="portfolio.csv">/cii/portfolio.csv</a></span>
          <span class="value" id="port-status">Checking‚Ä¶</span>
        </div>
      </div>
      <div class="card">
        <h3>Integration</h3>
        <div class="kv">
          <span class="label">Ready to publish to</span>
          <span class="value"><a href="../integration/index.html">Integration Layer</a></span>
        </div>
      </div>
    </div>

    <!-- Quick links -->
    <section>
      <h2>üîó Links</h2>
      <div class="actions">
        <a class="btn" href="../ciri/index.html">CIRI ‚Äî Risk & Recovery</a>
        <a class="btn" href="../cibs/index.html">CIBS ‚Äî Budget System</a>
        <a class="btn" href="../macro/index.html">Macro Cascade</a>
        <a class="btn" href="../doctrine/index.html">Doctrines</a>
        <a class="btn" href="model.json">Open model.json</a>
        <a class="btn" href="portfolio.csv">Open portfolio.csv</a>
      </div>
      <p class="hint">
        Don‚Äôt have files yet? Create a <code>model.json</code> describing project categories and multipliers,
        and a <code>portfolio.csv</code> listing projects (<code>name,category,cost_usd,households,status</code>).
      </p>
    </section>

    <!-- Portfolio preview (if present) -->
    <section>
      <h2>üìÑ Portfolio Preview</h2>
      <div id="portfolio-table" style="margin-top:.5rem"></div>
      <p class="hint" id="portfolio-hint"></p>
      <!-- Enhanced KPIs container -->
      <div id="portfolio-kpis" style="margin-top:10px;color:#cfe6ff"></div>
    </section>

    <!-- How it fits -->
    <section>
      <h2>üß¨ How CII Fits</h2>
      <ul>
        <li><strong>Inputs:</strong> CIRI‚Äôs <em>Total Recovery</em> and risk signals; community needs; A.B.E. doctrine guardrails.</li>
        <li><strong>Process:</strong> Score candidate projects ‚Üí allocate via CIBS ‚Üí publish portfolio and status.</li>
        <li><strong>Outputs:</strong> Live investments, KPIs (households served, jobs, ROI per project), and audit-ready trails.</li>
      </ul>
    </section>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ A.B.E. Nav Dock + Live KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <section id="abe-navdock" style="background:#141820;border:1px solid var(--line);border-radius:12px;padding:16px;margin-top:18px">
      <h2 style="margin:0 0 .6rem;color:#dfe9f6;font-size:1.05rem">A.B.E. Navigator ¬∑ Live Links</h2>
      <div style="display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))">
        <div style="background:#0f131a;border:1px solid var(--line);border-radius:10px;padding:14px">
          <div style="font-weight:600;margin-bottom:8px">Doctrines</div>
          <ul style="list-style:none;padding:0;margin:0;line-height:1.8">
            <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">A.B.E. ¬∑ CRRA ¬∑ Rebuild Together (viewer)</a></li>
            <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
            <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
          </ul>
        </div>

        <div style="background:#0f131a;border:1px solid var(--line);border-radius:10px;padding:14px">
          <div style="font-weight:600;margin-bottom:8px">Calculators & KPIs</div>
          <ul style="list-style:none;padding:0;margin:0;line-height:1.9">
            <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" style="opacity:.85">loading‚Ä¶</span></li>
            <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" style="opacity:.85">loading‚Ä¶</span></li>
            <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
          </ul>
        </div>

        <div style="background:#0f131a;border:1px solid var(--line);border-radius:10px;padding:14px">
          <div style="font-weight:600;margin-bottom:8px">Archive & License</div>
          <div style="line-height:1.7">
            DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
            License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
            Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
          </div>
        </div>
      </div>
    </section>
    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ End Nav Dock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->

    <footer>
      CII is part of A.B.E.‚Äôs open, auditable toolchain.<br>
      License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a> ‚Äî non-commercial use with attribution.
    </footer>
  </main>

  <script>
    // --- helpers ---
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      return lines.map(l => l.split(',').map(x => x.trim()));
    }
    function fmtUSD(n){
      const v = Number(String(n).replace(/[^0-9.\-]/g,'')||0);
      try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v); }
      catch{ return '$'+(Math.round(v)||0).toLocaleString(); }
    }
    async function checkFile(path, okId){
      const el = document.getElementById(okId);
      try{
        const res = await fetch(path, {cache:'no-store'});
        if(!res.ok) throw 0;
        const text = await res.text();
        if(!text.trim()) throw 0;
        el.textContent = 'Present'; el.classList.add('ok');
        return text;
      }catch(e){
        el.textContent = 'Missing'; el.classList.add('warn');
        return null;
      }
    }

    // --- boot (CII core) ---
    async function boot(){
      const modelText = await checkFile('model.json','model-status');
      const portfolioText = await checkFile('portfolio.csv','port-status');

      const wrap = document.getElementById('portfolio-table');
      const hint = document.getElementById('portfolio-hint');

      if(portfolioText){
        const rows = parseCSV(portfolioText);
        if(rows.length){
          const thead = rows[0];
          const body = rows.slice(1);
          let html = '<table><thead><tr>';
          thead.forEach(h => html += `<th>${h}</th>`);
          html += '</tr></thead><tbody>';
          body.forEach(r=>{
            html += '<tr>';
            r.forEach((c,i)=>{
              const isMoney = /cost|budget|amount|usd/i.test(thead[i]||'');
              html += `<td class="${isMoney?'num':''}">${isMoney?fmtUSD(c):c}</td>`;
            });
            html += '</tr>';
          });
          html += '</tbody></table>';
          wrap.innerHTML = html;
          hint.textContent = 'Previewing /cii/portfolio.csv. Update that file to change this view.';

          // --- Enhanced KPIs for portfolio ---
          (function showPortfolioKPIs(){
            const idxCost = thead.findIndex(h => /cost|budget|amount|usd/i.test(h||''));
            const idxHH   = thead.findIndex(h => /household|hh/i.test(h||''));
            let totalCost = 0, totalHH = 0;
            body.forEach(r=>{
              const c = Number((r[idxCost]||'').toString().replace(/[^0-9.\-]/g,''));
              const h = Number((r[idxHH]  ||'').toString().replace(/[^0-9.\-]/g,''));
              if (isFinite(c)) totalCost += c;
              if (isFinite(h)) totalHH   += h;
            });
            const avgCPH = (totalHH>0) ? (totalCost/totalHH) : 0;
            const kpis = document.getElementById('portfolio-kpis');
            const money = v => { try { return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v); } catch { return '$'+Math.round(v).toLocaleString(); } };
            kpis.innerHTML = `
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                <div style="flex:1 1 240px;background:#141820;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px">
                  <div style="font-size:12px;color:#9fb3c8">Total Investment</div>
                  <div style="font-weight:800;font-size:20px">${money(totalCost)}</div>
                </div>
                <div style="flex:1 1 240px;background:#141820;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px">
                  <div style="font-size:12px;color:#9fb3c8">Total Households Served</div>
                  <div style="font-weight:800;font-size:20px">${(Math.round(totalHH)||0).toLocaleString()}</div>
                </div>
                <div style="flex:1 1 240px;background:#141820;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px">
                  <div style="font-size:12px;color:#9fb3c8">Avg. Cost / Household</div>
                  <div style="font-weight:800;font-size:20px">${money(avgCPH)}</div>
                </div>
              </div>
            `;
          })();

        }
      }else{
        wrap.innerHTML = `
          <div style="padding:12px;border:1px dashed var(--line);border-radius:10px;background:#0f141b;">
            No <code>portfolio.csv</code> yet. Add one with columns like:
            <code>name,category,cost_usd,households,status</code>.
          </div>`;
        hint.textContent = 'Once portfolio.csv is added, refresh to see the table.';
      }

      // (Optional) light check
      if(modelText){
        try{
          const j = JSON.parse(modelText);
          if(!j.categories || !Array.isArray(j.categories) || j.categories.length === 0){
            console.warn('model.json has no categories.');
          }
        }catch(e){ console.warn('model.json not valid JSON'); }
      }
    }
    boot();

    // --- A.B.E. Nav Dock live KPIs ---
    (async function(){
      // CIBS total
      try{
        const r = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
        const t = await r.text();
        const lines = t.trim().split(/\r?\n/);
        const total = lines.slice(1).reduce((s,line)=>{
          const v = Number(line.split(',')[1]); return s + (isFinite(v)?v:0);
        },0);
        document.getElementById('dock-cibs-total').textContent = fmtUSD(total);
      }catch{ const el = document.getElementById('dock-cibs-total'); if(el) el.textContent='‚Äî'; }

      // CIRI total (demo-mode)
      try{
        const r = await fetch('/abe---flag/ciri/inputs.csv',{cache:'no-store'});
        const t = await r.text();
        const [h,d] = t.trim().split(/\r?\n/);
        const keys = h.split(','); const vals = d.split(',').map(Number);
        const o = Object.fromEntries(keys.map((k,i)=>[k.trim(),vals[i]]));

        const c=o.cases_avoided, C=o.avg_cost_per_case, D=o.jail_days_avoided, J=o.cost_per_jail_day,
              F=o.fees_canceled_total, P=o.policy_corrections, E=o.avg_enforcement_cost_savings,
              H=o.households_restored, M=o.avg_monthly_market_spend, m=o.months_effective,
              pe=o.employment_probability, W=o.avg_monthly_wage, L=o.expected_lawsuits,
              A=o.avg_payout, lam=o.litigation_multiplier, T=o.transition_costs_one_time;

        const totalRecovery = (c*C+F) + (D*J) + (P*E) + (H*M*m) + ((H*pe)*W*m) + (L*A*lam) - T;
        document.getElementById('dock-ciri-total').textContent = fmtUSD(totalRecovery);
      }catch{ const el = document.getElementById('dock-ciri-total'); if(el) el.textContent='‚Äî'; }
    })();
  </script>
</body>
  </html>
