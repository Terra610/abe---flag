<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CII ‚Äî Community Investment Interface</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#141820; --panel2:#0f131a;
      --ink:#e6e6e6; --muted:#9fb3c8; --line:rgba(255,255,255,.08);
      --brand:#5ddfff; --accent:#fff750; --ok:#4bd28f; --warn:#ffa559;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;z-index:2;background:linear-gradient(90deg,#11151c,#1b1e25);border-bottom:1px solid var(--line);padding:.85rem 1rem}
    header .wrap{max-width:1040px;margin:0 auto;display:flex;align-items:center;gap:1rem}
    a{color:#80bfff;text-decoration:none}
    a:hover{text-decoration:underline}
    .badge{margin-left:auto;font-size:.8rem;color:#9fb3c8}
    .back{font-size:.9rem}
    main{max-width:1040px;margin:1.25rem auto 4rem;padding:0 1rem}
    h1{color:var(--brand);margin:.2rem 0 .4rem;font-size:1.6rem}
    p.lead{color:#c8d2df;margin:.25rem 0 1rem}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin:16px 0 22px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .card h3{margin:0 0 .35rem;font-size:.98rem;color:#dfe9f6}
    .kv{display:flex;gap:8px;align-items:baseline}
    .kv .label{color:var(--muted);font-size:.85rem}
    .kv .value{font-weight:600}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    section{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:16px;margin-top:18px}
    section h2{margin:0 0 .6rem;color:#dfe9f6;font-size:1.05rem}
    .actions{display:flex;flex-wrap:wrap;gap:.6rem;margin:.35rem 0 .25rem}
    .btn{display:inline-block;background:#1b2230;border:1px solid var(--line);padding:.5rem .7rem;border-radius:9px;font-size:.9rem}
    .btn:hover{background:#20283a}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    thead th{background:#18202b;color:#cfe6ff;font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--line)}
    tbody td{padding:10px;border-bottom:1px solid var(--line)}
    tbody tr:last-child td{border-bottom:none}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .hint{color:#9fb3c8;font-size:.9rem;margin-top:.5rem}
    footer{margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem}
    @media (max-width:760px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="back" href="../index.html">‚Üê Return to Home</a>
      <div class="badge">ABE Patch Active</div>
    </div>
  </header>

  <main>
    <h1>üèóÔ∏è CII ‚Äî Community Investment Interface</h1>
    <p class="lead">
      CII is the ‚Äúlast-mile‚Äù interface that turns verified recovery value into
      <strong>live, trackable projects</strong>: housing, clinics, food systems, broadband,
      transit, and workforce pipelines. It consumes <em>CIRI</em> results, aligns with
      <em>CIBS</em> budgets, and publishes an auditable portfolio.
    </p>

    <!-- Status cards -->
    <div class="cards" id="status">
      <div class="card">
        <h3>Model</h3>
        <div class="kv">
          <span class="label"><a href="model.json">/cii/model.json</a></span>
          <span class="value" id="model-status">Checking‚Ä¶</span>
        </div>
      </div>
      <div class="card">
        <h3>Portfolio</h3>
        <div class="kv">
          <span class="label"><a href="portfolio.csv">/cii/portfolio.csv</a></span>
          <span class="value" id="port-status">Checking‚Ä¶</span>
        </div>
      </div>
      <div class="card">
        <h3>Integration</h3>
        <div class="kv">
          <span class="label">Ready to publish to</span>
          <span class="value"><a href="../integration/index.html">Integration Layer</a></span>
        </div>
      </div>
    </div>

    <!-- Quick links -->
    <section>
      <h2>üîó Links</h2>
      <div class="actions">
        <a class="btn" href="../ciri/index.html">CIRI ‚Äî Risk & Recovery</a>
        <a class="btn" href="../cibs/index.html">CIBS ‚Äî Budget System</a>
        <a class="btn" href="../macro/index.html">Macro Cascade</a>
        <a class="btn" href="../doctrine/index.html">Doctrines</a>
        <a class="btn" href="model.json">Open model.json</a>
        <a class="btn" href="portfolio.csv">Open portfolio.csv</a>
      </div>
      <p class="hint">
        Don‚Äôt have files yet? Create a <code>model.json</code> describing project categories and multipliers,
        and a <code>portfolio.csv</code> listing projects (<code>name,category,cost_usd,households,status</code>).
      </p>
    </section>

    <!-- Portfolio preview (if present) -->
    <section>
      <h2>üìÑ Portfolio Preview</h2>
      <div id="portfolio-table" style="margin-top:.5rem"></div>
      <p class="hint" id="portfolio-hint"></p>
    </section>

    <!-- How it fits -->
    <section>
      <h2>üß¨ How CII Fits</h2>
      <ul>
        <li><strong>Inputs:</strong> CIRI‚Äôs <em>Total Recovery</em> and risk signals; community needs; A.B.E. doctrine guardrails.</li>
        <li><strong>Process:</strong> Score candidate projects ‚Üí allocate via CIBS ‚Üí publish portfolio and status.</li>
        <li><strong>Outputs:</strong> Live investments, KPIs (households served, jobs, ROI per project), and audit-ready trails.</li>
      </ul>
    </section>

    <footer>
      CII is part of A.B.E.‚Äôs open, auditable toolchain.<br>
      License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a> ‚Äî non-commercial use with attribution.
    </footer>
  </main>

  <script>
    // --- helpers ---
    function parseCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      return lines.map(l => l.split(',').map(x => x.trim()));
    }
    function fmtUSD(n){
      const v = Number(String(n).replace(/[^0-9.\-]/g,'')||0);
      try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v); }
      catch{ return '$'+(Math.round(v)||0).toLocaleString(); }
    }
    async function checkFile(path, okId){
      const el = document.getElementById(okId);
      try{
        const res = await fetch(path, {cache:'no-store'});
        if(!res.ok) throw 0;
        const text = await res.text();
        if(!text.trim()) throw 0;
        el.textContent = 'Present'; el.classList.add('ok');
        return text;
      }catch(e){
        el.textContent = 'Missing'; el.classList.add('warn');
        return null;
      }
    }

    // --- boot ---
    async function boot(){
      const modelText = await checkFile('model.json','model-status');
      const portfolioText = await checkFile('portfolio.csv','port-status');

      const wrap = document.getElementById('portfolio-table');
      const hint = document.getElementById('portfolio-hint');

      if(portfolioText){
        const rows = parseCSV(portfolioText);
        if(rows.length){
          const thead = rows[0];
          const body = rows.slice(1);
          let html = '<table><thead><tr>';
          thead.forEach(h => html += `<th>${h}</th>`);
          html += '</tr></thead><tbody>';
          body.forEach(r=>{
            html += '<tr>';
            r.forEach((c,i)=>{
              const isMoney = /cost|budget|amount|usd/i.test(thead[i]||'');
              html += `<td class="${isMoney?'num':''}">${isMoney?fmtUSD(c):c}</td>`;
            });
            html += '</tr>';
          });
          html += '</tbody></table>';
          wrap.innerHTML = html;
          hint.textContent = 'Previewing /cii/portfolio.csv. Update that file to change this view.';
        }
      }else{
        wrap.innerHTML = `
          <div style="padding:12px;border:1px dashed var(--line);border-radius:10px;background:#0f141b;">
            No <code>portfolio.csv</code> yet. Add one with columns like:
            <code>name,category,cost_usd,households,status</code>.
          </div>`;
        hint.textContent = 'Once portfolio.csv is added, refresh to see the table.';
      }

      // (Optional light check) warn if model.json exists but looks empty
      if(modelText){
        try{
          const j = JSON.parse(modelText);
          if(!j.categories || !Array.isArray(j.categories) || j.categories.length === 0){
            console.warn('model.json has no categories.');
          }
        }catch(e){ console.warn('model.json not valid JSON'); }
      }
    }
    boot();
  </script>
</body>
  </html>
