<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' https://zenodo.org data:; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'; upgrade-insecure-requests">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CII ‚Äî Community Investment Interface</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#141820; --panel2:#0f131a;
      --ink:#e6e6e6; --muted:#9fb3c8; --line:rgba(255,255,255,.08);
      --brand:#5ddfff; --accent:#fff750; --ok:#4bd28f; --warn:#ffa559;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;z-index:2;background:linear-gradient(90deg,#11151c,#1b1e25);border-bottom:1px solid var(--line);padding:.85rem 1rem}
    header .wrap{max-width:1040px;margin:0 auto;display:flex;align-items:center;gap:1rem}
    a{color:#80bfff;text-decoration:none}
    a:hover{text-decoration:underline}
    .badge{margin-left:auto;font-size:.8rem;color:#9fb3c8}
    .back{font-size:.9rem}
    main{max-width:1040px;margin:1.25rem auto 4rem;padding:0 1rem}
    h1{color:var(--brand);margin:.2rem 0 .4rem;font-size:1.6rem}
    p.lead{color:#c8d2df;margin:.25rem 0 1rem}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin:16px 0 22px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .card h3{margin:0 0 .35rem;font-size:.98rem;color:#dfe9f6}
    .kv{display:flex;gap:8px;align-items:baseline}
    .kv .label{color:var(--muted);font-size:.85rem}
    .kv .value{font-weight:600}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    section{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:16px;margin-top:18px}
    section h2{margin:0 0 .6rem;color:#dfe9f6;font-size:1.05rem}
    .actions{display:flex;flex-wrap:wrap;gap:.6rem;margin:.35rem 0 .25rem}
    .btn{display:inline-block;background:#1b2230;border:1px solid var(--line);padding:.5rem .7rem;border-radius:9px;font-size:.9rem}
    .btn:hover{background:#20283a}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    thead th{background:#18202b;color:#cfe6ff;font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--line)}
    tbody td{padding:10px;border-bottom:1px solid var(--line)}
    tbody tr:last-child td{border-bottom:none}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .hint{color:#9fb3c8;font-size:.9rem;margin-top:.5rem}
    .meta{color:#9fb3c8;font-size:.85rem;margin-top:.35rem}
    footer{margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem}
    /* accessibility */
    a:focus-visible, .btn:focus-visible { outline:3px solid #5ddfff; outline-offset:2px; border-radius:6px }
    #status { color:#cfe6ff; }
    #status.error { color:#ffa7a7; }
    @media (max-width:760px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="back" href="../index.html">‚Üê Return to Home</a>
      <div class="badge">ABE Patch Active</div>
    </div>
  </header>

  <main>
    <h1>üèóÔ∏è CII ‚Äî Community Investment Interface</h1>
    <p class="lead">
      Turns verified recovery value into <strong>live, trackable projects</strong> (housing, clinics, food systems, broadband,
      transit, workforce). Consumes <em>CIRI</em>, aligns with <em>CIBS</em>, and publishes an auditable portfolio.
    </p>

    <!-- Version/DOI banner -->
    <div class="meta">
      DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> ¬∑
      License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a> ¬∑
      <span id="last-mod">Portfolio last modified: ‚Äî</span>
    </div>

    <!-- Status cards -->
    <div class="cards" id="status-cards">
      <div class="card">
        <h3>Model</h3>
        <div class="kv">
          <span class="label"><a href="model.json">/cii/model.json</a></span>
          <span class="value" id="model-status">Checking‚Ä¶</span>
        </div>
      </div>
      <div class="card">
        <h3>Portfolio</h3>
        <div class="kv">
          <span class="label"><a href="portfolio.csv">/cii/portfolio.csv</a></span>
          <span class="value" id="port-status">Checking‚Ä¶</span>
        </div>
      </div>
      <div class="card">
        <h3>Integration</h3>
        <div class="kv">
          <span class="label">Ready to publish to</span>
          <span class="value"><a href="../integration/index.html">Integration Layer</a></span>
        </div>
      </div>
    </div>

    <!-- Live status (ARIA) -->
    <div id="status" class="hint" role="status" aria-live="polite"></div>

    <!-- Quick links -->
    <section>
      <h2>üîó Links</h2>
      <div class="actions">
        <a class="btn" href="../ciri/index.html">CIRI ‚Äî Risk & Recovery</a>
        <a class="btn" href="../cibs/index.html">CIBS ‚Äî Budget System</a>
        <a class="btn" href="../macro/index.html">Macro Cascade</a>
        <a class="btn" href="../doctrine/index.html">Doctrines</a>
        <a class="btn" href="model.json">Open model.json</a>
        <a class="btn" href="portfolio.csv">Open portfolio.csv</a>
      </div>
      <p class="hint">
        Don‚Äôt have files yet? Create a <code>model.json</code> with category multipliers,
        and a <code>portfolio.csv</code> with <code>name,category,cost_usd,households,status</code>.
      </p>
    </section>

    <!-- Portfolio preview (secure rendering) -->
    <section>
      <h2>üìÑ Portfolio Preview</h2>
      <div id="portfolio-wrap" style="margin-top:.5rem"></div>
      <p class="hint" id="portfolio-hint"></p>
    </section>

    <!-- KPIs -->
    <section>
      <h2>üìä KPIs</h2>
      <div class="cards">
        <div class="card">
          <h3>Total Project Cost</h3>
          <div class="kv"><span class="value" id="k-total">$‚Äî</span></div>
        </div>
        <div class="card">
          <h3>Total Households</h3>
          <div class="kv"><span class="value" id="k-hh">‚Äî</span></div>
        </div>
        <div class="card">
          <h3>Avg Cost / Household</h3>
          <div class="kv"><span class="value" id="k-cph">$‚Äî</span></div>
        </div>
      </div>
      <div class="hint" id="budget-note"></div>
    </section>

    <!-- How it fits -->
    <section>
      <h2>üß¨ How CII Fits</h2>
      <ul>
        <li><strong>Inputs:</strong> CIRI‚Äôs <em>Total Recovery</em>; CIBS allocations; doctrine guardrails; community needs.</li>
        <li><strong>Process:</strong> Score projects ‚Üí allocate ‚Üí publish portfolio + receipts.</li>
        <li><strong>Outputs:</strong> Live KPIs (households served, ROI per project), public audit trails, DOI-anchored versions.</li>
      </ul>
    </section>

    <footer>
      CII is part of A.B.E.‚Äôs open, auditable toolchain.<br>
      License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a> ‚Äî non-commercial use with attribution.
    </footer>
  </main>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function setText(el, txt){ if(el){ el.textContent = txt; } }
    function fmtUSD(n){
      const v = Number.isFinite(n) ? n : Number(String(n||'').replace(/[^0-9.\-]/g,''));
      if(!Number.isFinite(v)) return '$‚Äî';
      try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v); }
      catch{ return '$'+Math.round(v).toLocaleString(); }
    }
    function toNumberLikeUSD(s){
      if (typeof s === 'number') return s;
      if (!s) return 0;
      // Prevent spreadsheet formula injection on export/display (prefix if needed)
      if (/^[=+\-@]/.test(s)) s = "'"+s;
      const cleaned = String(s).replace(/[^0-9.\-]/g,'');
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : 0;
    }

    // RFC4180-ish CSV parser (handles quotes/commas/newlines)
    function parseCSV(text){
      const rows = [];
      let cur = [], val = '', i = 0, inQ = false;
      while (i < text.length){
        const c = text[i];
        if (inQ){
          if (c === '"'){
            if (text[i+1] === '"'){ val += '"'; i += 2; continue; }
            inQ = false; i++; continue;
          }
          val += c; i++; continue;
        } else {
          if (c === '"'){ inQ = true; i++; continue; }
          if (c === ','){ cur.push(val); val=''; i++; continue; }
          if (c === '\n'){ cur.push(val); rows.push(cur); cur=[]; val=''; i++; continue; }
          if (c === '\r'){ i++; continue; }
          val += c; i++; continue;
        }
      }
      cur.push(val); rows.push(cur);
      // trim trailing blank rows
      while (rows.length && rows[rows.length-1].every(c=>c==='')) rows.pop();
      return rows;
    }

    async function fetchText(url){
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt = await res.text();
      const lm = res.headers.get('Last-Modified');
      return { text: txt, lastModified: lm };
    }

    function requireHeaders(headers, required){
      const missing = required.filter(r => !headers.includes(r));
      return { ok: missing.length === 0, missing };
    }

    function renderTable(container, header, rows){
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      header.forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        r.forEach((cell, i)=>{
          const td = document.createElement('td');
          // right-align money-ish columns
          const isMoney = /cost|budget|amount|usd/i.test(header[i]||'');
          td.className = isMoney ? 'num' : '';
          td.textContent = isMoney ? fmtUSD(toNumberLikeUSD(cell)) : String(cell);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.innerHTML = '';
      container.appendChild(table);
    }

    // ---------- Page Boot ----------
    (async function boot(){
      const statusEl = $('#status');

      // Model check
      try{
        const m = await fetchText('model.json');
        $('#model-status').textContent = m.text.trim() ? 'Present' : 'Empty';
        $('#model-status').classList.add(m.text.trim() ? 'ok':'warn');
      }catch{
        $('#model-status').textContent = 'Missing';
        $('#model-status').classList.add('warn');
      }

      // Portfolio load + validate
      let portfolioRows = null, headers = null, body = null, lastMod = '‚Äî';
      try{
        const {text, lastModified} = await fetchText('portfolio.csv');
        lastMod = lastModified ? new Date(lastModified).toLocaleString() : '‚Äî';
        const rows = parseCSV(text);
        if (!rows || rows.length < 2) throw new Error('Empty CSV');
        headers = rows[0].map(h=>h.trim());
        body = rows.slice(1).filter(r => r.some(c=>String(c).trim()!==''));
        const req = requireHeaders(headers, ['name','category','cost_usd','households','status']);
        if(!req.ok) throw new Error('Missing columns: '+req.missing.join(', '));
        portfolioRows = rows;

        $('#port-status').textContent = 'Present';
        $('#port-status').classList.add('ok');
        $('#last-mod').textContent = 'Portfolio last modified: '+ lastMod;
      }catch(e){
        $('#port-status').textContent = 'Missing';
        $('#port-status').classList.add('warn');
        statusEl.classList.add('error');
        setText(statusEl, 'Could not load portfolio.csv. Ensure headers: name, category, cost_usd, households, status.');
        return;
      }

      // Secure render
      renderTable($('#portfolio-wrap'), headers, body);
      $('#portfolio-hint').textContent = 'Previewing /cii/portfolio.csv. Update that file to change this view.';

      // KPIs
      const idxCost = headers.indexOf('cost_usd');
      const idxHH   = headers.indexOf('households');
      let sumCost = 0, sumHH = 0;
      body.forEach(r=>{
        sumCost += toNumberLikeUSD(r[idxCost]);
        sumHH   += toNumberLikeUSD(r[idxHH]);
      });
      setText($('#k-total'), fmtUSD(sumCost));
      setText($('#k-hh'), Number.isFinite(sumHH) ? sumHH.toLocaleString() : '‚Äî');
      setText($('#k-cph'), (sumHH>0) ? fmtUSD(sumCost/sumHH) : '$‚Äî');

      // Optional: compare to CIBS pool (budget guardrail)
      try{
        const {text} = await fetchText('/abe---flag/cibs/auto_budget.csv');
        const r = parseCSV(text);
        const totalCIBS = r.slice(1).reduce((acc,row)=> acc + toNumberLikeUSD(row[1]), 0);
        const note = $('#budget-note');
        if (totalCIBS && sumCost > totalCIBS){
          note.textContent = `‚ö† Portfolio total (${fmtUSD(sumCost)}) exceeds CIBS allocation (${fmtUSD(totalCIBS)}). Review category weights or project scope.`;
        } else if (totalCIBS){
          note.textContent = `‚úî Portfolio total (${fmtUSD(sumCost)}) within CIBS allocation (${fmtUSD(totalCIBS)}).`;
        }
      }catch{ /* non-fatal */ }

      // Success status
      setText(statusEl, 'Loaded model & portfolio successfully.');
    })();
  </script>
</body>
        </html>
