<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CAE — Constitutional Alignment Engine</title>
<style>
:root{--bg:#0b0d12;--panel:#141820;--ink:#e6e6e6;--muted:#9fb3c8;--line:rgba(255,255,255,.08);--ok:#4bd28f;--bad:#ff6b6b;--brand:#5ddfff}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui}
a{color:#80bfff} header{padding:20px;background:#11151c;border-bottom:1px solid var(--line);text-align:center}
main{max-width:980px;margin:20px auto;padding:0 16px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin:12px 0}
.kpi{display:flex;gap:12px;flex-wrap:wrap}
.tile{flex:1 1 240px;border:1px solid var(--line);border-radius:10px;padding:12px;background:#10151d}
.num{font-weight:800}
.ok{color:var(--ok)} .bad{color:var(--bad)}
pre{white-space:pre-wrap;overflow:auto;background:#10151d;border:1px solid var(--line);border-radius:10px;padding:12px}
</style>
</head>
<body>
<header>
  <h1>CAE — Constitutional Alignment Engine</h1>
  <div><a href="../index.html">← Home</a> · <a href="../integration/index.html">Integration</a></div>
</header>

<main>
  <div class="card">
    <h3>Status</h3>
    <div class="kpi">
      <div class="tile"><div>model.json</div><div id="k-model" class="num">checking…</div></div>
      <div class="tile"><div>schema.json</div><div id="k-schema" class="num">checking…</div></div>
      <div class="tile"><div>Validation</div><div id="k-valid" class="num">—</div></div>
    </div>
  </div>

  <div class="card">
    <h3>Diagnostics</h3>
    <div id="diag">No issues.</div>
  </div>

  <div class="card">
    <h3>Loaded Weights</h3>
    <pre id="weights">—</pre>
  </div>

  <div class="card">
    <h3>Clauses (3 shown)</h3>
    <pre id="clauses">—</pre>
  </div>
</main>

<script>
async function fetchJSON(path){
  const r = await fetch(path,{cache:'no-store'});
  if(!r.ok) throw new Error(path+': HTTP '+r.status);
  return r.json();
}
function set(el, txt, cls){ const e=document.getElementById(el); e.textContent=txt; e.className=cls?cls:''; }

function validate(model, schema){
  const issues=[];
  function req(obj, key, type){
    if(!(key in obj)) issues.push(`Missing "${key}"`);
    else if(type && typeof obj[key]!==type) issues.push(`"${key}" should be ${type}`);
  }
  req(model,'version','string');
  req(model,'updated','string');
  req(model,'authority','object');
  req(model,'weights','object');
  req(model,'clauses','object'); // array but typeof === 'object'

  // weights
  if(model.weights){
    ['clarity_of_scope','constitutional_nexus','operational_fidelity'].forEach(k=>{
      if(!(k in model.weights)) issues.push(`weights.${k} required`);
      else if(typeof model.weights[k]!=='number') issues.push(`weights.${k} must be number`);
    });
  }

  // clauses
  if(Array.isArray(model.clauses)){
    if(model.clauses.length<3) issues.push('clauses must have at least 3 items');
    model.clauses.forEach((c,i)=>{
      ['clause_id','title','constitutional_anchor','intent'].forEach(k=>{
        if(!(k in c)) issues.push(`clauses[${i}].${k} missing`);
      });
      ['statutes','regulations','scope_notes','tags','evidence_links'].forEach(k=>{
        if(!Array.isArray(c[k])||c[k].length<1) issues.push(`clauses[${i}].${k} must be non-empty array`);
      });
      ['alignment_score','confidence'].forEach(k=>{
        const v=c[k]; if(typeof v!=='number'||v<0||v>1) issues.push(`clauses[${i}].${k} must be 0..1`);
      });
      if(typeof c.source_hash!=='string' || !/^sha256:[0-9a-f]{64}$/.test(c.source_hash))
        issues.push(`clauses[${i}].source_hash must match sha256:...64 hex`);
    });
  }else{
    issues.push('clauses must be an array');
  }

  return issues;
}

(async()=>{
  try{
    const model = await fetchJSON('./model.json'); set('k-model','OK','ok');
    const schema = await fetchJSON('./schema.json'); set('k-schema','OK','ok');

    const issues = validate(model, schema);
    if(issues.length){
      set('k-valid','BAD','bad');
      document.getElementById('diag').innerHTML =
        '<ul>'+issues.map(x=>`<li>${x}</li>`).join('')+'</ul>';
    }else{
      set('k-valid','OK','ok');
      document.getElementById('diag').textContent = 'All checks passed.';
    }

    document.getElementById('weights').textContent = JSON.stringify(model.weights, null, 2);
    document.getElementById('clauses').textContent = JSON.stringify(model.clauses.slice(0,3), null, 2);
  }catch(e){
    set('k-model','ERR','bad'); document.getElementById('diag').textContent = e.message;
  }
})();
</script>
</body>
</html>    <div class="sub">Validates CAE model data against schema and surfaces alignment KPIs that feed CDI → CIRI.</div>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="kpi">
      <div class="tile">
        <div>Schema Validation</div>
        <div id="k-valid" class="num">Checking…</div>
        <small>Source: <code>/cae/schema.json</code> vs <code>/cae/model.json</code></small>
      </div>
      <div class="tile">
        <div>Average Alignment</div>
        <div id="k-avg" class="num">—</div>
        <small>Mean of clause-level alignment scores</small>
      </div>
      <div class="tile">
        <div>Divergences Flagged</div>
        <div id="k-dev" class="num">—</div>
        <small>Count of clauses below 0.80 (tunable)</small>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Articles & Clauses</h3>
    <table class="table" id="tbl">
      <thead><tr><th>Article</th><th>Clause ID</th><th>Reference</th><th>Alignment</th></tr></thead>
      <tbody></tbody>
    </table>
    <small id="errs"></small>
  </div>

  <div class="card">
    <h3>How CAE Feeds the Pipeline</h3>
    <ul>
      <li><strong>CAE → CDI:</strong> normalize alignment_scores into a divergence signal \(\delta_t\) per domain.</li>
      <li><strong>CDI → CIRI:</strong> \(\delta_t\) and verified actions shape risk & recovery (SIRF · IRE · CEQ).</li>
      <li><strong>CIRI → CIBS → CII → Integration:</strong> dollars → budgets → projects → receipts.</li>
    </ul>
  </div>
</main>

<footer>
  CC BY-NC 4.0 · DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> · Integrity only — never for sale.
</footer>

<!-- Ajv (JSON Schema 2020-12) -->
<script src="https://cdn.jsdelivr.net/npm/ajv@8/dist/ajv.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ajv-formats@3/dist/ajv-formats.min.js"></script>

<script>
(async function(){
  const q = s => document.querySelector(s);
  const set = (id, val, ok) => {
    const el = document.getElementById(id);
    el.textContent = val;
    if(ok === true){ el.style.color = "var(--ok)"; }
    if(ok === false){ el.style.color = "var(--warn)"; }
  };

  // Fetch schema & model
  let schema, model;
  try{
    const s = await fetch('/abe---flag/cae/schema.json',{cache:'no-store'}).then(r=>r.json());
    const m = await fetch('/abe---flag/cae/model.json',{cache:'no-store'}).then(r=>r.json());
    schema = s; model = m;
  }catch(e){
    set('k-valid','Missing files', false);
    q('#errs').textContent = 'Could not load cae/schema.json or cae/model.json';
    return;
  }

  // Validate with Ajv
  try{
    const ajv = new Ajv({strict:false}); // permissive but schema-driven
    ajvFormats(ajv);
    const validate = ajv.compile(schema);
    const ok = validate(model);
    set('k-valid', ok ? 'Valid' : 'Invalid', ok);
    if(!ok){
      q('#errs').textContent = (validate.errors||[]).map(e=>`${e.instancePath} ${e.message}`).join(' · ');
    }
  }catch(e){
    set('k-valid','Validation error', false);
    q('#errs').textContent = e.message || String(e);
  }

  // KPIs from model.summary (and fallback compute)
  const clauses = [];
  (model.articles||[]).forEach(a => (a.clauses||[]).forEach(c => clauses.push({a:a.title, c:c.clause_id, r:c.reference, s:Number(c.alignment_score)})));
  const avg = clauses.length ? clauses.reduce((s,x)=>s+x.s,0)/clauses.length : 0;
  const devCount = clauses.filter(x=>x.s < 0.80).length;

  set('k-avg', avg.toFixed(4), true);
  set('k-dev', String(devCount), devCount===0);

  // Render table (safe text nodes, no innerHTML injection)
  const tbody = q('#tbl tbody');
  clauses.forEach(row=>{
    const tr = document.createElement('tr');
    [row.a, row.c, row.r, row.s.toFixed(2)].forEach((cell,i)=>{
      const td = document.createElement('td');
      if(i===3) td.style.textAlign = 'right';
      td.textContent = cell;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
})();
</script>
</body>
                                                                                                                    </html>
