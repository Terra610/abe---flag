<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CIBS — Community Integrity Budget System</title>
<style>
  body{background:#0b0d12;color:#e0e0e0;font-family:system-ui,Segoe UI,Roboto,sans-serif;margin:0}
  main{max-width:980px;margin:2rem auto;padding:0 1rem 3rem}
  h1{color:#5ddfff;margin:.25rem 0 1rem}
  .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.09);border-radius:12px;padding:1rem 1.25rem;margin:1rem 0}
  table{width:100%;border-collapse:collapse;margin-top:.75rem}
  th,td{padding:.6rem .55rem;border-bottom:1px solid rgba(255,255,255,.08)}
  th{font-weight:600;color:#9fd7ff;text-align:left}
  td.num{text-align:right;font-variant-numeric:tabular-nums}
  .muted{color:#9aa4b2;font-size:.9rem}
  .ok{color:#6fe3b5}.warn{color:#ffda6b}.err{color:#ff7a7a}
  a{color:#80bfff;text-decoration:none} a:hover{text-decoration:underline}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem} @media(max-width:760px){.grid{grid-template-columns:1fr}}
  .kpi{display:flex;justify-content:space-between;align-items:baseline;padding:.65rem .8rem;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px}
  .kpi .label{color:#b9c6d5;font-size:.9rem}
  .kpi .value{font-size:1.1rem;font-weight:700}
  .errbox{background:rgba(255,0,0,.08);border:1px solid rgba(255,0,0,.25);padding:.75rem;border-radius:10px}
</style>
</head>
<body>
<main>
  <p class="muted"><a href="../index.html">← Return to Home</a></p>
  <h1>CIBS — Community Integrity Budget System</h1>
  <div class="card">
    <div class="grid">
      <div class="kpi"><span class="label">SpecDocs</span><span class="value"><a href="model.md">cibs/model.md</a></span></div>
      <div class="kpi"><span class="label">Template</span><span class="value"><a href="budget_template.csv">cibs/budget_template.csv</a></span></div>
    </div>
    <p class="muted" style="margin-top:.6rem">When CIRI runs, it writes to <code>/cibs/auto_budget.csv</code>. This page reads that file and renders the allocation.</p>
  </div>

  <div id="status" class="card">
    <strong>Status:</strong>
    <span id="statusText" class="warn">Looking for <code>auto_budget.csv</code>…</span>
  </div>

  <div class="card" id="tableCard" style="display:none">
    <h3 style="margin:.25rem 0 0;">Auto Budget Preview</h3>
    <table id="tbl">
      <thead><tr><th>Category</th><th class="num">Value (USD)</th><th class="num">Share</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><th>Total</th><th class="num" id="sumCell">—</th><th class="num" id="pctCell">100%</th></tr></tfoot>
    </table>
    <p class="muted" id="note"></p>
  </div>

  <div id="errCard" class="card" style="display:none">
    <div class="errbox">
      <strong class="err">Couldn’t load <code>auto_budget.csv</code>.</strong>
      <div id="errMsg" class="muted" style="margin-top:.35rem"></div>
      <p class="muted" style="margin:.5rem 0 0">Check that the file exists at <code>/cibs/auto_budget.csv</code> and that the header is <code>category,value</code> with numbers like <code>342000</code> (no $ or commas).</p>
    </div>
  </div>
</main>

<script>
(async () => {
  const statusEl = document.getElementById('statusText');
  const tableCard = document.getElementById('tableCard');
  const errCard = document.getElementById('errCard');
  const errMsg = document.getElementById('errMsg');

  const paths = ['./auto_budget.csv','/cibs/auto_budget.csv'];
  let text=null, usedPath='';
  for (const p of paths) {
    try {
      const r = await fetch(p,{cache:'no-store'});
      if (r.ok) { text = await r.text(); usedPath = p; break; }
    } catch(e){ /* try next */ }
  }

  if (!text) {
    statusEl.textContent = 'Not generated';
    statusEl.className = 'err';
    errCard.style.display = 'block';
    errMsg.textContent = 'Fetch failed at ./auto_budget.csv and /cibs/auto_budget.csv.';
    return;
  }

  statusEl.textContent = `Loaded from ${usedPath}`;
  statusEl.className = 'ok';

  // CSV → rows
  const lines = text.trim().split(/\r?\n/);
  if (!lines.length) return;

  const head = lines[0].split(',').map(s=>s.trim().toLowerCase());
  const ci = head.indexOf('category');
  const vi = head.indexOf('value');
  if (ci === -1 || vi === -1) {
    errCard.style.display = 'block';
    errMsg.textContent = 'Header must include "category,value".';
    return;
  }

  const rows = [];
  for (let i=1;i<lines.length;i++){
    if (!lines[i].trim()) continue;
    const cols = lines[i].split(','); // simple CSV (no quoted commas expected)
    const cat = (cols[ci]||'').trim();
    const raw = (cols[vi]||'').trim().replace(/\$/g,'').replace(/,/g,'');
    const val = Number(raw);
    rows.push({cat, val: Number.isFinite(val)?val:0});
  }

  const sum = rows.reduce((a,r)=>a+(r.val||0),0);
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';

  rows.forEach(r=>{
    const tr = document.createElement('tr');
    const tdC = document.createElement('td'); tdC.textContent = r.cat || '—';
    const tdV = document.createElement('td'); tdV.className='num'; tdV.textContent = fmtUSD(r.val);
    const tdP = document.createElement('td'); tdP.className='num';
    const pct = sum>0 ? (r.val/sum*100) : 0;
    tdP.textContent = pct.toFixed(1)+'%';
    tr.append(tdC,tdV,tdP);
    tbody.appendChild(tr);
  });

  document.getElementById('sumCell').textContent = fmtUSD(sum);
  document.getElementById('pctCell').textContent = '100%';
  tableCard.style.display = 'block';
  document.getElementById('note').textContent = 'Header used: category,value · Extra columns are ignored. Numbers are sanitized (no $ / commas).';
})();

function fmtUSD(n){
  try{ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n||0); }
  catch(e){ return '$'+(n||0).toLocaleString('en-US'); }
}
</script>
</body>
</html>
