<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CIBS ‚Äî Community Integrity Budget System</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#141820; --panel-2:#0f131a;
      --text:#e6e6e6; --muted:#97a3b3; --line:rgba(255,255,255,.08);
      --brand:#5ddfff; --accent:#fff750; --ok:#4bd28f; --warn:#ffa559;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;z-index:2;background:linear-gradient(90deg,#11151c,#1b1e25);border-bottom:1px solid var(--line);padding:.85rem 1rem}
    header .wrap{max-width:1040px;margin:0 auto;display:flex;align-items:center;gap:1rem}
    a{color:#80bfff;text-decoration:none}
    a:hover{text-decoration:underline}
    .badge{margin-left:auto;font-size:.8rem;color:#9fb3c8}
    .back{font-size:.9rem}
    main{max-width:1040px;margin:1.25rem auto 4rem;padding:0 1rem}
    h1{color:var(--brand);margin:.2rem 0 .4rem;font-size:1.6rem}
    p.lead{color:#c8d2df;margin:.25rem 0 .75rem}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin:16px 0 22px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .card h3{margin:0 0 .35rem;font-size:.95rem;color:#dfe9f6}
    .kv{display:flex;gap:8px;align-items:baseline}
    .kv .label{color:var(--muted);font-size:.85rem}
    .kv .value{font-weight:600}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    section{background:var(--panel-2);border:1px solid var(--line);border-radius:12px;padding:16px;margin-top:18px}
    section h2{margin:0 0 .75rem;color:#dfe9f6;font-size:1.05rem}
    .actions{display:flex;flex-wrap:wrap;gap:.6rem;margin:.35rem 0 0}
    .btn{display:inline-block;background:#1b2230;border:1px solid var(--line);padding:.5rem .7rem;border-radius:9px;font-size:.9rem}
    .btn:hover{background:#20283a}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:10px;overflow:hidden}
    thead th{background:#18202b;color:#cfe6ff;font-weight:600;text-align:left;padding:10px;border-bottom:1px solid var(--line)}
    tbody td{padding:10px;border-bottom:1px solid var(--line)}
    tbody tr:last-child td{border-bottom:none}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .total{display:flex;justify-content:flex-end;margin:.75rem 0 0;color:#eaf3ff}
    .total strong{margin-left:.5rem;color:#fff}
    .hint{color:#9fb3c8;font-size:.9rem;margin-top:.5rem}
    footer{margin:32px 0 24px;text-align:center;color:#8fa1b6;font-size:.85rem}
    @media (max-width:760px){.cards{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="back" href="../index.html">‚Üê Return to Home</a>
      <div class="badge">ABE Patch Active</div>
    </div>
  </header>

  <main>
    <h1>üí∞ CIBS ‚Äî Community Integrity Budget System</h1>
    <p class="lead">Turns CIRI‚Äôs <em>Total Impact</em> into a transparent, auditable <strong>Recovery Pool</strong> allocation.</p>

    <!-- Status cards -->
    <div class="cards" id="status-cards">
      <div class="card">
        <h3>SpecDocs</h3>
        <div class="kv"><span class="label">Model</span><span class="value"><a href="model.md">cibs/model.md</a></span></div>
      </div>
      <div class="card">
        <h3>Template</h3>
        <div class="kv"><span class="label">CSV</span><span class="value"><a href="budget_template.csv">budget_template.csv</a></span></div>
      </div>
      <div class="card">
        <h3>Auto Budget</h3>
        <div class="kv"><span class="label">Status</span><span class="value" id="ab-status" class="warn">Checking‚Ä¶</span></div>
      </div>
    </div>

    <!-- CSV preview -->
    <section>
      <h2>üìÑ Auto Budget Preview (<code>auto_budget.csv</code>)</h2>
      <div class="actions">
        <a class="btn" href="auto_budget.csv">Open CSV</a>
        <a class="btn" href="../ciri/index.html">Go to CIRI</a>
        <a class="btn" href="../integration/index.html">Integration Layer</a>
        <a class="btn" href="../system/index.html">System Map</a>
      </div>

      <div id="table-wrap" style="margin-top:.85rem"></div>
      <div class="total" id="total-row" hidden>
        Total Allocation: <strong id="total-val">$0</strong>
      </div>
      <p class="hint" id="hint"></p>
    </section>

    <footer>
      CIBS reads <code>auto_budget.csv</code> written by CIRI and displays it here for public verification.
      All numbers are preliminary until notarized in the Integration Layer.
    </footer>
  </main>

  <script>
    // small CSV parser (handles plain commas; trims spaces)
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/).filter(Boolean);
      return lines.map(l => l.split(',').map(x => x.trim()));
    }
    function fmtUSD(n){
      try { return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n); }
      catch { return '$' + (Math.round(n)||0).toLocaleString(); }
    }

    async function loadAutoBudget(){
      const statusEl = document.getElementById('ab-status');
      const tableWrap = document.getElementById('table-wrap');
      const totalWrap = document.getElementById('total-row');
      const totalVal  = document.getElementById('total-val');
      const hintEl    = document.getElementById('hint');

      try{
        const res = await fetch('auto_budget.csv', {cache:'no-store'});
        if(!res.ok){ throw new Error('not-found'); }
        const text = await res.text();
        if(!text.trim()){ throw new Error('empty'); }

        // parse & render
        const rows = parseCSV(text);
        const headers = rows[0] || [];
        const data = rows.slice(1);

        // status ‚Üí OK
        statusEl.textContent = 'Present';
        statusEl.classList.add('ok');

        // build table
        let html = '<table><thead><tr>';
        headers.forEach(h => html += `<th>${h}</th>`);
        html += '</tr></thead><tbody>';

        let total = 0;
        data.forEach(r => {
          const category = r[0] ?? '';
          const rawVal = (r[1] ?? '').replace(/[^0-9.\-]/g,'');
          const val = Number(rawVal || 0);
          total += isFinite(val) ? val : 0;
          html += `<tr><td>${category}</td><td class="num">${fmtUSD(val)}</td></tr>`;
        });

        html += '</tbody></table>';
        tableWrap.innerHTML = html;
        totalVal.textContent = fmtUSD(total);
        totalWrap.hidden = false;

        hintEl.textContent = 'Numbers reflect the latest file in /cibs/auto_budget.csv. Update that CSV to change this view.';
      }catch(err){
        statusEl.textContent = 'Not generated';
        statusEl.classList.add('warn');
        tableWrap.innerHTML = `
          <div style="padding:12px;border:1px dashed var(--line);border-radius:10px;background:#0f141b;">
            No <code>auto_budget.csv</code> found yet. Run CIRI to generate it, or create one from
            <a href="budget_template.csv">budget_template.csv</a>.
          </div>`;
        hintEl.textContent = 'Once CIRI writes auto_budget.csv, refresh this page to see the allocation table.';
      }
    }

    loadAutoBudget();
  </script>
</body>
</html>
