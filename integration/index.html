<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Integration — A.B.E. Public KPIs & Integrity</title>
<base href="/abe---flag/">
<link rel="stylesheet" href="abe-patch/assets/abe-patch.css">
<style>
  .int-wrap{max-width:1100px;margin:0 auto;padding:1.4rem 1rem 3rem}
  .int-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .int-kpi-label{font-size:.9rem;color:#9fb3c8}
  .int-kpi-num{font-size:1.35rem;font-weight:700}
  .status-pill{display:inline-block;padding:.1rem .55rem;border-radius:999px;font-size:.8rem;border:1px solid rgba(255,255,255,.12)}
  .s-ok{border-color:#4bd28f;color:#4bd28f}
  .s-warn{border-color:#ffa559;color:#ffa559}
  .s-bad{border-color:#ff6b6b;color:#ff6b6b}
  .int-table{width:100%;border-collapse:collapse;font-size:.9rem;margin-top:.5rem}
  .int-table th,.int-table td{border:1px solid rgba(255,255,255,.08);padding:.45rem .55rem;text-align:left}
  .int-table th{background:rgba(255,255,255,.04)}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace;font-size:.78rem}
  .hash-cell{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .small-note{font-size:.85rem;color:#9fb3c8;margin-top:.3rem}
</style>
</head>
<body class="abe-page">
<header class="abe-header">
  <div class="int-wrap">
    <a href="/abe---flag/index.html" class="chip">← Home</a>
    <h1>Integration Layer — Public KPIs & Integrity</h1>
    <p class="tagline">
      Live signals from the A.B.E. pipeline (CIRI → CIBS → CFF/AFFE) plus one-click SHA-256 audit for all published artifacts.
    </p>
  </div>
</header>

<main class="abe-main int-wrap">

  <!-- Live KPIs -->
  <section class="card">
    <h2>Live KPIs</h2>
    <div class="int-grid">
      <div class="tile">
        <div class="int-kpi-label">Public Allocation (CIBS)</div>
        <div id="kpi-cibs-total" class="int-kpi-num">—</div>
        <div class="small-note">Sum of <code>/cibs/auto_budget.csv</code> (current published plan)</div>
      </div>
      <div class="tile">
        <div class="int-kpi-label">Modeled Recovery (CIRI)</div>
        <div id="kpi-ciri-total" class="int-kpi-num">—</div>
        <div class="small-note">Computed from <code>/ciri/inputs.csv</code> (engine estimate)</div>
      </div>
      <div class="tile">
        <div class="int-kpi-label">CIRI Index</div>
        <div id="kpi-ciri" class="int-kpi-num">—</div>
        <div class="small-note">\( CIRI = 1 - e^{-R_T/K} \) with K-scale</div>
      </div>
      <div class="tile">
        <div class="int-kpi-label">ROI per Case</div>
        <div id="kpi-roi" class="int-kpi-num">—</div>
        <div class="small-note">\( ROI_{case}=R_T/\max(1,cases) \)</div>
      </div>
    </div>
  </section>

  <!-- Integrity Controls -->
  <section class="card">
    <h2>Integrity Beacon</h2>
    <p class="small-note">
      Runs local, dependency-free checks: file presence, basic plausibility, and SHA-256 hashes for every major module.
      Nothing leaves your device.
    </p>

    <div class="int-grid" id="beacons">
      <div class="tile"><div><strong>CIRI</strong> (<code>ciri/inputs.csv</code>)</div><div id="b-ciri" class="status-pill">—</div></div>
      <div class="tile"><div><strong>CIBS</strong> (<code>cibs/auto_budget.csv</code>)</div><div id="b-cibs" class="status-pill">—</div></div>
      <div class="tile"><div><strong>CDI</strong> (<code>cdi/divergence.csv</code>)</div><div id="b-cdi" class="status-pill">—</div></div>
      <div class="tile"><div><strong>CAE</strong> (<code>cae/model.json</code>)</div><div id="b-cae" class="status-pill">—</div></div>
      <div class="tile"><div><strong>CFF</strong> (<code>cff/inputs.csv</code>)</div><div id="b-cff" class="status-pill">—</div></div>
      <div class="tile"><div><strong>AFFE</strong> (<code>affe/index.html</code>)</div><div id="b-affe" class="status-pill">—</div></div>
      <div class="tile"><div><strong>CCRI</strong> (<code>ccri/inputs.json</code>)</div><div id="b-ccri" class="status-pill">—</div></div>
    </div>

    <div style="margin-top:10px">
      <button id="btn-verify" class="btn">Verify Now</button>
      <button id="btn-download" class="btn" disabled>Download Audit Certificate (JSON)</button>
    </div>
  </section>

  <!-- Detailed Results -->
  <section class="card">
    <h2>Verification Results</h2>
    <table class="int-table">
      <thead>
        <tr>
          <th>Artifact</th>
          <th>Checks</th>
          <th>Status</th>
          <th>SHA-256</th>
        </tr>
      </thead>
      <tbody id="result-rows">
        <tr><td colspan="4">Click “Verify Now” to run the audit locally.</td></tr>
      </tbody>
    </table>
    <div id="result-meta" class="mono small-note" style="margin-top:.5rem"></div>

    <h3 style="margin-top:1rem">Raw JSON</h3>
    <pre id="raw" class="mono" style="white-space:pre-wrap;background:#0f131a;border-radius:8px;padding:.6rem;border:1px solid rgba(255,255,255,.08);max-height:260px;overflow:auto">—</pre>
  </section>

  <!-- Audit trail links -->
  <section class="card">
    <h2>Audit Trail (sources)</h2>
    <ul class="small-note">
      <li><a href="/abe---flag/ciri/inputs.csv">/ciri/inputs.csv</a> — engine inputs</li>
      <li><a href="/abe---flag/cibs/auto_budget.csv">/cibs/auto_budget.csv</a> — public allocation</li>
      <li><a href="/abe---flag/cdi/divergence.csv">/cdi/divergence.csv</a> — divergence inputs</li>
      <li><a href="/abe---flag/cae/model.json">/cae/model.json</a> — alignment corpus map</li>
      <li><a href="/abe---flag/cff/inputs.csv">/cff/inputs.csv</a> — funding forensics input</li>
      <li><a href="/abe---flag/affe/index.html">/affe/index.html</a> — AFFE interface & logic</li>
      <li><a href="/abe---flag/ccri/inputs.json">/ccri/inputs.json</a> — CCRI scenarios</li>
      <li><a href="/abe---flag/macro/model.html">/macro/model.html</a> — formal equations</li>
      <li><a href="https://doi.org/10.5281/zenodo.17586107">DOI 10.5281/zenodo.17586107</a> — permanent archive</li>
    </ul>
  </section>

</main>

<footer class="abe-footer">
  <p>
    CC BY-NC 4.0 · DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> · Integrity only — never for sale.
  </p>
</footer>

<script src="/abe---flag/system/integrity.js"></script>
<script src="/abe---flag/system/divergence.js"></script>
<script>
(function(){
  const fmtMoney = n => {
    const v = Number(n);
    if(!isFinite(v)) return '—';
    try{
      return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v);
    }catch(_){
      return '$'+Math.round(v).toLocaleString();
    }
  };

  async function loadKPIs(){
    // CIBS total
    try{
      const r = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
      const t = await r.text();
      const lines = t.trim().split(/\r?\n/);
      const total = lines.slice(1).reduce((s,line)=>{
        const v = Number(line.split(',')[1]); return s + (isFinite(v)?v:0);
      },0);
      document.getElementById('kpi-cibs-total').textContent = fmtMoney(total);
    }catch(_){}

    // CIRI derived
    try{
      const r = await fetch('/abe---flag/ciri/inputs.csv',{cache:'no-store'});
      const t = await r.text();
      const [h,d] = t.trim().split(/\r?\n/);
      const keys = h.split(','); const vals = d.split(',').map(Number);
      const o = Object.fromEntries(keys.map((k,i)=>[k.trim(),vals[i]]));

      const c=o.cases_avoided, C=o.avg_cost_per_case, D=o.jail_days_avoided, J=o.cost_per_jail_day,
            F=o.fees_canceled_total, P=o.policy_corrections, E=o.avg_enforcement_cost_savings,
            H=o.households_restored, M=o.avg_monthly_market_spend, m=o.months_effective,
            pe=o.employment_probability, W=o.avg_monthly_wage, L=o.expected_lawsuits,
            A=o.avg_payout, lam=o.litigation_multiplier, T=o.transition_costs_one_time;

      const total = (c*C+F) + (D*J) + (P*E) + (H*M*m) + ((H*pe)*W*m) + (L*A*lam) - T;
      const K = 2_000_000_000;
      const CIRI = 1 - Math.exp(- total / K);
      const ROI  = total / Math.max(1,c);

      document.getElementById('kpi-ciri-total').textContent = fmtMoney(total);
      document.getElementById('kpi-ciri').textContent       = CIRI.toFixed(2);
      document.getElementById('kpi-roi').textContent        = fmtMoney(ROI);
    }catch(_){}
  }

  loadKPIs();

  const btnVerify = document.getElementById('btn-verify');
  const btnDl     = document.getElementById('btn-download');
  const rowsEl    = document.getElementById('result-rows');
  const metaEl    = document.getElementById('result-meta');
  const rawEl     = document.getElementById('raw');

  function setBeacon(id, status){
    const el = document.getElementById(id);
    if(!el) return;
    el.className = 'status-pill';
    if(status === 'ok')   el.classList.add('s-ok');
    else if(status === 'warn') el.classList.add('s-warn');
    else el.classList.add('s-bad');
    el.textContent = status.toUpperCase();
  }

  btnVerify.addEventListener('click', async ()=>{
    btnVerify.disabled = true;
    btnVerify.textContent = 'Verifying…';

    try{
      const report = await window.runIntegrity({
        base: '/abe---flag'
      });

      const m = report.modules;

      setBeacon('b-ciri', m.ciri.status);
      setBeacon('b-cibs', m.cibs.status);
      setBeacon('b-cdi',  m.cdi.status);
      setBeacon('b-cae',  m.cae.status);
      setBeacon('b-cff',  m.cff.status);
      setBeacon('b-affe', m.affe.status);
      setBeacon('b-ccri', m.ccri.status);

      const rowData = [
        ['ciri/inputs.csv',        m.ciri],
        ['cibs/auto_budget.csv',   m.cibs],
        ['cdi/divergence.csv',     m.cdi],
        ['cae/model.json',         m.cae],
        ['cff/inputs.csv',         m.cff],
        ['affe/index.html',        m.affe],
        ['ccri/inputs.json',       m.ccri]
      ];

      rowsEl.innerHTML = rowData.map(([name,mod])=>{
        const shortHash = mod.sha256 && mod.sha256.length > 20
          ? mod.sha256.slice(0,20) + '…'
          : (mod.sha256 || 'N/A');
        const safeMsg = (mod.message || '').replace(/</g,'&lt;');
        return `
          <tr>
            <td>${name}</td>
            <td>${safeMsg}</td>
            <td>${mod.status.toUpperCase()}</td>
            <td class="mono hash-cell" title="${mod.sha256 || ''}">${shortHash}</td>
          </tr>
        `;
      }).join('');

      rawEl.textContent = JSON.stringify(report,null,2);
      metaEl.textContent = `audit_id: ${report.audit_id} • generated_at: ${report.generated_at}`;

      btnDl.disabled = false;
      btnDl.onclick = ()=>{
        const blob = new Blob([JSON.stringify(report,null,2)],{type:'application/json'});
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url;
        a.download = `abe_audit_${report.audit_id}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

    }catch(err){
      rowsEl.innerHTML = `<tr><td colspan="4">Integrity check failed: ${err.message}</td></tr>`;
      rawEl.textContent = String(err);
      metaEl.textContent = '';
    }finally{
      btnVerify.disabled = false;
      btnVerify.textContent = 'Verify Now';
    }
  });
})();
</script>
</body>
      </html>
