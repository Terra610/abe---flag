<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Integration — A.B.E. Public KPIs & Integrity</title>
<base href="/abe---flag/">
<style>
:root{
  --bg:#0b0d12;--panel:#141820;--panel2:#0f131a;--ink:#e6e6e6;--muted:#9fb3c8;
  --line:rgba(255,255,255,.08);--brand:#5ddfff;--warn:#ffa559;--ok:#4bd28f;--bad:#ff6b6b
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui}
a{color:#80bfff;text-decoration:none}
a:hover{text-decoration:underline}
header{
  padding:24px 20px;
  background:linear-gradient(90deg,#11151c,#1b1e25);
  border-bottom:1px solid var(--line)
}
.wrap{max-width:1100px;margin:0 auto;padding:24px 20px}
h1{margin:0 0 6px}
.sub{color:var(--muted)}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.card{
  background:var(--panel);border:1px solid var(--line);
  border-radius:12px;padding:16px;margin:18px 0
}
.tile{
  background:var(--panel2);border:1px solid var(--line);
  border-radius:10px;padding:14px
}
.num{font-size:1.35rem;font-weight:700}
small{color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:10px 12px;text-align:left}
th{background:var(--panel2)}
footer{margin:36px 0 20px;color:var(--muted);text-align:center;font-size:.9rem}
.badge{
  display:inline-block;padding:2px 8px;border:1px solid var(--line);
  border-radius:999px;color:var(--muted);font-size:.85rem
}
.btn{
  display:inline-block;border:1px solid var(--line);
  background:#0f131a;color:#e6e6e6;
  padding:.55rem .9rem;border-radius:9px;
  text-decoration:none;cursor:pointer
}
.btn:hover{border-color:var(--brand)}
.status{
  display:inline-block;padding:.1rem .5rem;border-radius:999px;
  border:1px solid var(--line);font-size:.85rem
}
.s-ok{background:rgba(75,210,143,.12);color:var(--ok);border-color:rgba(75,210,143,.35)}
.s-warn{background:rgba(255,165,89,.12);color:var(--warn);border-color:rgba(255,165,89,.35)}
.s-bad{background:rgba(255,107,107,.12);color:var(--bad);border-color:rgba(255,107,107,.35)}
.kright{float:right}
pre.code{
  white-space:pre-wrap;background:#0f131a;border:1px solid var(--line);
  border-radius:10px;padding:12px;overflow:auto
}
.mono{font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace}
.small{font-size:.85rem}
.banner{
  margin-top:8px;padding:8px 10px;border-radius:8px;
  border:1px solid var(--line);font-size:.85rem
}
.banner-ok{border-color:rgba(75,210,143,.5);background:rgba(75,210,143,.08);color:var(--ok)}
.banner-warn{border-color:rgba(255,165,89,.5);background:rgba(255,165,89,.08);color:var(--warn)}
.nav{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="/abe---flag/" class="badge">← Home</a>
    <h1>Integration Layer — Public KPIs & Integrity</h1>
    <div class="sub">
      Live signals from the A.B.E. pipeline (CFF → CIRI → CIBS), plus one-click integrity verification.
    </div>
    <div class="nav">
      <a class="btn" href="../cff/index.html">CFF</a>
      <a class="btn" href="../ciri/index.html">CIRI</a>
      <a class="btn" href="../cibs/index.html">CIBS</a>
      <a class="btn" href="../macro/index.html">Macro</a>
      <a class="btn" href="../system/index.html">System Map</a>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- Live KPIs -->
  <div class="grid">
    <div class="tile">
      <div>Public Allocation (CIBS)</div>
      <div id="kpi-cibs-total" class="num">—</div>
      <small>Sum of <code>/cibs/auto_budget.csv</code> (current published plan).</small>
    </div>
    <div class="tile">
      <div>Base Recovery (CIRI only)</div>
      <div id="kpi-ciri-total" class="num">—</div>
      <small>Computed from <code>/ciri/inputs.csv</code> (engine estimate).</small>
    </div>
    <div class="tile">
      <div>OFF_MISSION from CFF (local)</div>
      <div id="kpi-cff-off" class="num">—</div>
      <small>Read from <code>localStorage.ABE_CFF_OFF_MISSION_TOTAL</code>.</small>
    </div>
    <div class="tile">
      <div>Total Recovery (CIRI + CFF)</div>
      <div id="kpi-total-plus-cff" class="num">—</div>
      <small>Base CIRI recovery plus CFF’s OFF_MISSION misuse.</small>
    </div>
    <div class="tile">
      <div>CIRI Index</div>
      <div id="kpi-ciri" class="num">—</div>
      <small>\( CIRI = 1 - e^{-R_T/K} \) with K-scale.</small>
    </div>
    <div class="tile">
      <div>ROI per Case</div>
      <div id="kpi-roi" class="num">—</div>
      <small>\( ROI_{case}=R_T/\max(1,cases) \).</small>
    </div>
  </div>
  <div id="cff-context" class="banner banner-warn">
    No CFF OFF_MISSION transfer detected yet. Run the CFF engine and click
    “Send to CIRI (local only)” to link funding misuse into this view.
  </div>

  <!-- Integrity Controls -->
  <div class="card">
    <h3 style="margin:0 0 .6rem">
      Integrity Beacon
      <span class="kright"><button id="btn-verify" class="btn">Verify Now</button></span>
    </h3>
    <small>
      Runs local, dependency-free checks: file presence, schema plausibility, recomputed KPIs, and SHA-256 hashes.
    </small>
    <div id="beacons" class="grid" style="margin-top:10px">
      <div class="tile"><div><strong>CIRI</strong> (<code>ciri/inputs.csv</code>)</div><div id="b-ciri" class="status">—</div></div>
      <div class="tile"><div><strong>CIBS</strong> (<code>cibs/auto_budget.csv</code>)</div><div id="b-cibs" class="status">—</div></div>
      <div class="tile"><div><strong>CFF</strong> (<code>cff/inputs.csv</code>)</div><div id="b-cff" class="status">—</div></div>
      <div class="tile"><div><strong>CDI</strong> (<code>cdi/divergence.csv</code>)</div><div id="b-cdi" class="status">—</div></div>
      <div class="tile"><div><strong>CAE</strong> (<code>cae/model.json</code>)</div><div id="b-cae" class="status">—</div></div>
    </div>
    <div style="margin-top:10px">
      <button id="btn-download" class="btn" disabled>Download Audit Certificate (JSON)</button>
    </div>
  </div>

  <!-- Detailed Results -->
  <div class="card">
    <h3 style="margin:0 0 .6rem">Verification Results</h3>
    <table>
      <thead><tr><th>Artifact</th><th>Checks</th><th>Status</th><th>SHA-256</th></tr></thead>
      <tbody id="result-rows"></tbody>
    </table>
    <div id="result-meta" style="margin-top:10px" class="mono small"></div>
    <h4 style="margin:16px 0 6px">Raw JSON</h4>
    <pre id="raw" class="code mono" aria-label="Raw audit JSON">—</pre>
  </div>

  <div class="card">
    <h3 style="margin:0 0 .6rem">Audit Trail (sources)</h3>
    <ul>
      <li><a href="/abe---flag/cff/inputs.csv">/cff/inputs.csv</a> — OFF_MISSION funding inputs</li>
      <li><a href="/abe---flag/ciri/inputs.csv">/ciri/inputs.csv</a> — engine inputs</li>
      <li><a href="/abe---flag/cibs/auto_budget.csv">/cibs/auto_budget.csv</a> — public allocation</li>
      <li><a href="/abe---flag/cdi/divergence.csv">/cdi/divergence.csv</a> — divergence inputs</li>
      <li><a href="/abe---flag/cae/model.json">/cae/model.json</a> — alignment corpus map</li>
      <li><a href="/abe---flag/macro/model.html">/macro/model.html</a> — formal equations</li>
      <li><a href="https://doi.org/10.5281/zenodo.17586107">DOI 10.5281/zenodo.17586107</a> — permanent archive</li>
    </ul>
  </div>
</main>

<footer>
  CC BY-NC 4.0 · DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> · Integrity only — never for sale.
</footer>

<script src="/abe---flag/system/integrity.js"></script>
<script>
// ---------- helpers ----------
const money = n => {
  const v = Number(n);
  if (!isFinite(v)) return '—';
  try {
    return new Intl.NumberFormat(undefined,{
      style:'currency',currency:'USD',maximumFractionDigits:0
    }).format(v);
  } catch {
    return '$'+Math.round(v).toLocaleString();
  }
};

// CFF local read
function readCff(){
  let off = 0;
  let ctx = null;
  try{
    const raw = localStorage.getItem('ABE_CFF_OFF_MISSION_TOTAL');
    if(raw) off = Number(raw) || 0;
    const meta = localStorage.getItem('ABE_CFF_CONTEXT');
    if(meta) ctx = JSON.parse(meta);
  }catch(_){}
  return {off,ctx};
}

(async function init(){
  const kCibs  = document.getElementById('kpi-cibs-total');
  const kBase  = document.getElementById('kpi-ciri-total');
  const kCff   = document.getElementById('kpi-cff-off');
  const kTotal = document.getElementById('kpi-total-plus-cff');
  const kIdx   = document.getElementById('kpi-ciri');
  const kRoi   = document.getElementById('kpi-roi');
  const cffBanner = document.getElementById('cff-context');

  // ----- KPIs -----
  async function loadKpis(){
    // CIBS total
    try{
      const r = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
      const t = await r.text();
      const lines = t.trim().split(/\r?\n/);
      const total = lines.slice(1).reduce((s,line)=>{
        const v = Number(line.split(',')[1]); return s + (isFinite(v)?v:0);
      },0);
      kCibs.textContent = money(total);
    }catch(_){}

    // CIRI base
    let totalBase = NaN;
    let idx = NaN;
    let roi = NaN;
    try{
      const r = await fetch('/abe---flag/ciri/inputs.csv',{cache:'no-store'});
      const t = await r.text();
      const [h,d] = t.trim().split(/\r?\n/);
      const keys = h.split(','); const vals = d.split(',').map(Number);
      const o = Object.fromEntries(keys.map((k,i)=>[k.trim(),vals[i]]));

      const c=o.cases_avoided, C=o.avg_cost_per_case, D=o.jail_days_avoided, J=o.cost_per_jail_day,
            F=o.fees_canceled_total, P=o.policy_corrections, E=o.avg_enforcement_cost_savings,
            H=o.households_restored, M=o.avg_monthly_market_spend, m=o.months_effective,
            pe=o.employment_probability, W=o.avg_monthly_wage, L=o.expected_lawsuits,
            A=o.avg_payout, lam=o.litigation_multiplier, T=o.transition_costs_one_time;

      const direct = c*C+F;
      const detention = D*J;
      const enforce = P*E;
      const market = H*M*m;
      const employ = (H*pe)*W*m;
      const litig = L*A*lam;
      totalBase = direct + detention + enforce + market + employ + litig - T;
      const K = 2_000_000_000;
      idx = 1 - Math.exp(- totalBase / K);
      roi = totalBase / Math.max(1,c);
      kBase.textContent = money(totalBase);
      kIdx.textContent = idx.toFixed(2);
      kRoi.textContent = money(roi);
    }catch(_){}

    // CFF local + combined
    const {off,ctx} = readCff();
    if(off && off > 0){
      kCff.textContent = money(off);
      const totalPlus = (isFinite(totalBase)?totalBase:0) + off;
      kTotal.textContent = money(totalPlus);
      cffBanner.classList.remove('banner-warn');
      cffBanner.classList.add('banner-ok');
      cffBanner.innerHTML =
        `CFF OFF_MISSION transfer detected: <strong>${money(off)}</strong> is being treated as part of the recovery pool here.<br>`+
        `<span class="small">Context: ${
          ctx && ctx.source ? ctx.source : 'local CFF run'
        } · ${ctx && ctx.time ? ctx.time : 'timestamp stored locally'}</span>`;
    }else{
      kCff.textContent = '—';
      const totalPlus = isFinite(totalBase)? totalBase : NaN;
      kTotal.textContent = isFinite(totalPlus)? money(totalPlus) : '—';
      cffBanner.classList.remove('banner-ok');
      cffBanner.classList.add('banner-warn');
      cffBanner.textContent =
        'No CFF OFF_MISSION transfer detected yet. Run the CFF engine and click “Send to CIRI (local only)” to link funding misuse into this view.';
    }
  }
  loadKpis();

  // ----- Integrity button -----
  const btn = document.getElementById('btn-verify');
  const dl  = document.getElementById('btn-download');
  btn.addEventListener('click', async ()=>{
    btn.disabled = true; btn.textContent = 'Verifying…';
    const report = await window.runIntegrity({
      base:'/abe---flag',
      files:{
        ciri:'/abe---flag/ciri/inputs.csv',
        cibs:'/abe---flag/cibs/auto_budget.csv',
        cff:'/abe---flag/cff/inputs.csv',
        cdi:'/abe---flag/cdi/divergence.csv',
        cae:'/abe---flag/cae/model.json'
      }
    });

    const set = (id, s) => {
      const el = document.getElementById(id);
      el.className = 'status ' + (s==='ok'?'s-ok':s==='warn'?'s-warn':'s-bad');
      el.textContent = s.toUpperCase();
    };
    set('b-ciri', report.modules.ciri.status);
    set('b-cibs', report.modules.cibs.status);
    if(report.modules.cff) set('b-cff', report.modules.cff.status);
    set('b-cdi',  report.modules.cdi.status);
    set('b-cae',  report.modules.cae.status);

    const rows = [
      ['ciri/inputs.csv',       report.modules.ciri.message, report.modules.ciri.status, report.modules.ciri.sha256],
      ['cibs/auto_budget.csv',  report.modules.cibs.message, report.modules.cibs.status, report.modules.cibs.sha256],
      ['cff/inputs.csv',        report.modules.cff ? report.modules.cff.message : 'included in hash set', report.modules.cff ? report.modules.cff.status : 'ok', report.modules.cff ? report.modules.cff.sha256 : '—'],
      ['cdi/divergence.csv',    report.modules.cdi.message,  report.modules.cdi.status,  report.modules.cdi.sha256],
      ['cae/model.json',        report.modules.cae.message,  report.modules.cae.status,  report.modules.cae.sha256],
    ];
    document.getElementById('result-rows').innerHTML =
      rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2].toUpperCase()}</td><td class="mono">${r[3]}</td></tr>`).join('');

    document.getElementById('raw').textContent = JSON.stringify(report,null,2);
    document.getElementById('result-meta').textContent =
      `audit_id: ${report.audit_id} • generated_at: ${report.generated_at}`;

    dl.disabled = false;
    dl.onclick = ()=>{
      const blob = new Blob([JSON.stringify(report,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `abe_audit_${report.audit_id}.json`; a.click();
      URL.revokeObjectURL(url);
    };

    btn.disabled = false; btn.textContent = 'Verify Now';
  });
})();
</script>
</body>
</html>
