<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Integration — A.B.E. Public KPIs & Integrity</title>
<base href="/abe---flag/">
<style>
:root{
  --bg:#0b0d12;--panel:#141820;--panel2:#0f131a;--ink:#e6e6e6;--muted:#9fb3c8;
  --line:rgba(255,255,255,.08);--brand:#5ddfff;--warn:#ffa559;--ok:#4bd28f;--bad:#ff6b6b
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui}
a{color:#80bfff} a:hover{text-decoration:underline}
header{padding:24px 20px;background:linear-gradient(90deg,#11151c,#1b1e25);border-bottom:1px solid var(--line)}
.wrap{max-width:1100px;margin:0 auto;padding:24px 20px}
h1{margin:0 0 6px}
.sub{color:var(--muted)}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin:18px 0}
.tile{background:var(--panel2);border:1px solid var(--line);border-radius:10px;padding:14px}
.num{font-size:1.35rem;font-weight:700}
small{color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:10px 12px;text-align:left}
th{background:var(--panel2)}
footer{margin:36px 0 20px;color:var(--muted);text-align:center;font-size:.9rem}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
.btn{display:inline-block;border:1px solid var(--line);background:#0f131a;color:#e6e6e6;padding:.55rem .9rem;border-radius:9px;text-decoration:none;cursor:pointer}
.btn:hover{border-color:var(--brand)}
.status{display:inline-block;padding:.1rem .5rem;border-radius:999px;border:1px solid var(--line);font-size:.85rem}
.s-ok{background:rgba(75,210,143,.12);color:var(--ok);border-color:rgba(75,210,143,.35)}
.s-warn{background:rgba(255,165,89,.12);color:var(--warn);border-color:rgba(255,165,89,.35)}
.s-bad{background:rgba(255,107,107,.12);color:var(--bad);border-color:rgba(255,107,107,.35)}
.kright{float:right}
pre.code{white-space:pre-wrap;background:#0f131a;border:1px solid var(--line);border-radius:10px;padding:12px;overflow:auto}
.mono{font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="/abe---flag/" class="badge">← Home</a>
    <h1>Integration Layer — Public KPIs & Integrity</h1>
    <div class="sub">Live signals from the A.B.E. pipeline (CIRI → CIBS), plus one-click integrity verification.</div>
  </div>
</header>

<main class="wrap">
  <!-- Live KPIs -->
  <div class="grid">
    <div class="tile">
      <div>Public Allocation (CIBS)</div>
      <div id="kpi-cibs-total" class="num">—</div>
      <small>Sum of <code>/cibs/auto_budget.csv</code> (current published plan)</small>
    </div>
    <div class="tile">
      <div>Modeled Recovery (CIRI)</div>
      <div id="kpi-ciri-total" class="num">—</div>
      <small>Computed from <code>/ciri/inputs.csv</code> (engine estimate)</small>
    </div>
    <div class="tile">
      <div>CIRI Index</div>
      <div id="kpi-ciri" class="num">—</div>
      <small>\( CIRI = 1 - e^{-R_T/K} \) with K-scale</small>
    </div>
    <div class="tile">
      <div>ROI per Case</div>
      <div id="kpi-roi" class="num">—</div>
      <small>\( ROI_{case}=R_T/\max(1,cases) \)</small>
    </div>
  </div>

  <!-- Integrity Controls -->
  <div class="card">
    <h3 style="margin:0 0 .6rem">Integrity Beacon<span class="kright"><button id="btn-verify" class="btn">Verify Now</button></span></h3>
    <small>Runs local, dependency-free checks: file presence, schema plausibility, recomputed KPIs, and SHA-256 hashes.</small>
    <div id="beacons" class="grid" style="margin-top:10px">
      <div class="tile"><div><strong>CIRI</strong> (<code>ciri/inputs.csv</code>)</div><div id="b-ciri" class="status">—</div></div>
      <div class="tile"><div><strong>CIBS</strong> (<code>cibs/auto_budget.csv</code>)</div><div id="b-cibs" class="status">—</div></div>
      <div class="tile"><div><strong>CDI</strong> (<code>cdi/divergence.csv</code>)</div><div id="b-cdi" class="status">—</div></div>
      <div class="tile"><div><strong>CAE</strong> (<code>cae/model.json</code>)</div><div id="b-cae" class="status">—</div></div>
    </div>
    <div style="margin-top:10px">
      <button id="btn-download" class="btn" disabled>Download Audit Certificate (JSON)</button>
    </div>
  </div>

  <!-- Detailed Results -->
  <div class="card">
    <h3 style="margin:0 0 .6rem">Verification Results</h3>
    <table>
      <thead><tr><th>Artifact</th><th>Checks</th><th>Status</th><th>SHA-256</th></tr></thead>
      <tbody id="result-rows"></tbody>
    </table>
    <div id="result-meta" style="margin-top:10px" class="mono small"></div>
    <h4 style="margin:16px 0 6px">Raw JSON</h4>
    <pre id="raw" class="code mono" aria-label="Raw audit JSON">—</pre>
  </div>

  <div class="card">
    <h3 style="margin:0 0 .6rem">Audit Trail (sources)</h3>
    <ul>
      <li><a href="/abe---flag/ciri/inputs.csv">/ciri/inputs.csv</a> — engine inputs</li>
      <li><a href="/abe---flag/cibs/auto_budget.csv">/cibs/auto_budget.csv</a> — public allocation</li>
      <li><a href="/abe---flag/cdi/divergence.csv">/cdi/divergence.csv</a> — divergence inputs</li>
      <li><a href="/abe---flag/cae/model.json">/cae/model.json</a> — alignment corpus map</li>
      <li><a href="/abe---flag/macro/model.html">/macro/model.html</a> — formal equations</li>
      <li><a href="https://doi.org/10.5281/zenodo.17586107">DOI 10.5281/zenodo.17586107</a> — permanent archive</li>
    </ul>
  </div>
</main>

<footer>
  CC BY-NC 4.0 · DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> · Integrity only — never for sale.
</footer>

<script src="/abe---flag/system/integrity.js"></script>
<script>
(async function init(){
  // quick KPIs (same as before)
  const fmt = n => '$' + (isFinite(n)? Math.round(n).toLocaleString() : '—');

  async function kpis(){
    // CIBS total
    try{
      const r = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
      const t = await r.text();
      const lines = t.trim().split(/\r?\n/);
      const total = lines.slice(1).reduce((s,line)=>{
        const v = Number(line.split(',')[1]); return s + (isFinite(v)?v:0);
      },0);
      document.getElementById('kpi-cibs-total').textContent = fmt(total);
    }catch{}

    // CIRI derived
    try{
      const r = await fetch('/abe---flag/ciri/inputs.csv',{cache:'no-store'});
      const t = await r.text();
      const [h,d] = t.trim().split(/\r?\n/);
      const keys = h.split(','); const vals = d.split(',').map(Number);
      const o = Object.fromEntries(keys.map((k,i)=>[k.trim(),vals[i]]));

      const c=o.cases_avoided, C=o.avg_cost_per_case, D=o.jail_days_avoided, J=o.cost_per_jail_day,
            F=o.fees_canceled_total, P=o.policy_corrections, E=o.avg_enforcement_cost_savings,
            H=o.households_restored, M=o.avg_monthly_market_spend, m=o.months_effective,
            pe=o.employment_probability, W=o.avg_monthly_wage, L=o.expected_lawsuits,
            A=o.avg_payout, lam=o.litigation_multiplier, T=o.transition_costs_one_time;

      const total = (c*C+F) + (D*J) + (P*E) + (H*M*m) + ((H*pe)*W*m) + (L*A*lam) - T;
      const K = 2_000_000_000;
      const CIRI = 1 - Math.exp(- total / K);
      const ROI  = total / Math.max(1,c);
      document.getElementById('kpi-ciri-total').textContent = fmt(total);
      document.getElementById('kpi-ciri').textContent = CIRI.toFixed(2);
      document.getElementById('kpi-roi').textContent = fmt(ROI);
    }catch{}
  }
  kpis();

  // integrity button
  const btn = document.getElementById('btn-verify');
  const dl  = document.getElementById('btn-download');
  btn.addEventListener('click', async ()=>{
    btn.disabled = true; btn.textContent = 'Verifying…';
    const report = await window.runIntegrity({
      base:'/abe---flag',
      files:{
        ciri:'/abe---flag/ciri/inputs.csv',
        cibs:'/abe---flag/cibs/auto_budget.csv',
        cdi:'/abe---flag/cdi/divergence.csv',
        cae:'/abe---flag/cae/model.json'
      }
    });

    // beacons
    const set = (id, s) => {
      const el = document.getElementById(id);
      el.className = 'status ' + (s==='ok'?'s-ok':s==='warn'?'s-warn':'s-bad');
      el.textContent = s.toUpperCase();
    };
    set('b-ciri', report.modules.ciri.status);
    set('b-cibs', report.modules.cibs.status);
    set('b-cdi',  report.modules.cdi.status);
    set('b-cae',  report.modules.cae.status);

    // table
    const rows = [
      ['ciri/inputs.csv', report.modules.ciri.message, report.modules.ciri.status, report.modules.ciri.sha256],
      ['cibs/auto_budget.csv', report.modules.cibs.message, report.modules.cibs.status, report.modules.cibs.sha256],
      ['cdi/divergence.csv', report.modules.cdi.message, report.modules.cdi.status, report.modules.cdi.sha256],
      ['cae/model.json', report.modules.cae.message, report.modules.cae.status, report.modules.cae.sha256],
    ];
    document.getElementById('result-rows').innerHTML =
      rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2].toUpperCase()}</td><td class="mono">${r[3]}</td></tr>`).join('');

    document.getElementById('raw').textContent = JSON.stringify(report,null,2);
    document.getElementById('result-meta').textContent =
      `audit_id: ${report.audit_id} • generated_at: ${report.generated_at}`;

    // download certificate
    dl.disabled = false;
    dl.onclick = ()=>{
      const blob = new Blob([JSON.stringify(report,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `abe_audit_${report.audit_id}.json`; a.click();
      URL.revokeObjectURL(url);
    };

    btn.disabled = false; btn.textContent = 'Verify Now';
  });
})();
</script>
</body>
</html>
