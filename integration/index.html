<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Integration — A.B.E. Public KPIs</title>
<base href="/abe---flag/">
<style>
:root{
  --bg:#0b0d12;--panel:#141820;--panel2:#0f131a;--ink:#e6e6e6;--muted:#9fb3c8;
  --line:rgba(255,255,255,.08);--brand:#5ddfff;--warn:#ffa559;--ok:#4bd28f
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui}
a{color:#80bfff} a:hover{text-decoration:underline}
header{padding:24px 20px;background:linear-gradient(90deg,#11151c,#1b1e25);border-bottom:1px solid var(--line)}
.wrap{max-width:1100px;margin:0 auto;padding:24px 20px}
h1{margin:0 0 6px}
.sub{color:var(--muted)}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin:18px 0}
.tile{background:var(--panel2);border:1px solid var(--line);border-radius:10px;padding:14px}
.num{font-size:1.35rem;font-weight:700}
small{color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:10px 12px;text-align:left}
th{background:var(--panel2)}
footer{margin:36px 0 20px;color:var(--muted);text-align:center;font-size:.9rem}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="/abe---flag/" class="badge">← Home</a>
    <h1>Integration Layer — Public KPIs</h1>
    <div class="sub">Live signals from the A.B.E. pipeline (CIRI → CIBS). Data is read directly from the repo.</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <div class="tile">
      <div>Public Allocation (CIBS)</div>
      <div id="kpi-cibs-total" class="num">—</div>
      <small>Sum of <code>/cibs/auto_budget.csv</code> (current published plan)</small>
    </div>
    <div class="tile">
      <div>Modeled Recovery (CIRI)</div>
      <div id="kpi-ciri-total" class="num">—</div>
      <small>Computed from <code>/ciri/inputs.csv</code> (engine estimate)</small>
    </div>
    <div class="tile">
      <div>CIRI Index</div>
      <div id="kpi-ciri" class="num">—</div>
      <small>\( CIRI = 1 - e^{-R_T/K} \) with K-scale</small>
    </div>
    <div class="tile">
      <div>ROI per Case</div>
      <div id="kpi-roi" class="num">—</div>
      <small>\( ROI_{case}=R_T/\max(1,cases) \)</small>
    </div>
  </div>

  <div class="card">
    <h3>Audit Trail (source files)</h3>
    <ul>
      <li><a href="/abe---flag/ciri/inputs.csv">/ciri/inputs.csv</a> — engine inputs</li>
      <li><a href="/abe---flag/cibs/auto_budget.csv">/cibs/auto_budget.csv</a> — public allocation</li>
      <li><a href="/abe---flag/macro/model.html">/macro/model.html</a> — formal equations</li>
      <li><a href="https://doi.org/10.5281/zenodo.17586107">DOI 10.5281/zenodo.17586107</a> — permanent archive</li>
    </ul>
  </div>

  <div class="card">
    <h3>Recovery Breakdown (Model View)</h3>
    <table>
      <thead><tr><th>Component</th><th>Formula</th><th>Value (USD)</th></tr></thead>
      <tbody id="breakdown-body"></tbody>
      <tfoot><tr><th>Total</th><th></th><th id="breakdown-total">—</th></tr></tfoot>
    </table>
    <small>Formulas shown reflect the demonstration configuration we’ve used in this thread; you can toggle strict v2 below.</small>
  </div>

  <div class="card">
    <h3>Configuration</h3>
    <p><label><input type="checkbox" id="strictV2"> Use strict v2 formulas (employment = cases-based; detention = cases × days × cost)</label></p>
    <small>Unchecked = demonstration mode (employment uses households; detention uses aggregate days).</small>
  </div>
</main>

<footer>
  CC BY-NC 4.0 · DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> · Integrity only — never for sale.
</footer>

<script>
(async function(){
  // ---------- Helpers ----------
  const fmtUSD = n => '$' + (isFinite(n)? Math.round(n).toLocaleString() : '—');

  // ---------- Pull CIBS total ----------
  async function getCibsTotal(){
    const res = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
    const text = await res.text();
    const lines = text.trim().split(/\r?\n/);
    const rows = lines.slice(1).map(l => Number(l.split(',')[1]));
    return rows.reduce((a,b)=>a+(isFinite(b)?b:0),0);
  }

  // ---------- Pull CIRI inputs and compute model ----------
  async function getCiriComputed(strict=false){
    const res = await fetch('/abe---flag/ciri/inputs.csv',{cache:'no-store'});
    const t = await res.text();
    const [header, data] = t.trim().split(/\r?\n/);
    const keys = header.split(',');
    const vals = data.split(',').map(x => Number(x));
    const obj = Object.fromEntries(keys.map((k,i)=>[k.trim(), vals[i]]));

    // Unpack
    const c = obj.cases_avoided;
    const avg_case = obj.avg_cost_per_case;
    const jail_days = obj.jail_days_avoided;
    const jail_cost = obj.cost_per_jail_day;
    const fees = obj.fees_canceled_total;
    const pc = obj.policy_corrections;
    const en_sav = obj.avg_enforcement_cost_savings;
    const hh = obj.households_restored;
    const mkt = obj.avg_monthly_market_spend;
    const months = obj.months_effective;
    const p_emp = obj.employment_probability;
    const wage = obj.avg_monthly_wage;
    const lawsuits = obj.expected_lawsuits;
    const payout = obj.avg_payout;
    const lambda = obj.litigation_multiplier;
    const trans = obj.transition_costs_one_time;

    // Components (two modes for consistency vs strict v2 spec)
    const direct_case = c * avg_case + fees;

    const detention = strict
      ? c * jail_days * jail_cost
      : jail_days * jail_cost;

    const enforcement = pc * en_sav;

    const market_access = hh * mkt * months;

    const employment = strict
      ? c * p_emp * wage * (months/12)
      : (hh * p_emp) * wage * months;

    const litigation = lawsuits * payout * lambda;

    const total = direct_case + detention + enforcement + market_access + employment + litigation - trans;

    // Indices
    const K = 2_000_000_000; // scaling constant (tunable per jurisdiction size)
    const CIRI = 1 - Math.exp(- total / K);
    const CII = 1 - CIRI;
    const ROIcase = total / Math.max(1,c);

    return {
      components: {direct_case, detention, enforcement, market_access, employment, litigation, transition: -trans},
      total, CIRI, CII, ROIcase
    };
  }

  // ---------- Render ----------
  async function render(strict=false){
    // CIBS
    const cibsTotal = await getCibsTotal();
    document.getElementById('kpi-cibs-total').textContent = fmtUSD(cibsTotal);

    // CIRI
    const model = await getCiriComputed(strict);
    document.getElementById('kpi-ciri-total').textContent = fmtUSD(model.total);
    document.getElementById('kpi-ciri').textContent = (model.CIRI).toFixed(2);
    document.getElementById('kpi-roi').textContent = fmtUSD(model.ROIcase);

    // Breakdown table
    const tbody = document.getElementById('breakdown-body');
    const rows = [
      ['Direct case','c × avg_cost + fees', model.components.direct_case],
      ['Detention', strict ? 'c × days × $/day' : 'days × $/day', model.components.detention],
      ['Enforcement','policy_corr × avg_savings', model.components.enforcement],
      ['Market access','households × spend × months', model.components.market_access],
      ['Employment', strict ? 'cases × p_emp × wage × (m/12)' : 'households × p_emp × wage × months', model.components.employment],
      ['Litigation','lawsuits × payout × λ', model.components.litigation],
      ['Transition','− transition_costs', model.components.transition]
    ];
    tbody.innerHTML = rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${fmtUSD(r[2])}</td></tr>`).join('');
    document.getElementById('breakdown-total').textContent = fmtUSD(model.total);
  }

  // Initial render (demo mode for continuity with our walkthrough)
  render(false);

  // Toggle for strict v2 formulas
  document.getElementById('strictV2').addEventListener('change', e=>{
    render(!!e.target.checked);
  });
})();
</script>
</body></html>
