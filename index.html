<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>The American Butterfly Effect (A.B.E.) — System Hub</title>
<base href="/abe---flag/">

<style>
:root{
  --bg:#0b0d12; --panel:#141820; --panel2:#0f131a; --ink:#e6e6e6; --muted:#9fb3c8;
  --line:rgba(255,255,255,.08); --brand:#5ddfff; --accent:#fff750; --ok:#4bd28f; --warn:#ffa559
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
a{color:#80bfff;text-decoration:none} a:hover{text-decoration:underline}
header{padding:28px 20px;background:linear-gradient(90deg,#11151c,#1b1e25);border-bottom:1px solid var(--line)}
.wrap{max-width:1100px;margin:0 auto;padding:0 20px}
h1{margin:0 0 6px}
.sub{color:var(--muted)}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badges a,.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
.grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
.tile{background:var(--panel2);border:1px solid var(--line);border-radius:10px;padding:14px}
.kpi{display:flex;gap:14px;flex-wrap:wrap}
.kpi .tile{flex:1 1 220px}
.num{font-weight:700;font-size:1.25rem}
small{color:var(--muted)}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid var(--line);padding:10px 12px;text-align:left}
.table th{background:var(--panel2)}
.status{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid var(--line);font-size:.85rem}
.ok{color:var(--ok);border-color:rgba(75,210,143,.35)}
.warn{color:var(--warn);border-color:rgba(255,165,89,.35)}
footer{margin:40px 0 24px;text-align:center;color:var(--muted);font-size:.9rem}
hr{border:none;border-top:1px solid var(--line);margin:18px 0}
@media (max-width:720px){.kpi .tile{flex:1 1 100%}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>The American Butterfly Effect (A.B.E.)</h1>
    <div class="sub" id="version-line">Constitutional & economic restoration framework — public, auditable, non-commercial.</div>
    <div class="badges">
      <a href="https://doi.org/10.5281/zenodo.17586107" title="DOI: 10.5281/zenodo.17586107">
        <img src="https://zenodo.org/badge/DOI/10.5281/zenodo.17586107.svg" alt="DOI badge" height="18"/>
      </a>
      <span class="chip">License: CC BY-NC 4.0</span>
      <a class="chip" href="doctrine/index.html">Doctrine Library</a>
      <a class="chip" href="system/index.html">System Map</a>
      <a class="chip" href="macro/index.html">Macro Model</a>
    </div>
  </div>
</header>

<main class="wrap" style="margin:24px auto 44px">
  <!-- System Overview -->
  <div class="card">
    <h2 style="margin:0 0 8px;color:var(--accent)">What A.B.E. Does</h2>
    <p style="margin:.25rem 0 0">
      A.B.E. converts <em>constitutional alignment</em> into <em>measurable, auditable economics</em>:
      <strong>CAE</strong> (law parsing) → <strong>CDI</strong> (divergence signal) → <strong>CIRI</strong> (recovery value) → 
      <strong>CIBS</strong> (budget) → <strong>CFF</strong> (funding forensics) → <strong>CII</strong> (projects) → <strong>Integration</strong> (receipts & attestations).
    </p>
  </div>

  <!-- Live KPIs -->
  <div class="card">
    <h3 style="margin:0 0 8px">Live KPIs</h3>
    <div class="kpi">
      <div class="tile">
        <div>Modeled Recovery (CIRI)</div>
        <div id="k-ciri" class="num">—</div>
        <small>Computed from <code>/ciri/inputs.csv</code></small>
      </div>
      <div class="tile">
        <div>CIRI Index</div>
        <div id="k-ciri-idx" class="num">—</div>
        <small>\( 1 - e^{-R_T/K} \) with K-scale</small>
      </div>
      <div class="tile">
        <div>Public Allocation (CIBS)</div>
        <div id="k-cibs" class="num">—</div>
        <small>Sum of <code>/cibs/auto_budget.csv</code></small>
      </div>
      <div class="tile">
        <div>ROI per Case</div>
        <div id="k-roi" class="num">—</div>
        <small>\( R_T/\max(1,cases\_avoided) \)</small>
      </div>
    </div>
  </div>

  <!-- Subsystems -->
  <div class="grid">
    <div class="card">
      <h3>CAE — Constitutional Alignment Engine</h3>
      <p>Parses the Constitution & positive law; flags misalignment with citations.</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="cae/index.html">cae/index.html</a></td></tr>
        <tr><th>Schema</th><td id="s-cae" class="status warn">Checking…</td></tr>
        <tr><th>Model</th><td><a href="cae/model.json">model.json</a></td></tr>
        <tr><th>Report</th><td><a href="cae/report.csv">report.csv</a></td></tr>
      </tbody></table>
    </div>

    <div class="card">
      <h3>CDI — Constitutional Divergence Index</h3>
      <p>Normalizes CAE findings into a 0–1 signal by domain/jurisdiction.</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="cdi/index.html">cdi/index.html</a></td></tr>
        <tr><th>Schema</th><td id="s-cdi" class="status warn">Checking…</td></tr>
        <tr><th>Model</th><td><a href="cdi/model.json">model.json</a></td></tr>
        <tr><th>Data</th><td><a href="cdi/divergence.csv">divergence.csv</a></td></tr>
      </tbody></table>
    </div>

    <div class="card">
      <h3>CIRI — Integrity ROI Engine</h3>
      <p>Turns divergence + local inputs into recovery dollars and indices.</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="ciri/index.html">ciri/index.html</a></td></tr>
        <tr><th>Schema</th><td id="s-ciri" class="status warn">Checking…</td></tr>
        <tr><th>Inputs</th><td><a href="ciri/inputs.csv">inputs.csv</a></td></tr>
        <tr><th>Spec</th><td><a href="ciri/calc.md">calc.md</a></td></tr>
      </tbody></table>
    </div>

    <div class="card">
      <h3>CIBS — Integrity Baseline Schema</h3>
      <p>Allocates the Recovery Pool into public reinvestment buckets.</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="cibs/index.html">cibs/index.html</a></td></tr>
        <tr><th>Schema</th><td id="s-cibs" class="status warn">Checking…</td></tr>
        <tr><th>Template</th><td><a href="cibs/budget_template.csv">budget_template.csv</a></td></tr>
        <tr><th>Auto Budget</th><td><a href="cibs/auto_budget.csv">auto_budget.csv</a></td></tr>
      </tbody></table>
    </div>

    <!-- NEW: CFF -->
    <div class="card">
      <h3>CFF — Constitutional Funding Forensics</h3>
      <p>Follows federal appropriation law → state statute → line-item spend. Calculates On-Mission vs Off-Mission dollars and Overreach Index.</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="cff/index.html">cff/index.html</a></td></tr>
        <tr><th>Schema</th><td id="s-cff" class="status warn">Checking…</td></tr>
        <tr><th>Demo Data</th><td><a href="cff/inputs.csv">inputs.csv</a></td></tr>
        <tr><th>Spec</th><td><a href="cff/spec.md">spec.md</a> (coming)</td></tr>
      </tbody></table>
    </div>

    <div class="card">
      <h3>CII — Community Investment Interface</h3>
      <p>Publishes auditable portfolios (housing, clinics, food, mobility, workforce).</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="cii/index.html">cii/index.html</a></td></tr>
        <tr><th>Schema</th><td id="s-cii" class="status warn">Checking…</td></tr>
        <tr><th>Model</th><td><a href="cii/model.json">model.json</a></td></tr>
        <tr><th>Portfolio</th><td><a href="cii/portfolio.csv">portfolio.csv</a></td></tr>
      </tbody></table>
    </div>

    <div class="card">
      <h3>Integration Layer</h3>
      <p>Receipts, recipient match, retaliation zero, and public attestations.</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="integration/index.html">integration/index.html</a></td></tr>
        <tr><th>Schema</th><td id="s-integration" class="status warn">Checking…</td></tr>
      </tbody></table>
    </div>

    <div class="card">
      <h3>System Map</h3>
      <p>Canonical chain-of-custody & evidence ledger for A.B.E.</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="system/index.html">system/index.html</a></td></tr>
        <tr><th>Map</th><td><a href="system/map.json">map.json</a></td></tr>
      </tbody></table>
    </div>

    <div class="card">
      <h3>Macro — Cascade Model</h3>
      <p>Top-down impact summary; optional artifacts & downloads.</p>
      <table class="table"><tbody>
        <tr><th>UI</th><td><a href="macro/index.html">macro/index.html</a></td></tr>
        <tr><th>Model</th><td><a href="macro/model.json">model.json</a></td></tr>
        <tr><th>Downloads</th><td><a href="macro/macro_cascade.csv">macro_cascade.csv</a></td></tr>
      </tbody></table>
    </div>
  </div>

  <!-- Schema Status Summary -->
  <div class="card">
    <h3 style="margin:0 0 8px">Schema Status Summary</h3>
    <div class="grid" id="schema-grid"></div>
    <small>Green = schema file found and non-empty; Orange = missing or empty.</small>
  </div>
</main>

<footer>
  CC BY-NC 4.0 · DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
  <em>Integrity only — never for sale.</em>
</footer>

<script>
// helpers
const money = n => {
  const v = Number(n);
  if (!isFinite(v)) return '—';
  try { return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}).format(v); }
  catch { return '$'+Math.round(v).toLocaleString(); }
};

function setStatus(id, ok){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = ok ? 'Schema present' : 'Missing';
  el.classList.toggle('ok', ok);
  el.classList.toggle('warn', !ok);
}

// version line
(async ()=>{
  try{
    const r = await fetch('system/map.json',{cache:'no-store'});
    if(!r.ok) throw 0;
    const j = await r.json();
    const el = document.getElementById('version-line');
    if(el) el.textContent = `Constitutional & economic restoration framework — v\( {j.version||'—'} · updated \){j.updated||''}`;
  }catch(_){}
})();

// live KPIs (CIRI + CIBS)
(async ()=>{
  try{ // CIBS
    const r = await fetch('cibs/auto_budget.csv',{cache:'no-store'});
    const t = await r.text();
    const total = t.trim().split(/\r?\n/).slice(1).reduce((s,l)=>s+Number(l.split(',')[1]||0),0);
    document.getElementById('k-cibs').textContent = money(total);
  }catch(_){}

  try{ // CIRI (baseline from repo inputs)
    const r = await fetch('ciri/inputs.csv',{cache:'no-store'});
    const t = await r.text();
    const lines = t.trim().split(/\r?\n/);
    const keys = lines[0].split(',').map(s=>s.trim());
    const vals = lines[1].split(',').map(s=>Number(s.trim()));
    const d = Object.fromEntries(keys.map((k,i)=>[k,vals[i]||0]));

    const total = d.cases_avoided*d.avg_cost_per_case +
                  d.jail_days_avoided*d.cost_per_jail_day +
                  d.fees_canceled_total +
                  d.policy_corrections*d.avg_enforcement_cost_savings +
                  d.households_restored*d.avg_monthly_market_spend*d.months_effective +
                  d.households_restored*d.employment_probability*d.avg_monthly_wage*d.months_effective/12 +
                  d.expected_lawsuits*d.avg_payout*(d.litigation_multiplier||d.multiplier||1) -
                  d.transition_costs_one_time;

    const K = 2_000_000_000;
    const ciri = 1 - Math.exp(-Math.max(0,total)/K);
    const roi  = total / Math.max(1, d.cases_avoided);

    document.getElementById('k-ciri').textContent = money(total);
    document.getElementById('k-ciri-idx').textContent = ciri.toFixed(2);
    document.getElementById('k-roi').textContent = money(roi);
  }catch(_){}
})();

// schema checks — now includes CFF
(async ()=>{
  const targets = [
    {key:'CAE', id:'s-cae', path:'cae/schema.json'},
    {key:'CDI', id:'s-cdi', path:'cdi/schema.json'},
    {key:'CIRI',id:'s-ciri',path:'ciri/schema.json'},
    {key:'CIBS',id:'s-cibs',path:'cibs/schema.json'},
    {key:'CFF', id:'s-cff', path:'cff/schema.json'},      // ← new
    {key:'CII', id:'s-cii', path:'cii/schema.json'},
    {key:'Integration',id:'s-integration',path:'integration/schema.json'}
  ];

  for(const t of targets){
    try{
      const r = await fetch(t.path,{cache:'no-store'});
      const ok = r.ok && (await r.text()).trim().length>0;
      setStatus(t.id, ok);
    }catch(_){
      setStatus(t.id,false);
    }
  }

  const grid = document.getElementById('schema-grid');
  if(grid){
    grid.innerHTML = targets.map(t=>`
      <div class="tile">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>${t.key}</strong>
          <span id="sum-${t.id}" class="status warn">Checking…</span>
        </div>
        <small><code>${t.path}</code></small>
      </div>`).join('');

    targets.forEach(t=>{
      const el = document.getElementById(`sum-${t.id}`);
      const src = document.getElementById(t.id);
      if(el && src){
        el.textContent = src.textContent;
        el.className = src.className;
      }
    });
  }
})();
</script>
</body>
</html>
