<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Integration Layer — Public KPIs & Integrity | A.B.E.</title>

  <!-- Critical: forces all links to resolve from repo root -->
  <base href="/abe---flag/" />

  <style>
    :root {
      --bg:#0b0d12;
      --panel:#141820;
      --panel2:#10141b;
      --line:rgba(255,255,255,.08);
      --brand:#4ac2ff;
      --muted:#8aa0b8;
    }
    * { box-sizing:border-box }
    body {
      margin:0;
      background:var(--bg);
      color:white;
      font-family:system-ui, sans-serif;
    }
    header {
      padding:24px 20px;
      background:linear-gradient(to bottom,#0d1117,#0b0d12);
      border-bottom:1px solid var(--line);
    }
    main {
      max-width:1100px;
      margin:22px auto;
      padding:0 16px;
    }
    h1 { margin:0 0 .5rem; font-size:2rem }
    h2 { margin:0 0 1rem; font-size:1.4rem }
    h3 { margin:.4rem 0; font-size:1.2rem }
    p.muted { color:var(--muted); margin:.2rem 0 1rem }

    .pill-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:18px 0 28px;
    }
    .pill {
      display:inline-flex;
      align-items:center;
      padding:8px 18px;
      border-radius:999px;
      background:var(--panel2);
      border:1px solid var(--line);
      color:white;
      text-decoration:none;
      font-size:.95rem;
    }
    .pill:hover {
      border-color:var(--brand);
      text-decoration:none;
    }

    .card {
      background:var(--panel);
      border:1px solid var(--line);
      padding:18px 20px;
      margin:20px 0;
      border-radius:10px;
    }

    .big-number {
      font-size:2rem;
      font-weight:700;
      margin:4px 0;
    }

    .ok {
      display:inline-block;
      background:#0f772e;
      padding:3px 10px;
      border-radius:6px;
      font-size:.85rem;
    }

    .sha-block {
      font-family:monospace;
      background:var(--panel2);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:6px;
      margin-top:8px;
      word-break:break-all;
      font-size:.8rem;
    }
  </style>
</head>

<body>

<header>
  <a href="index.html" style="color:var(--brand);text-decoration:none;">← Home</a>
  <h1>Integration Layer — Public KPIs & Integrity</h1>
  <p class="muted">Live signals from the A.B.E. pipeline (CFF → CIRI → CIBS), plus one-click integrity verification.</p>

  <div class="pill-row">
    <a class="pill" href="cff/index.html">CFF</a>
    <a class="pill" href="ciri/index.html">CIRI</a>
    <a class="pill" href="cibs/index.html">CIBS</a>
    <a class="pill" href="macro/index.html">Macro</a>
    <a class="pill" href="system/index.html">System Map</a>
  </div>
</header>

<main>

  <!-- ====================== PUBLIC CIBS ====================== -->
  <div class="card">
    <h2>Public Allocation (CIBS)</h2>
    <div class="big-number" id="pub-cibs">$0</div>
    <p class="muted">Sum of <code>/cibs/auto_budget.csv</code> (current published plan).</p>
  </div>

  <!-- ====================== CIRI ====================== -->
  <div class="card">
    <h2>Base Recovery (CIRI only)</h2>
    <div class="big-number" id="pub-ciri">$0</div>
    <p class="muted">Baseline model using <code>ciri/inputs.csv</code>.</p>
  </div>

  <!-- ====================== CFF ====================== -->
  <div class="card">
    <h2>OFF_MISSION (CFF)</h2>
    <div class="big-number" id="pub-cff">$0</div>
    <p class="muted">Direct handoff to CIRI on this device.</p>
  </div>

  <!-- ====================== INTEGRITY BEACON ====================== -->
  <div class="card">
    <h2>Integrity Beacon</h2>
    <p class="muted">Runs local checks: file presence, schema plausibility, recomputed KPIs, and SHA-256 hashes.</p>
    <button id="verify" class="pill" style="cursor:pointer;">Verify Now</button>

    <div id="beacon-results" style="margin-top:18px;"></div>
  </div>

</main>

<script>
/* --------------------------------------------
   LOAD CSV helpers
-------------------------------------------- */
async function csv(url){
  const res = await fetch(url);
  const text = await res.text();
  const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
  const header = rows[0];
  const data = rows.slice(1).map(r => Object.fromEntries(r.map((v,i)=>[header[i], v])));
  return data;
}

/* --------------------------------------------
   Populate public KPIs
-------------------------------------------- */
(async()=>{
  // CIBS budget sum
  try {
    const b = await csv('cibs/auto_budget.csv');
    const sum = b.reduce((a,x)=>a + (parseFloat(x.amount)||0), 0);
    document.getElementById('pub-cibs').textContent =
      sum.toLocaleString('en-US', {style:'currency',currency:'USD'});
  } catch(_){}

  // CIRI base recovery
  try {
    const d = (await csv('ciri/inputs.csv'))[0];
    const direct = parseFloat(d.avg_cost_per_case)*parseFloat(d.cases_avoided);
    const detention = parseFloat(d.jail_days_avoided)*parseFloat(d.cost_per_jail_day);
    const enf = parseFloat(d.avg_enforcement_cost_savings);
    const total = direct + detention + enf;
    document.getElementById('pub-ciri').textContent =
      total.toLocaleString('en-US', {style:'currency',currency:'USD'});
  } catch(_){}

  // CFF OFF_MISSION
  try {
    const d = (await csv('cff/inputs.csv'))[0];
    const off = parseFloat(d.OFF_MISSION||0);
    document.getElementById('pub-cff').textContent =
      off.toLocaleString('en-US', {style:'currency',currency:'USD'});
  } catch(_){}
})();

/* --------------------------------------------
   Integrity Beacon
-------------------------------------------- */
document.getElementById('verify').onclick = async ()=>{
  const out = document.getElementById('beacon-results');
  out.innerHTML = "<p class='muted'>Checking files…</p>";

  const files = [
    {label:"CIRI (ciri/inputs.csv)", path:"ciri/inputs.csv"},
    {label:"CIBS (cibs/auto_budget.csv)", path:"cibs/auto_budget.csv"},
    {label:"CFF (cff/inputs.csv)", path:"cff/inputs.csv"},
    {label:"CDI (cdi/divergence.csv)", path:"cdi/divergence.csv"},
    {label:"CAE (cae/model.json)", path:"cae/model.json"}
  ];

  const html = [];

  for(const f of files){
    try{
      const res = await fetch(f.path);
      if(!res.ok) throw 0;
      const text = await res.text();

      // SHA-256
      const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
      const hex = [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,"0")).join("");

      html.push(`
        <div class="card">
          <div><strong>${f.label}</strong> <span class="ok">OK</span></div>
          <div class="sha-block">${hex}</div>
        </div>
      `);
    }catch(_){
      html.push(`
        <div class="card">
          <div><strong>${f.label}</strong> <span style="background:#773f2e;padding:3px 10px;border-radius:6px;font-size:.85rem;">Missing</span></div>
        </div>
      `);
    }
  }

  // Certificate
  html.push(`
    <div style="margin-top:20px;">
      <a href="integration/certificate.json" download class="pill">Download Audit Certificate (JSON)</a>
    </div>
  `);

  out.innerHTML = html.join("");
};
</script>

</body>
</html>
