<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CFF ‚Äî Constitutional Funding Forensics | A.B.E.</title>
<base href="../">

<style>
:root{
  --bg:#0b0d12;--panel:#141820;--panel2:#0f131a;
  --ink:#e6e6e6;--muted:#9fb3c8;
  --line:rgba(255,255,255,.08);
  --brand:#5ddfff;--accent:#ffa559;
  --ok:#4bd28f;--warn:#ffa559;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
a{color:#80bfff;text-decoration:none}
a:hover{text-decoration:underline}

header{
  padding:24px 20px;
  background:linear-gradient(90deg,#11151c,#0b0d12);
  border-bottom:1px solid var(--line)
}
header h1{margin:0;font-size:1.55rem;font-weight:700}
header .sub{color:var(--muted);margin-top:4px;font-size:.9rem}

.wrap{max-width:780px;margin:0 auto;padding:24px}

.card{
  background:var(--panel);border:1px solid var(--line);
  border-radius:12px;padding:24px;margin-bottom:28px;
  box-shadow:0 0 28px rgba(93,223,255,.05)
}

h2{margin:0 0 12px;color:var(--brand);font-size:1.3rem}
p{margin:.35rem 0 .85rem}

.drop-zone{
  margin-top:12px;
  border:2px dashed var(--brand);
  border-radius:10px;padding:22px;
  text-align:center;font-size:.9rem;color:var(--muted);
}
.drop-zone.dragover{
  border-color:var(--accent);
  background:rgba(255,165,89,.08)
}

button{
  background:var(--brand);color:#0b0d12;
  padding:.6rem 1.2rem;border-radius:6px;
  border:1px solid transparent;
  font-size:.95rem;font-weight:600;
  cursor:pointer;transition:.15s ease-in-out
}
button:hover{
  background:#82eaff;
  transform:translateY(-2px);
  box-shadow:0 4px 10px rgba(93,223,255,.25)
}
.btn-ghost{
  background:#0d0f12;color:var(--accent);
  border:1px solid var(--accent);
}
.btn-ghost:hover{
  background:rgba(255,165,89,.07);
  border-color:var(--accent);
  transform:translateY(-2px)
}

table{width:100%;border-collapse:collapse;margin-top:16px;font-size:.85rem}
th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
th{background:var(--panel2);color:var(--muted)}
tr:hover td{background:rgba(93,223,255,.04)}

.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:18px 0}
.kpi{
  background:var(--panel2);
  border:1px solid var(--line);
  border-radius:10px;padding:14px;
}
.kpi .lbl{font-size:.75rem;color:var(--muted)}
.kpi .val{font-size:1.2rem;font-weight:700}

.banner{
  border-radius:10px;padding:14px;margin-top:18px;
  font-size:.9rem;
  border:1px solid var(--accent);
  background:rgba(255,165,89,.07);
  color:var(--accent)
}

footer{margin:40px 0;text-align:center;font-size:.8rem;color:var(--muted)}
</style>
</head>

<body>
<header>
  <h1>‚öñÔ∏è CFF ‚Äî Constitutional Funding Forensics</h1>
  <div class="sub">Follow the money. Restore the law.</div>
</header>

<div class="wrap">

  <!-- Upload -->
  <div class="card">
    <h2>üì§ Upload Your Funding CSV</h2>
    <p>This runs 100% locally in your browser. No uploads. No tracking. No storage.</p>

    <input type="file" id="fileInput" accept=".csv" style="margin-top:8px">

    <div class="drop-zone" id="dropZone">
      Drag & drop CSV here<br>(must match the CFF template)
    </div>
  </div>

  <!-- Results -->
  <div id="results" style="display:none">

    <div class="card">
      <h2>üìä Forensic Funding Summary</h2>

      <div class="kpis">
        <div class="kpi"><div class="lbl">ON_MISSION</div><div class="val" id="kpiOn">$0</div></div>
        <div class="kpi"><div class="lbl">OFF_MISSION</div><div class="val" id="kpiOff">$0</div></div>
        <div class="kpi"><div class="lbl">UNCLEAR</div><div class="val" id="kpiUnclear">$0</div></div>
        <div class="kpi"><div class="lbl">TOTAL</div><div class="val" id="kpiTotal">$0</div></div>
      </div>

      <button id="btnJson">Download Forensic JSON</button>
    </div>

    <!-- Table -->
    <div class="card">
      <h2>üìö Line-Item Breakdown</h2>
      <table id="dataTable">
        <thead>
          <tr>
            <th>Program</th><th>Authority</th><th>Year</th>
            <th>State</th><th>Agency</th><th>Description</th>
            <th>Category</th><th>Amount</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Send to CIRI -->
    <div class="card">
      <h2>üîó Send OFF_MISSION Total to CIRI</h2>
      <p>The OFF_MISSION amount will be stored locally and read by CIRI when you visit that page.</p>

      <button id="btnToCiri" class="btn-ghost">Send to CIRI (local only)</button>

      <div class="banner">
        Nothing leaves your device.  
        Stored as: <code>ABE_CFF_OFF_MISSION_TOTAL</code> and <code>ABE_CFF_CONTEXT</code>.
      </div>
    </div>

  </div>

</div>

<footer>American Butterfly Effect (A.B.E.) ‚Äî Constitutional restoration through transparent math.</footer>

<script>
/* CSV ‚Üí rows */
function csvToRows(text){
  const rows=[];let i=0,field='',row=[],inQ=false;
  while(i<text.length){
    const c=text[i++];
    if(inQ){
      if(c==='"' && text[i]==='"'){ field+='"'; i++; }
      else if(c==='"'){ inQ=false; }
      else field+=c;
    } else {
      if(c==='"'){ inQ=true; }
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n'||c==='\r'){
        if(field!==''||row.length){ row.push(field); rows.push(row); field=''; row=[]; }
      } else field+=c;
    }
  }
  if(field!==''||row.length){ row.push(field); rows.push(row); }
  return rows;
}

/* Handle CSV parsing + render */
function handleCSV(text){
  const rows = csvToRows(text.trim());
  if(rows.length<2){ alert("CSV has no data"); return; }

  const headers = rows[0];
  const data = rows.slice(1);

  let on=0, off=0, unclear=0, total=0;

  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML='';

  data.forEach(r=>{
    const obj = Object.fromEntries(headers.map((h,i)=>[h,r[i]]));
    const amt = Number((obj.amount_usd||'0').replace(/[^0-9.-]/g,''))||0;
    total += amt;
    if(obj.spend_category_code==="ON_MISSION") on+=amt;
    else if(obj.spend_category_code==="OFF_MISSION") off+=amt;
    else if(obj.spend_category_code==="UNCLEAR") unclear+=amt;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${obj.program_name||''}</td>
      <td>${obj.federal_authority_citation||''}</td>
      <td>${obj.fiscal_year||''}</td>
      <td>${obj.state_or_jurisdiction||''}</td>
      <td>${obj.agency||''}</td>
      <td>${obj.line_item_description||''}</td>
      <td>${obj.spend_category_code||''}</td>
      <td>$${amt.toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("kpiOn").textContent="$"+on.toLocaleString();
  document.getElementById("kpiOff").textContent="$"+off.toLocaleString();
  document.getElementById("kpiUnclear").textContent="$"+unclear.toLocaleString();
  document.getElementById("kpiTotal").textContent="$"+total.toLocaleString();

  window.CFF_RESULT = {on,off,unclear,total};

  document.getElementById("results").style.display='block';
}

/* File upload */
document.getElementById("fileInput").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f) return;
  f.text().then(handleCSV);
});

/* Drag+drop */
const drop=document.getElementById("dropZone");
drop.addEventListener("dragover",e=>{
  e.preventDefault(); drop.classList.add("dragover");
});
drop.addEventListener("dragleave",()=>drop.classList.remove("dragover"));
drop.addEventListener("drop",e=>{
  e.preventDefault(); drop.classList.remove("dragover");
  const f=e.dataTransfer.files[0]; if(!f) return;
  f.text().then(handleCSV);
});

/* Download JSON */
document.getElementById("btnJson").addEventListener("click",()=>{
  const blob=new Blob([JSON.stringify(window.CFF_RESULT,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="cff_forensic_result.json"; a.click();
  URL.revokeObjectURL(url);
});

/* Send to CIRI (local only) */
document.getElementById("btnToCiri").addEventListener("click",()=>{
  if(!window.CFF_RESULT){ alert("Upload a CSV first"); return; }

  localStorage.setItem("ABE_CFF_OFF_MISSION_TOTAL", String(window.CFF_RESULT.off));

  localStorage.setItem("ABE_CFF_CONTEXT", JSON.stringify({
    time: new Date().toISOString(),
    source: "CFF",
    note: "OFF_MISSION transfer from CFF to CIRI"
  }));

  alert("OFF_MISSION total stored locally. CIRI will read it when you visit the CIRI page.");
});
</script>

</body>
</html>
