<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A.B.E. System Map ‚Äî Chain of Custody</title>

  <!-- ABE site-patch (absolute paths so it works under /system/) -->
  <link rel="stylesheet" href="/abe---flag/abe-patch/assets/abe-patch.css">

  <style>
    body {
      background-color: #0b0d12;
      color: #e0e0e0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    header {
      background: linear-gradient(90deg, #11151c, #1b1e25);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      padding: 1rem 2rem;
      text-align: center;
    }
    h1 { color: #5ddfff; margin-bottom: 0.5rem; }
    h2 { color: #ffa559; }
    main { max-width: 980px; margin: 2rem auto; padding: 0 1rem 4rem; }
    section {
      margin-top: 2rem;
      padding: 1rem 1.5rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 10px;
    }
    a { color: #80bfff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    code {
      background: rgba(255,255,255,0.07);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      color: #f1fa8c;
      font-size: 0.9rem;
    }
    .flow-box {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 1rem 1.5rem;
      font-size: 0.95rem;
      line-height: 1.5;
      color: #d0d0d0;
    }
    .flow-step { margin-bottom: 1rem; padding-left: 0.5rem; border-left: 3px solid #5ddfff; }
    .flow-step-title { font-weight: 700; color: #5ddfff; margin-bottom: 0.25rem; }

    /* live map viewer */
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0}
    .kpi{background:#16181d;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px}
    .kpi .lbl{color:#9fb0c9;font-size:12px}
    .kpi .val{font:700 20px/1 system-ui;margin-top:4px}
    table.map{width:100%;border-collapse:collapse;margin-top:8px}
    table.map th, table.map td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:left;vertical-align:top}
    .small{font-size:12px;color:#a7b4c8}
    .btn {padding:6px 10px;border:1px solid #2a3344;border-radius:6px;background:#0d0f12;color:#eaeef7;cursor:pointer}
    .btn+ .btn{margin-left:8px}
  </style>
</head>
<body>

<header>
  <h1>üó∫ A.B.E. System Map</h1>
  <p>
    Canonical chain-of-custody for the American Butterfly Effect (A.B.E.): how constitutional harm is
    detected, measured, converted to dollars, and reinvested locally with audit-ready evidence.
  </p>
</header>

<main>

  <section>
    <h2>üìÇ Core Components</h2>
    <p>
      ‚Ä¢ <a href="../ciri/index.html" class="abe-tooltip" title="Constitutional Integrity ROI Engine">‚öô CIRI</a> ‚Äî quantifies prevented harm and restored rights.<br>
      ‚Ä¢ <a href="../cibs/index.html" class="abe-tooltip" title="Civic Investment Budgeting System">üìä CIBS</a> ‚Äî turns recovery into budget lines (housing, youth, defense, etc.).<br>
      ‚Ä¢ <a href="../integration/index.html">üîó Integration Layer</a> ‚Äî detects tampering, diversion, retaliation, or suppression.<br>
      ‚Ä¢ <a href="map.json">üóÑ <code>system/map.json</code></a> ‚Äî machine-readable definition of the entire pipeline with authorship and timestamps.
    </p>
  </section>

  <section>
    <h2>üîÅ Flow of Accountability</h2>
    <div class="flow-box">

      <div class="flow-step">
        <div class="flow-step-title">1) CIRI ‚Äî Constitutional Integrity ROI Engine</div>
        <div>
          Local data enters <code>ciri/inputs.csv</code>. <code>ciri/calculate.py</code> computes
          Direct Case Savings, Detention Savings, Licensing Correction, and Employment Restoration.
          <br><br>
          Output: a <strong>Total Impact</strong> dollar figure the jurisdiction must reconcile.
        </div>
      </div>

      <div class="flow-step">
        <div class="flow-step-title">2) CIBS ‚Äî Civic Investment Budgeting System</div>
        <div>
          CIRI‚Äôs Total Impact becomes the <strong>Recovery Pool</strong>. CIBS allocates that pool to
          community lines and writes <code>cibs/auto_budget.csv</code> with tags, recipients, and timing.
        </div>
      </div>

      <div class="flow-step">
        <div class="flow-step-title">3) System Map (this page)</div>
        <div>
          The expected movement of dollars, attestations, and controls is defined in
          <a href="map.json"><code>system/map.json</code></a>. It‚Äôs public and versioned; anyone can diff it
          against reality. Any mismatch ‚Üí someone‚Äôs <strong>out of bounds</strong>.
        </div>
      </div>

      <div class="flow-step">
        <div class="flow-step-title">4) Integration & Evidence</div>
        <div>
          Programmatic checks verify: (a) funds landed, (b) recipients matched, (c) retaliation/suppression flags are
          zero, (d) audits signed. Violations auto-raise exceptions and notify oversight.
        </div>
      </div>

    </div>
  </section>

  <!-- Live viewer for system/map.json -->
  <section>
    <h2>üß© Live System Map (from <code>system/map.json</code>)</h2>
    <div class="kpis">
      <div class="kpi"><div class="lbl">Map Status</div><div id="map-status" class="val">Checking‚Ä¶</div></div>
      <div class="kpi"><div class="lbl">Flows Defined</div><div id="map-flows" class="val">‚Äî</div></div>
      <div class="kpi"><div class="lbl">Last Updated</div><div id="map-updated" class="val">‚Äî</div></div>
    </div>

    <div class="small">
      This viewer loads <code>system/map.json</code> (or <code>/abe---flag/system/map.json</code> fallback), and renders its
      <em>flows</em> array as a verifiable chain-of-custody: <strong>from ‚Üí to ‚Üí control ‚Üí evidence</strong>.
    </div>

    <table id="map-table" class="map"></table>

    <div style="margin-top:10px">
      <button id="btn-download" class="btn">Download Snapshot (JSON)</button>
      <button id="btn-reload" class="btn">Reload Map</button>
    </div>
  </section>

  <section>
    <h2>üîí Integrity Checklist</h2>
    <ul>
      <li>All map entries include <code>from</code>, <code>to</code>, <code>control</code>, and <code>evidence</code> fields.</li>
      <li>Evidence URLs resolve (HTTP 200) or are embedded hashes/IDs (IPFS, SHA-256, or notarized docs).</li>
      <li>Budget entries in <code>cibs/auto_budget.csv</code> match the <code>to</code> recipients defined in the map.</li>
      <li>Any redaction is additive (never destructive); original records remain addressable.</li>
      <li>Every edit to <code>map.json</code> is attributed in Git history (authorship, time, diff).</li>
    </ul>
    <p class="small">
      Result: a tamper-evident public record of value flow that communities can audit without gatekeepers.
    </p>
  </section>

</main>

<!-- ABE patch scripts -->
<script src="/abe---flag/abe-patch/assets/abe-nav.js"></script>
<script src="/abe---flag/abe-patch/assets/abe-definitions.js"></script>

<!-- Live map viewer script -->
<script>
(async function(){
  const status = document.getElementById('map-status');
  const flowsEl = document.getElementById('map-flows');
  const updatedEl = document.getElementById('map-updated');
  const table = document.getElementById('map-table');

  async function loadMap(){
    const urls = ['map.json','/abe---flag/system/map.json'];
    for (const u of urls){
      try {
        const r = await fetch(u, {cache:'no-store'});
        if (r.ok) { const j = await r.json(); j.__src = u; return j; }
      } catch(_) {}
    }
    return null;
  }

  function renderEmpty(){
    status.textContent = 'Not found';
    flowsEl.textContent = '0';
    updatedEl.textContent = '‚Äî';
    table.innerHTML =
      '<thead><tr><th>From</th><th>To</th><th>Control</th><th>Evidence</th></tr></thead>' +
      '<tbody><tr><td colspan="4" class="small">No <code>system/map.json</code> present yet. ' +
      'Create one to define expected flows.</td></tr></tbody>';
  }

  function render(map){
    status.textContent = 'Loaded';
    const flows = Array.isArray(map.flows) ? map.flows : [];
    flowsEl.textContent = String(flows.length);
    const when = map.updated || map.last_updated || map.timestamp || '';
    updatedEl.textContent = when || 'unspecified';

    // Table
    const head = '<thead><tr><th>From</th><th>To</th><th>Control</th><th>Evidence</th></tr></thead>';
    const rows = flows.map(f => {
      const ev = Array.isArray(f.evidence) ? f.evidence : (f.evidence ? [f.evidence] : []);
      const evHtml = ev.length
        ? ev.map(e => {
            if (typeof e === 'string' && /^https?:\/\//.test(e)) {
              return `<a href="${e}" target="_blank" rel="noopener">${e}</a>`;
            } else if (typeof e === 'string') {
              return `<code>${e}</code>`;
            } else {
              return `<code>${JSON.stringify(e)}</code>`;
            }
          }).join('<br>')
        : '<span class="small">‚Äî</span>';
      return `<tr>
        <td>${f.from ? String(f.from) : '<span class="small">‚Äî</span>'}</td>
        <td>${f.to ? String(f.to) : '<span class="small">‚Äî</span>'}</td>
        <td>${f.control ? String(f.control) : '<span class="small">‚Äî</span>'}</td>
        <td>${evHtml}</td>
      </tr>`;
    }).join('');

    table.innerHTML = head + '<tbody>' + (rows || '<tr><td colspan="4" class="small">No flows yet.</td></tr>') + '</tbody>';

    // Wire buttons
    const btnDl = document.getElementById('btn-download');
    btnDl.onclick = () => {
      const snapshot = {
        generated: new Date().toISOString(),
        source: map.__src || 'map.json',
        flows: map.flows || [],
        meta: { updated: when || null }
      };
      const blob = new Blob([JSON.stringify(snapshot, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'system_map_snapshot.json'; a.click();
      URL.revokeObjectURL(url);
    };

    const btnReload = document.getElementById('btn-reload');
    btnReload.onclick = () => { init(); };
  }

  async function init(){
    status.textContent = 'Checking‚Ä¶';
    flowsEl.textContent = '‚Äî';
    updatedEl.textContent = '‚Äî';
    table.innerHTML = '';

    const map = await loadMap();
    if (!map) renderEmpty(); else render(map);
  }

  await init();
})();
</script>

</body>
</html>
