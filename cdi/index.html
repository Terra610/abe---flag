<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CDI ‚Äî Constitutional Divergence Index</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#141820; --panel2:#0f131a;
      --ink:#e6e6e6; --muted:#9fb3c8; --line:rgba(255,255,255,.08);
      --brand:#5ddfff; --accent:#ffa559;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;line-height:1.6}
    header{background:linear-gradient(90deg,#11151c,#1b1e25);text-align:center;padding:1.2rem;border-bottom:1px solid var(--line)}
    h1{color:var(--brand);margin:.1rem 0 .3rem}
    p.lead{color:#c8d2df;margin:.2rem 0 0}
    nav a{color:#80bfff;text-decoration:none}
    nav a:hover{text-decoration:underline}
    main{max-width:1000px;margin:1.5rem auto 3rem;padding:0 1rem}
    section{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:1rem 1.25rem;margin-bottom:1rem}
    code{background:rgba(255,255,255,.08);padding:.1rem .3rem;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:.6rem}
    th,td{border:1px solid var(--line);padding:.55rem;text-align:left}
    th{background:#1b1f26;color:#cfe6ff}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    footer{text-align:center;font-size:.85rem;color:#9fb3c8;padding:1rem;margin-top:2rem;border-top:1px solid var(--line)}
    a{color:#5ddfff;text-decoration:none} a:hover{text-decoration:underline}

    /* Health banner used by validate_cdi.js */
    #cdi-health{border:1px solid #2a3344;border-radius:10px;padding:10px;background:#0e1218;margin:-.25rem 0 .9rem}
    #cdi-health.ok{border-color:#245b3c;background:#0f1713}
    #cdi-health.warn{border-color:#66501f;background:#17140b}
    #cdi-health.err{border-color:#6b2a2a;background:#170f10}

    /* Nav Dock tiles */
    .dock-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .dock-tile{background:var(--panel2);border:1px solid var(--line);border-radius:10px;padding:14px}
    .dock-tile h3{margin:.1rem 0 .4rem;font-size:1rem;color:#eaeef7}
    .muted{color:#9fb3c8}
  </style>
</head>
<body>
<header>
  <h1>CDI ‚Äî Constitutional Divergence Index</h1>
  <p class="lead">Quantifies deviation from constitutional fidelity across domains to drive lawful realignment.</p>
  <nav style="margin-top:.4rem">
    <a href="../index.html">üè† Home</a> ¬∑
    <a href="../ciri/index.html">CIRI</a> ¬∑
    <a href="../cibs/index.html">CIBS</a> ¬∑
    <a href="../cii/index.html">CII</a> ¬∑
    <a href="../macro/index.html">Macro</a>
  </nav>
</header>

<main>
  <!-- Live health banner (validator will set status) -->
  <section id="cdi-health" aria-live="polite">Checking divergence.csv and model.json‚Ä¶</section>

  <section>
    <h2>üìä What is CDI?</h2>
    <p>
      The <strong>Constitutional Divergence Index</strong> measures the extent to which laws, budgets, or policies diverge
      from constitutional limits and obligations. Scores range from <strong>0.00 (fully faithful)</strong> to
      <strong>1.00 (fully divergent)</strong>. CDI signals flow into
      <a href="../ciri/index.html">CIRI</a> to convert divergence into measurable recovery value.
    </p>
    <p class="muted">Source files: <code>./model.json</code> (scoring model) ¬∑ <code>./divergence.csv</code> (observations)</p>
  </section>

  <section>
    <h2>üìà Divergence by Category</h2>
    <p class="muted">These values can be refined per jurisdiction. Update <code>divergence.csv</code> to modify the table.</p>
    <table aria-label="CDI divergence table">
      <thead>
        <tr><th>Category</th><th>Divergence (0‚Äì1.0)</th><th>Confidence</th></tr>
      </thead>
      <tbody id="divTableBody"></tbody>
      <tfoot>
        <tr><th>Total Categories</th><th id="catCount" class="num">‚Äî</th><th></th></tr>
      </tfoot>
    </table>
  </section>

  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ A.B.E. Navigator ¬∑ Live KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section>
    <h2>üß≠ A.B.E. Navigator ¬∑ Live Links</h2>
    <div class="dock-grid">
      <div class="dock-tile">
        <h3>Doctrines</h3>
        <ul style="list-style:none;padding:0;margin:0;line-height:1.8">
          <li><a href="/abe---flag/doctrine/ABE_CRRA_Rebuild.pdf">ABE + CRRA + Rebuild (33-page)</a></li>
          <li><a href="/abe---flag/doctrine/constitutional-fidelity.html">Constitutional Fidelity (full text)</a></li>
          <li><a href="/abe---flag/doctrine/void-ab-initio.html">Void ab Initio (full text)</a></li>
        </ul>
      </div>
      <div class="dock-tile">
        <h3>Calculators & KPIs</h3>
        <ul style="list-style:none;padding:0;margin:0;line-height:1.9">
          <li><a href="/abe---flag/ciri/">CIRI Calculator</a> ‚Äî <span id="dock-ciri-total" class="muted">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/cibs/">CIBS Budget</a> ‚Äî <span id="dock-cibs-total" class="muted">loading‚Ä¶</span></li>
          <li><a href="/abe---flag/integration/">Integration KPIs</a></li>
        </ul>
      </div>
      <div class="dock-tile">
        <h3>Archive & License</h3>
        <div class="muted" style="line-height:1.7">
          DOI: <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a><br/>
          License: <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a><br/>
          Project: <a href="/abe---flag/">terra610.github.io/abe---flag</a>
        </div>
      </div>
    </div>
  </section>
  <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ /Navigator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
</main>

<footer>
  ¬© 2025 Terra Dawn Shouse ¬∑
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    CC BY-NC 4.0 International License
  </a>
</footer>

<script>
  // Robust CSV parser (handles quotes)
  function parseCSV(text){
    const rows=[]; let i=0, f='', r=[], q=false;
    const s=text.trim();
    while(i<s.length){
      const c=s[i++];
      if(q){
        if(c=='"' && s[i]=='"'){ f+='"'; i++; }
        else if(c=='"'){ q=false; }
        else { f+=c; }
      }else{
        if(c=='"'){ q=true; }
        else if(c==','){ r.push(f); f=''; }
        else if(c=='\n'||c=='\r'){ if(f!==''||r.length){ r.push(f); rows.push(r); f=''; r=[]; } }
        else { f+=c; }
      }
    }
    if(f!==''||r.length){ r.push(f); rows.push(r); }
    return rows;
  }

  (async()=>{
    try{
      const res = await fetch('./divergence.csv',{cache:'no-store'});
      if(!res.ok) throw new Error('CSV not found');
      const text = await res.text();
      const rows = parseCSV(text);
      if(!rows.length) throw new Error('CSV empty');

      const head = rows.shift().map(h=>h.trim().toLowerCase());
      const idx = Object.fromEntries(head.map((h,i)=>[h,i]));
      const tb = document.getElementById('divTableBody');
      tb.innerHTML='';

      let count=0;
      rows.forEach(r=>{
        if(!r.length) return;
        const tr=document.createElement('tr');

        const td1=document.createElement('td'); td1.textContent = r[idx.category ?? 0] ?? '';
        const td2=document.createElement('td'); td2.textContent = r[idx.divergence ?? 1] ?? '';
        const td3=document.createElement('td'); td3.textContent = r[idx.confidence ?? 2] ?? '';

        tr.append(td1,td2,td3);
        tb.appendChild(tr);
        count++;
      });
      document.getElementById('catCount').textContent = count;
    }catch(e){
      const tb = document.getElementById('divTableBody');
      const tr=document.createElement('tr'); const td=document.createElement('td');
      td.colSpan=3; td.textContent='Could not load divergence.csv';
      tr.appendChild(td); tb.appendChild(tr);
    }
  })();

  // Nav Dock KPIs (same logic used on CII)
  (async function(){
    // CIBS total
    try{
      const r = await fetch('/abe---flag/cibs/auto_budget.csv',{cache:'no-store'});
      const t = await r.text();
      const lines = t.trim().split(/\r?\n/);
      const total = lines.slice(1).reduce((s,line)=>{
        const v = Number(line.split(',')[1]?.replace(/[^0-9.\-]/g,''));
        return s + (isFinite(v)?v:0);
      },0);
      document.getElementById('dock-cibs-total').textContent = '$' + Math.round(total).toLocaleString();
    }catch{ const el=document.getElementById('dock-cibs-total'); if(el) el.textContent='‚Äî'; }

    // CIRI total (demo math)
    try{
      const r = await fetch('/abe---flag/ciri/inputs.csv',{cache:'no-store'});
      const t = await r.text();
      const [h,d] = t.trim().split(/\r?\n/);
      const keys = h.split(','); const vals = d.split(',').map(x=>Number(String(x).replace(/[^0-9.\-]/g,'')));
      const o = Object.fromEntries(keys.map((k,i)=>[k.trim(), vals[i]]));

      const totalRecovery = (o.cases_avoided*o.avg_cost_per_case + o.fees_canceled_total)
                          + (o.jail_days_avoided*o.cost_per_jail_day)
                          + (o.households_restored*o.avg_monthly_market_spend*o.months_effective || 0)
                          + ((o.cases_avoided*o.employment_probability)*o.avg_monthly_wage*(o.months_effective/12))
                          + (o.expected_lawsuits*o.avg_payout*(o.litigation_multiplier||1))
                          - (o.transition_costs_one_time||0);

      document.getElementById('dock-ciri-total').textContent = '$' + Math.round(totalRecovery).toLocaleString();
    }catch{ const el=document.getElementById('dock-ciri-total'); if(el) el.textContent='‚Äî'; }
  })();
</script>

<!-- Live validator -->
<script src="./validate_cdi.js"></script>
</body>
</html></header>

<main>
  <section>
    <h2>üìä What is CDI?</h2>
    <p>
      The <strong>Constitutional Divergence Index</strong> measures the extent to which laws, budgets, or policies diverge from constitutional limits and obligations.
      Scores range from <strong>0.00 (fully faithful)</strong> to <strong>1.00 (fully divergent)</strong>.
    </p>
    <p>
      CDI data feeds directly into <a href="../ciri/index.html">CIRI</a>, which translates these deviations into measurable economic recovery values.
    </p>
  </section>

  <section>
    <h2>üìà Divergence by Category</h2>
    <p>Below is a sample of calculated divergence scores. These values can be refined by jurisdiction or sector.</p>
    <table id="divTable" aria-describedby="divTableNote">
      <thead>
        <tr><th>Category</th><th>Divergence (0‚Äì1.0)</th><th>Confidence</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="divTableNote" style="color:#9fb3c8;font-size:.9rem;margin:.5rem 0 0;">
      Source file: <code>/cdi/divergence.csv</code>
    </p>
  </section>

  <!-- Validator block -->
  <section aria-live="polite">
    <h2>‚úÖ CDI Model Validation</h2>
    <div id="cdi-validate" class="badge warn">Loading validator‚Ä¶</div>
    <p style="color:#9fb3c8;font-size:.9rem;margin-top:.6rem">
      Validates <code>/cdi/model.json</code> against <code>/cdi/schema.json</code> (structure, types, ranges).
    </p>
  </section>

  <section>
    <h2>üìÅ Source Data</h2>
    <p>Model file: <code>model.json</code> ¬∑ Live data: <code>divergence.csv</code></p>
    <p><a href="./model.json" download>Download model.json</a> ¬∑ <a href="./divergence.csv" download>Download divergence.csv</a></p>
  </section>
</main>

<footer>
  ¬© 2025 Terra Dawn Shouse ¬∑
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    CC BY-NC 4.0 International License
  </a>
</footer>

<script>
(async()=>{
  // Load and render divergence.csv safely
  try{
    const res = await fetch('./divergence.csv',{cache:'no-store'});
    if(!res.ok) throw new Error('divergence.csv not found');
    const text = await res.text();
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
    const tbody = document.querySelector('#divTable tbody');
    rows.slice(1).forEach(r=>{
      const tr=document.createElement('tr');
      const [cat,div,conf]=r;
      const td1=document.createElement('td'); td1.textContent=cat||'';
      const td2=document.createElement('td'); td2.textContent=div||'';
      const td3=document.createElement('td'); td3.textContent=conf||'';
      tr.append(td1,td2,td3);
      tbody.appendChild(tr);
    });
  }catch(e){
    const tbody = document.querySelector('#divTable tbody');
    const tr=document.createElement('tr');
    const td=document.createElement('td');
    td.colSpan=3; td.textContent='Could not load divergence.csv';
    tr.appendChild(td); tbody.appendChild(tr);
  }
})();
</script>

<!-- Hook in live validator -->
<script src="./validate_cdi.js"></script>
</body>
</html>
```Ó®Å0Ó®Ç    <div class="sub">Auto-computed from CAE. Higher alignment ‚Üí lower divergence. Self-correcting by design.</div>
  </div>
</header>

<main class="wrap">

  <!-- KPIs -->
  <div class="grid">
    <div class="tile">
      <div>Average Alignment (CAE)</div>
      <div id="k-align" class="num">‚Äî</div>
      <small>Mean of <code>clauses[*].alignment_score</code></small>
    </div>
    <div class="tile">
      <div>CDI (Divergence)</div>
      <div id="k-div" class="num">‚Äî</div>
      <small>CDI = 1 ‚àí alignment</small>
    </div>
    <div class="tile">
      <div>Realignment Œî (vs. last view)</div>
      <div id="k-delta" class="num">‚Äî</div>
      <small>Positive = healing; negative = drift</small>
    </div>
  </div>

  <!-- Sources panel -->
  <div class="card" id="sourcePanel">
    <h3 style="margin-top:0">Source</h3>
    <div id="srcMsg"><code>/cae/model.json</code> loaded.</div>
    <small>Fallback: <code>/cdi/divergence.csv</code> (if CAE model is missing)</small>
  </div>

  <!-- Breakdown table -->
  <div class="card">
    <h3 style="margin-top:0">Clause Breakdown</h3>
    <table aria-label="Clause breakdown">
      <thead>
        <tr>
          <th>Clause</th>
          <th>Title</th>
          <th>Alignment</th>
          <th>Divergence</th>
          <th>Confidence</th>
          <th>Tags</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <th colspan="2">Average</th>
          <th id="t-align">‚Äî</th>
          <th id="t-div">‚Äî</th>
          <th colspan="2"></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Export -->
  <div class="card">
    <h3 style="margin-top:0">Export</h3>
    <button id="btnCsv">Download Divergence CSV</button>
    <small id="stamp" style="margin-left:10px"></small>
  </div>

</main>

<footer>
  CC BY-NC 4.0 ¬∑ DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> ¬∑ Integrity only ‚Äî never for sale.
</footer>

<script>
(async function(){
  const fmt = n => (isFinite(n) ? n.toFixed(2) : "‚Äî");
  const now = () => new Date().toLocaleString();
  const tbody = document.getElementById('tbody');

  async function loadCAE(){
    try{
      // Try absolute then relative (works on Pages & local)
      const urls = ["/abe---flag/cae/model.json","./model.json","/cae/model.json"];
      for(const u of urls){
        const r = await fetch(u, {cache:"no-store"});
        if(r.ok){
          const j = await r.json();
          return {json:j, url:u};
        }
      }
    }catch(_){}
    return null;
  }

  function renderFromCAE(cae, url){
    const clauses = Array.isArray(cae.clauses) ? cae.clauses : [];
    if(!clauses.length) throw new Error("CAE model has no clauses array.");

    // alignment = mean of alignment_score
    const alignVals = clauses.map(c => Number(c.alignment_score)).filter(v => isFinite(v));
    const avgAlign = alignVals.reduce((a,b)=>a+b,0) / Math.max(alignVals.length,1);
    const div = Math.max(0, 1 - avgAlign);

    // Realignment delta (vs last view, localStorage only)
    const key = "cdi_prev_avg_align";
    const prev = Number(localStorage.getItem(key));
    localStorage.setItem(key, String(avgAlign));
    const delta = isFinite(prev) ? (avgAlign - prev) : 0;

    // KPIs
    document.getElementById('k-align').textContent = fmt(avgAlign);
    document.getElementById('k-div').textContent   = fmt(div);
    const dEl = document.getElementById('k-delta');
    dEl.textContent = (delta>=0? "+" : "") + fmt(delta);
    dEl.classList.add(delta>=0 ? "good" : "bad");

    // Table
    tbody.innerHTML = "";
    for(const c of clauses){
      const a = Number(c.alignment_score);
      const d = Math.max(0, 1 - a);
      const tr = document.createElement('tr');

      const td1 = document.createElement('td'); td1.textContent = c.clause_id || "";
      const td2 = document.createElement('td'); td2.textContent = c.title || "";
      const td3 = document.createElement('td'); td3.textContent = fmt(a);
      const td4 = document.createElement('td'); td4.textContent = fmt(d);
      const td5 = document.createElement('td'); td5.textContent = c.confidence!=null ? fmt(Number(c.confidence)) : "‚Äî";
      const td6 = document.createElement('td'); td6.textContent = Array.isArray(c.tags)? c.tags.join(", ") : "";

      tr.append(td1,td2,td3,td4,td5,td6);
      tbody.appendChild(tr);
    }

    // Footer avgs
    document.getElementById('t-align').textContent = fmt(avgAlign);
    document.getElementById('t-div').textContent   = fmt(div);

    // Source message
    document.getElementById('srcMsg').innerHTML = `Loaded <code>${url}</code> (${clauses.length} clauses)`;
    document.getElementById('stamp').textContent = "Generated: " + now();

    // CSV export
    document.getElementById('btnCsv').onclick = () => {
      const lines = [
        ["Generated", now()],
        ["Source", url],
        [],
        ["clause_id","title","alignment","divergence","confidence","tags"]
      ];
      for(const c of clauses){
        const a = Number(c.alignment_score);
        const d = Math.max(0, 1 - a);
        const row = [
          c.clause_id||"",
          c.title||"",
          isFinite(a)? a.toFixed(4) : "",
          isFinite(d)? d.toFixed(4) : "",
          c.confidence!=null? Number(c.confidence).toFixed(4) : "",
          Array.isArray(c.tags)? c.tags.join("|") : ""
        ];
        // escape for CSV (Excel formula injection guard)
        const safe = row.map(cell=>{
          const s = String(cell);
          return /^[=+\-@]/.test(s) ? "'"+s : s;
        });
        lines.push(safe);
      }
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const urlBlob = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = urlBlob; a.download = "cdi_divergence.csv"; a.click();
      URL.revokeObjectURL(urlBlob);
    };
  }

  async function render(){
    const cae = await loadCAE();
    if(cae){
      try{ renderFromCAE(cae.json, cae.url); return; }
      catch(e){ console.error(e); }
    }
    // Fallback to static CSV if CAE not available
    document.getElementById('srcMsg').innerHTML = `Falling back to <code>/cdi/divergence.csv</code>`;
    try{
      const r = await fetch('./divergence.csv',{cache:'no-store'});
      const t = await r.text();
      const rows = t.trim().split(/\r?\n/).map(r=>r.split(','));
      const head = rows[0]; const body = rows.slice(1);
      let aSum=0, n=0;
      tbody.innerHTML = "";
      for(const r of body){
        const a = Number(r[1]); const d = Number(r[2]);
        if(isFinite(a)){ aSum+=a; n++; }
        const tr = document.createElement('tr');
        ["0","3","1","2","4","5"].forEach(idx=>{
          const td = document.createElement('td');
          td.textContent = r[Number(idx)]||"";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      const avg = aSum/Math.max(1,n);
      document.getElementById('k-align').textContent = fmt(avg);
      document.getElementById('k-div').textContent   = fmt(Math.max(0,1-avg));
      document.getElementById('t-align').textContent = fmt(avg);
      document.getElementById('t-div').textContent   = fmt(Math.max(0,1-avg));
      document.getElementById('stamp').textContent = "Generated: " + now();
    }catch(_){
      document.getElementById('srcMsg').innerHTML = "No CAE model and no divergence.csv found.";
    }
  }

  render();
})();
</script>
</body>
</html>
