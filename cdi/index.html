<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CDI ‚Äî Constitutional Divergence Index</title>
  <style>
    body{background:#0b0d12;color:#e6e6e6;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;line-height:1.6}
    header{background:#12161f;text-align:center;padding:1rem;border-bottom:1px solid rgba(255,255,255,.08)}
    h1{color:#5ddfff;margin-bottom:.25rem}
    p.lead{color:#c8d2df;margin-top:0}
    main{max-width:900px;margin:1.5rem auto;padding:0 1rem}
    section{background:#141820;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:1rem 1.25rem;margin-bottom:1rem}
    code{background:rgba(255,255,255,.08);padding:.1rem .3rem;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{border:1px solid rgba(255,255,255,.08);padding:.5rem;text-align:left}
    th{background:#1b1f26;color:#5ddfff}
    footer{text-align:center;font-size:.85rem;color:#9fb3c8;padding:1rem;margin-top:2rem;border-top:1px solid rgba(255,255,255,.08)}
    a{color:#5ddfff;text-decoration:none} a:hover{text-decoration:underline}
    .badge{display:inline-block;padding:.25rem .5rem;border-radius:6px;font-weight:700}
    .ok{background:#0f2b1e;color:#4bd28f;border:1px solid #265c42}
    .warn{background:#2b2610;color:#ffa559;border:1px solid #5c4b26}
    .err{background:#2b1010;color:#ff6b6b;border:1px solid #5c2626}
  </style>
</head>
<body>
<header>
  <h1>CDI ‚Äî Constitutional Divergence Index</h1>
  <p class="lead">Quantifies deviation from constitutional fidelity across domains.</p>
  <nav aria-label="Site">
    <a href="../index.html">üè† Home</a> ¬∑
    <a href="../ciri/index.html">CIRI</a> ¬∑
    <a href="../cibs/index.html">CIBS</a> ¬∑
    <a href="../cii/index.html">CII</a> ¬∑
    <a href="../macro/index.html">Macro</a>
  </nav>
</header>

<main>
  <section>
    <h2>üìä What is CDI?</h2>
    <p>
      The <strong>Constitutional Divergence Index</strong> measures the extent to which laws, budgets, or policies diverge from constitutional limits and obligations.
      Scores range from <strong>0.00 (fully faithful)</strong> to <strong>1.00 (fully divergent)</strong>.
    </p>
    <p>
      CDI data feeds directly into <a href="../ciri/index.html">CIRI</a>, which translates these deviations into measurable economic recovery values.
    </p>
  </section>

  <section>
    <h2>üìà Divergence by Category</h2>
    <p>Below is a sample of calculated divergence scores. These values can be refined by jurisdiction or sector.</p>
    <table id="divTable" aria-describedby="divTableNote">
      <thead>
        <tr><th>Category</th><th>Divergence (0‚Äì1.0)</th><th>Confidence</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="divTableNote" style="color:#9fb3c8;font-size:.9rem;margin:.5rem 0 0;">
      Source file: <code>/cdi/divergence.csv</code>
    </p>
  </section>

  <!-- Validator block -->
  <section aria-live="polite">
    <h2>‚úÖ CDI Model Validation</h2>
    <div id="cdi-validate" class="badge warn">Loading validator‚Ä¶</div>
    <p style="color:#9fb3c8;font-size:.9rem;margin-top:.6rem">
      Validates <code>/cdi/model.json</code> against <code>/cdi/schema.json</code> (structure, types, ranges).
    </p>
  </section>

  <section>
    <h2>üìÅ Source Data</h2>
    <p>Model file: <code>model.json</code> ¬∑ Live data: <code>divergence.csv</code></p>
    <p><a href="./model.json" download>Download model.json</a> ¬∑ <a href="./divergence.csv" download>Download divergence.csv</a></p>
  </section>
</main>

<footer>
  ¬© 2025 Terra Dawn Shouse ¬∑
  <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener" style="color:#5ddfff">
    CC BY-NC 4.0 International License
  </a>
</footer>

<script>
(async()=>{
  // Load and render divergence.csv safely
  try{
    const res = await fetch('./divergence.csv',{cache:'no-store'});
    if(!res.ok) throw new Error('divergence.csv not found');
    const text = await res.text();
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
    const tbody = document.querySelector('#divTable tbody');
    rows.slice(1).forEach(r=>{
      const tr=document.createElement('tr');
      const [cat,div,conf]=r;
      const td1=document.createElement('td'); td1.textContent=cat||'';
      const td2=document.createElement('td'); td2.textContent=div||'';
      const td3=document.createElement('td'); td3.textContent=conf||'';
      tr.append(td1,td2,td3);
      tbody.appendChild(tr);
    });
  }catch(e){
    const tbody = document.querySelector('#divTable tbody');
    const tr=document.createElement('tr');
    const td=document.createElement('td');
    td.colSpan=3; td.textContent='Could not load divergence.csv';
    tr.appendChild(td); tbody.appendChild(tr);
  }
})();
</script>

<!-- Hook in live validator -->
<script src="./validate_cdi.js"></script>
</body>
</html>
```Ó®Å0Ó®Ç    <div class="sub">Auto-computed from CAE. Higher alignment ‚Üí lower divergence. Self-correcting by design.</div>
  </div>
</header>

<main class="wrap">

  <!-- KPIs -->
  <div class="grid">
    <div class="tile">
      <div>Average Alignment (CAE)</div>
      <div id="k-align" class="num">‚Äî</div>
      <small>Mean of <code>clauses[*].alignment_score</code></small>
    </div>
    <div class="tile">
      <div>CDI (Divergence)</div>
      <div id="k-div" class="num">‚Äî</div>
      <small>CDI = 1 ‚àí alignment</small>
    </div>
    <div class="tile">
      <div>Realignment Œî (vs. last view)</div>
      <div id="k-delta" class="num">‚Äî</div>
      <small>Positive = healing; negative = drift</small>
    </div>
  </div>

  <!-- Sources panel -->
  <div class="card" id="sourcePanel">
    <h3 style="margin-top:0">Source</h3>
    <div id="srcMsg"><code>/cae/model.json</code> loaded.</div>
    <small>Fallback: <code>/cdi/divergence.csv</code> (if CAE model is missing)</small>
  </div>

  <!-- Breakdown table -->
  <div class="card">
    <h3 style="margin-top:0">Clause Breakdown</h3>
    <table aria-label="Clause breakdown">
      <thead>
        <tr>
          <th>Clause</th>
          <th>Title</th>
          <th>Alignment</th>
          <th>Divergence</th>
          <th>Confidence</th>
          <th>Tags</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <th colspan="2">Average</th>
          <th id="t-align">‚Äî</th>
          <th id="t-div">‚Äî</th>
          <th colspan="2"></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Export -->
  <div class="card">
    <h3 style="margin-top:0">Export</h3>
    <button id="btnCsv">Download Divergence CSV</button>
    <small id="stamp" style="margin-left:10px"></small>
  </div>

</main>

<footer>
  CC BY-NC 4.0 ¬∑ DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> ¬∑ Integrity only ‚Äî never for sale.
</footer>

<script>
(async function(){
  const fmt = n => (isFinite(n) ? n.toFixed(2) : "‚Äî");
  const now = () => new Date().toLocaleString();
  const tbody = document.getElementById('tbody');

  async function loadCAE(){
    try{
      // Try absolute then relative (works on Pages & local)
      const urls = ["/abe---flag/cae/model.json","./model.json","/cae/model.json"];
      for(const u of urls){
        const r = await fetch(u, {cache:"no-store"});
        if(r.ok){
          const j = await r.json();
          return {json:j, url:u};
        }
      }
    }catch(_){}
    return null;
  }

  function renderFromCAE(cae, url){
    const clauses = Array.isArray(cae.clauses) ? cae.clauses : [];
    if(!clauses.length) throw new Error("CAE model has no clauses array.");

    // alignment = mean of alignment_score
    const alignVals = clauses.map(c => Number(c.alignment_score)).filter(v => isFinite(v));
    const avgAlign = alignVals.reduce((a,b)=>a+b,0) / Math.max(alignVals.length,1);
    const div = Math.max(0, 1 - avgAlign);

    // Realignment delta (vs last view, localStorage only)
    const key = "cdi_prev_avg_align";
    const prev = Number(localStorage.getItem(key));
    localStorage.setItem(key, String(avgAlign));
    const delta = isFinite(prev) ? (avgAlign - prev) : 0;

    // KPIs
    document.getElementById('k-align').textContent = fmt(avgAlign);
    document.getElementById('k-div').textContent   = fmt(div);
    const dEl = document.getElementById('k-delta');
    dEl.textContent = (delta>=0? "+" : "") + fmt(delta);
    dEl.classList.add(delta>=0 ? "good" : "bad");

    // Table
    tbody.innerHTML = "";
    for(const c of clauses){
      const a = Number(c.alignment_score);
      const d = Math.max(0, 1 - a);
      const tr = document.createElement('tr');

      const td1 = document.createElement('td'); td1.textContent = c.clause_id || "";
      const td2 = document.createElement('td'); td2.textContent = c.title || "";
      const td3 = document.createElement('td'); td3.textContent = fmt(a);
      const td4 = document.createElement('td'); td4.textContent = fmt(d);
      const td5 = document.createElement('td'); td5.textContent = c.confidence!=null ? fmt(Number(c.confidence)) : "‚Äî";
      const td6 = document.createElement('td'); td6.textContent = Array.isArray(c.tags)? c.tags.join(", ") : "";

      tr.append(td1,td2,td3,td4,td5,td6);
      tbody.appendChild(tr);
    }

    // Footer avgs
    document.getElementById('t-align').textContent = fmt(avgAlign);
    document.getElementById('t-div').textContent   = fmt(div);

    // Source message
    document.getElementById('srcMsg').innerHTML = `Loaded <code>${url}</code> (${clauses.length} clauses)`;
    document.getElementById('stamp').textContent = "Generated: " + now();

    // CSV export
    document.getElementById('btnCsv').onclick = () => {
      const lines = [
        ["Generated", now()],
        ["Source", url],
        [],
        ["clause_id","title","alignment","divergence","confidence","tags"]
      ];
      for(const c of clauses){
        const a = Number(c.alignment_score);
        const d = Math.max(0, 1 - a);
        const row = [
          c.clause_id||"",
          c.title||"",
          isFinite(a)? a.toFixed(4) : "",
          isFinite(d)? d.toFixed(4) : "",
          c.confidence!=null? Number(c.confidence).toFixed(4) : "",
          Array.isArray(c.tags)? c.tags.join("|") : ""
        ];
        // escape for CSV (Excel formula injection guard)
        const safe = row.map(cell=>{
          const s = String(cell);
          return /^[=+\-@]/.test(s) ? "'"+s : s;
        });
        lines.push(safe);
      }
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const urlBlob = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = urlBlob; a.download = "cdi_divergence.csv"; a.click();
      URL.revokeObjectURL(urlBlob);
    };
  }

  async function render(){
    const cae = await loadCAE();
    if(cae){
      try{ renderFromCAE(cae.json, cae.url); return; }
      catch(e){ console.error(e); }
    }
    // Fallback to static CSV if CAE not available
    document.getElementById('srcMsg').innerHTML = `Falling back to <code>/cdi/divergence.csv</code>`;
    try{
      const r = await fetch('./divergence.csv',{cache:'no-store'});
      const t = await r.text();
      const rows = t.trim().split(/\r?\n/).map(r=>r.split(','));
      const head = rows[0]; const body = rows.slice(1);
      let aSum=0, n=0;
      tbody.innerHTML = "";
      for(const r of body){
        const a = Number(r[1]); const d = Number(r[2]);
        if(isFinite(a)){ aSum+=a; n++; }
        const tr = document.createElement('tr');
        ["0","3","1","2","4","5"].forEach(idx=>{
          const td = document.createElement('td');
          td.textContent = r[Number(idx)]||"";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      const avg = aSum/Math.max(1,n);
      document.getElementById('k-align').textContent = fmt(avg);
      document.getElementById('k-div').textContent   = fmt(Math.max(0,1-avg));
      document.getElementById('t-align').textContent = fmt(avg);
      document.getElementById('t-div').textContent   = fmt(Math.max(0,1-avg));
      document.getElementById('stamp').textContent = "Generated: " + now();
    }catch(_){
      document.getElementById('srcMsg').innerHTML = "No CAE model and no divergence.csv found.";
    }
  }

  render();
})();
</script>
</body>
</html>
