<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CDI — Constitutional Divergence Index</title>
  <style>
    :root{
      --bg:#0b0d12;--panel:#141820;--panel2:#0f131a;
      --ink:#e6e6e6;--muted:#9fb3c8;--line:rgba(255,255,255,.08);
      --brand:#5ddfff;--warn:#ffa559;--ok:#4bd28f
    }
    body{background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;line-height:1.6}
    a{color:#80bfff;text-decoration:none} a:hover{text-decoration:underline}
    header{background:linear-gradient(90deg,#11151c,#1b1e25);border-bottom:1px solid var(--line);padding:22px 18px;text-align:center}
    h1{margin:.1rem 0 .2rem;color:#5ddfff}
    .sub{color:var(--muted)}
    .wrap{max-width:1050px;margin:0 auto;padding:22px 18px}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px 0}
    .tile{background:var(--panel2);border:1px solid var(--line);border-radius:10px;padding:14px}
    .num{font:800 22px/1 system-ui}
    small{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:10px 12px;text-align:left}
    th{background:var(--panel2)}
    .good{color:var(--ok)} .bad{color:var(--warn)}
    footer{margin:36px 0 20px;color:var(--muted);text-align:center;font-size:.9rem}
    .badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <a href="/abe---flag/" class="badge">← Home</a>
    <h1>CDI — Constitutional Divergence Index</h1>
    <div class="sub">Auto-computed from CAE. Higher alignment → lower divergence. Self-correcting by design.</div>
  </div>
</header>

<main class="wrap">

  <!-- KPIs -->
  <div class="grid">
    <div class="tile">
      <div>Average Alignment (CAE)</div>
      <div id="k-align" class="num">—</div>
      <small>Mean of <code>clauses[*].alignment_score</code></small>
    </div>
    <div class="tile">
      <div>CDI (Divergence)</div>
      <div id="k-div" class="num">—</div>
      <small>CDI = 1 − alignment</small>
    </div>
    <div class="tile">
      <div>Realignment Δ (vs. last view)</div>
      <div id="k-delta" class="num">—</div>
      <small>Positive = healing; negative = drift</small>
    </div>
  </div>

  <!-- Sources panel -->
  <div class="card" id="sourcePanel">
    <h3 style="margin-top:0">Source</h3>
    <div id="srcMsg"><code>/cae/model.json</code> loaded.</div>
    <small>Fallback: <code>/cdi/divergence.csv</code> (if CAE model is missing)</small>
  </div>

  <!-- Breakdown table -->
  <div class="card">
    <h3 style="margin-top:0">Clause Breakdown</h3>
    <table aria-label="Clause breakdown">
      <thead>
        <tr>
          <th>Clause</th>
          <th>Title</th>
          <th>Alignment</th>
          <th>Divergence</th>
          <th>Confidence</th>
          <th>Tags</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr>
          <th colspan="2">Average</th>
          <th id="t-align">—</th>
          <th id="t-div">—</th>
          <th colspan="2"></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Export -->
  <div class="card">
    <h3 style="margin-top:0">Export</h3>
    <button id="btnCsv">Download Divergence CSV</button>
    <small id="stamp" style="margin-left:10px"></small>
  </div>

</main>

<footer>
  CC BY-NC 4.0 · DOI <a href="https://doi.org/10.5281/zenodo.17586107">10.5281/zenodo.17586107</a> · Integrity only — never for sale.
</footer>

<script>
(async function(){
  const fmt = n => (isFinite(n) ? n.toFixed(2) : "—");
  const now = () => new Date().toLocaleString();
  const tbody = document.getElementById('tbody');

  async function loadCAE(){
    try{
      // Try absolute then relative (works on Pages & local)
      const urls = ["/abe---flag/cae/model.json","./model.json","/cae/model.json"];
      for(const u of urls){
        const r = await fetch(u, {cache:"no-store"});
        if(r.ok){
          const j = await r.json();
          return {json:j, url:u};
        }
      }
    }catch(_){}
    return null;
  }

  function renderFromCAE(cae, url){
    const clauses = Array.isArray(cae.clauses) ? cae.clauses : [];
    if(!clauses.length) throw new Error("CAE model has no clauses array.");

    // alignment = mean of alignment_score
    const alignVals = clauses.map(c => Number(c.alignment_score)).filter(v => isFinite(v));
    const avgAlign = alignVals.reduce((a,b)=>a+b,0) / Math.max(alignVals.length,1);
    const div = Math.max(0, 1 - avgAlign);

    // Realignment delta (vs last view, localStorage only)
    const key = "cdi_prev_avg_align";
    const prev = Number(localStorage.getItem(key));
    localStorage.setItem(key, String(avgAlign));
    const delta = isFinite(prev) ? (avgAlign - prev) : 0;

    // KPIs
    document.getElementById('k-align').textContent = fmt(avgAlign);
    document.getElementById('k-div').textContent   = fmt(div);
    const dEl = document.getElementById('k-delta');
    dEl.textContent = (delta>=0? "+" : "") + fmt(delta);
    dEl.classList.add(delta>=0 ? "good" : "bad");

    // Table
    tbody.innerHTML = "";
    for(const c of clauses){
      const a = Number(c.alignment_score);
      const d = Math.max(0, 1 - a);
      const tr = document.createElement('tr');

      const td1 = document.createElement('td'); td1.textContent = c.clause_id || "";
      const td2 = document.createElement('td'); td2.textContent = c.title || "";
      const td3 = document.createElement('td'); td3.textContent = fmt(a);
      const td4 = document.createElement('td'); td4.textContent = fmt(d);
      const td5 = document.createElement('td'); td5.textContent = c.confidence!=null ? fmt(Number(c.confidence)) : "—";
      const td6 = document.createElement('td'); td6.textContent = Array.isArray(c.tags)? c.tags.join(", ") : "";

      tr.append(td1,td2,td3,td4,td5,td6);
      tbody.appendChild(tr);
    }

    // Footer avgs
    document.getElementById('t-align').textContent = fmt(avgAlign);
    document.getElementById('t-div').textContent   = fmt(div);

    // Source message
    document.getElementById('srcMsg').innerHTML = `Loaded <code>${url}</code> (${clauses.length} clauses)`;
    document.getElementById('stamp').textContent = "Generated: " + now();

    // CSV export
    document.getElementById('btnCsv').onclick = () => {
      const lines = [
        ["Generated", now()],
        ["Source", url],
        [],
        ["clause_id","title","alignment","divergence","confidence","tags"]
      ];
      for(const c of clauses){
        const a = Number(c.alignment_score);
        const d = Math.max(0, 1 - a);
        const row = [
          c.clause_id||"",
          c.title||"",
          isFinite(a)? a.toFixed(4) : "",
          isFinite(d)? d.toFixed(4) : "",
          c.confidence!=null? Number(c.confidence).toFixed(4) : "",
          Array.isArray(c.tags)? c.tags.join("|") : ""
        ];
        // escape for CSV (Excel formula injection guard)
        const safe = row.map(cell=>{
          const s = String(cell);
          return /^[=+\-@]/.test(s) ? "'"+s : s;
        });
        lines.push(safe);
      }
      const csv = lines.map(r=>r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const urlBlob = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = urlBlob; a.download = "cdi_divergence.csv"; a.click();
      URL.revokeObjectURL(urlBlob);
    };
  }

  async function render(){
    const cae = await loadCAE();
    if(cae){
      try{ renderFromCAE(cae.json, cae.url); return; }
      catch(e){ console.error(e); }
    }
    // Fallback to static CSV if CAE not available
    document.getElementById('srcMsg').innerHTML = `Falling back to <code>/cdi/divergence.csv</code>`;
    try{
      const r = await fetch('./divergence.csv',{cache:'no-store'});
      const t = await r.text();
      const rows = t.trim().split(/\r?\n/).map(r=>r.split(','));
      const head = rows[0]; const body = rows.slice(1);
      let aSum=0, n=0;
      tbody.innerHTML = "";
      for(const r of body){
        const a = Number(r[1]); const d = Number(r[2]);
        if(isFinite(a)){ aSum+=a; n++; }
        const tr = document.createElement('tr');
        ["0","3","1","2","4","5"].forEach(idx=>{
          const td = document.createElement('td');
          td.textContent = r[Number(idx)]||"";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      const avg = aSum/Math.max(1,n);
      document.getElementById('k-align').textContent = fmt(avg);
      document.getElementById('k-div').textContent   = fmt(Math.max(0,1-avg));
      document.getElementById('t-align').textContent = fmt(avg);
      document.getElementById('t-div').textContent   = fmt(Math.max(0,1-avg));
      document.getElementById('stamp').textContent = "Generated: " + now();
    }catch(_){
      document.getElementById('srcMsg').innerHTML = "No CAE model and no divergence.csv found.";
    }
  }

  render();
})();
</script>
</body>
</html>
